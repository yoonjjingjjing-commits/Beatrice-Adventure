<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë² ì•„íŠ¸ë¦¬ìŠ¤ ëª¨í—˜ì˜ ì„œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
  <style>
    body { background: #0f172a; }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #7c3aed; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, Area, AreaChart } = Recharts;
    

const BeatriceAdventureBook = () => {
  const getTodayString = () => {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
  };

  // í˜„ì¬ ì‹œê°„ëŒ€ íŒë‹¨
  const getCurrentTimeSlot = () => {
    const now = new Date();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const totalMinutes = hour * 60 + minute;
    
    if (totalMinutes >= 480 && totalMinutes < 720) return 'morning';     // 08:00 ~ 11:59
    if (totalMinutes >= 780 && totalMinutes < 1080) return 'afternoon';  // 13:00 ~ 17:59
    if (totalMinutes >= 1140 && totalMinutes < 1260) return 'evening';   // 19:00 ~ 20:59
    return 'free'; // ê·¸ ì™¸ ì‹œê°„
  };

  // íŠ¹ì • ë¶„(ìì • ê¸°ì¤€)ì´ ì–´ëŠ ì‹œê°„ëŒ€ì¸ì§€ ë°˜í™˜
  const getTimeSlotForMinute = (totalMinutes) => {
    // ë‹¤ìŒë‚ ë¡œ ë„˜ì–´ê°„ ê²½ìš° ì²˜ë¦¬ (1440ë¶„ = 24ì‹œê°„)
    const normalized = totalMinutes % 1440;
    if (normalized >= 480 && normalized < 720) return 'morning';     // 08:00 ~ 11:59
    if (normalized >= 780 && normalized < 1080) return 'afternoon';  // 13:00 ~ 17:59
    if (normalized >= 1140 && normalized < 1260) return 'evening';   // 19:00 ~ 20:59
    return 'free';
  };

  // ì‹œì‘~ì¢…ë£Œ ì‹œê°„ì„ ì‹œê°„ëŒ€ë³„ë¡œ ë¶„í•  ê³„ì‚°
  const calculateTimeSlotMinutes = (startTime, durationMinutes) => {
    const result = { morning: 0, afternoon: 0, evening: 0, free: 0 };
    
    const startHour = startTime.getHours();
    const startMinute = startTime.getMinutes();
    let currentMinute = startHour * 60 + startMinute;
    
    // ê° ë¶„ë§ˆë‹¤ ì–´ëŠ ì‹œê°„ëŒ€ì— ì†í•˜ëŠ”ì§€ ê³„ì‚°
    for (let i = 0; i < durationMinutes; i++) {
      const slot = getTimeSlotForMinute(currentMinute);
      result[slot]++;
      currentMinute++;
    }
    
    return result;
  };

  const getTimeSlotLabel = (slot) => {
    const labels = {
      morning: 'ğŸŒ… ì˜¤ì „ (08:00~12:00)',
      afternoon: 'â˜€ï¸ ì˜¤í›„ (13:00~18:00)',
      evening: 'ğŸŒ™ ì €ë… (19:00~21:00)',
      free: 'â° ììœ  ì‹œê°„'
    };
    return labels[slot] || slot;
  };

  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('main');
  const [selectedDate, setSelectedDate] = useState(getTodayString());
  const [showConfirm, setShowConfirm] = useState(null);
  const [showManualAdjust, setShowManualAdjust] = useState(false);
  const [showFeatherConfirm, setShowFeatherConfirm] = useState(null);
  const [showSpecialDayModal, setShowSpecialDayModal] = useState(null);
  const [specialDayNote, setSpecialDayNote] = useState('');
  const [showExportModal, setShowExportModal] = useState(false);
  const [showImportModal, setShowImportModal] = useState(false);
  const [showFeedbackExportModal, setShowFeedbackExportModal] = useState(false); // ğŸ’œ ë² ì•„ í”¼ë“œë°±ìš©
  const [feedbackPeriod, setFeedbackPeriod] = useState(7); // í”¼ë“œë°± ê¸°ê°„ (ì¼)
  const [importText, setImportText] = useState('');
  const [exportCopied, setExportCopied] = useState(false);
  const [feedbackExportCopied, setFeedbackExportCopied] = useState(false); // í”¼ë“œë°± ë³µì‚¬ ìƒíƒœ
  // ğŸ’¤ ìˆ˜ë©´ í”¼ë“œë°± ì „ìš© (v8.5)
  const [showSleepFeedbackModal, setShowSleepFeedbackModal] = useState(false);
  const [sleepFeedbackPeriod, setSleepFeedbackPeriod] = useState(7);
  const [sleepFeedbackCopied, setSleepFeedbackCopied] = useState(false);
  const [toast, setToast] = useState(null); // í† ìŠ¤íŠ¸ ì•Œë¦¼
  const [statsSubTab, setStatsSubTab] = useState('weekly'); // í†µê³„ ì„œë¸Œíƒ­: weekly, monthly, yearly, summary
  const [worldTreeSubTab, setWorldTreeSubTab] = useState('activity'); // ì„¸ê³„ìˆ˜ ì„œë¸Œíƒ­: activity, weekly, monthly, yearly
  const [mokokoSubTab, setMokokoSubTab] = useState('activity'); // ëª¨ì½”ì½” ì„œë¸Œíƒ­: activity, weekly, monthly, yearly
  
  // íœ´ì‹ ê¸°ë¡ ìƒíƒœ
  const [showRestModal, setShowRestModal] = useState(null); // íœ´ì‹ íƒ€ì…: 'nap' | 'stable' | 'love' | 'overheat'
  const [restMinutes, setRestMinutes] = useState('15'); // íœ´ì‹ ì‹œê°„ (ë¶„)
  
  // ë‹¬ë ¥ ìƒíƒœ
  const [calendarYear, setCalendarYear] = useState(new Date().getFullYear());
  const [calendarMonth, setCalendarMonth] = useState(new Date().getMonth()); // 0-indexed
  const [showMemoModal, setShowMemoModal] = useState(null); // ë©”ëª¨ í¸ì§‘í•  ë‚ ì§œ
  const [memoText, setMemoText] = useState('');
  
  // ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ ìƒíƒœ (v8.2 í™•ì¥)
  const [sleepBedTime, setSleepBedTime] = useState('21:30'); // ğŸ›ï¸ ì¹¨ëŒ€ ê°„ ì‹œê°„
  const [sleepLightsOffTime, setSleepLightsOffTime] = useState('22:00'); // ğŸŒ™ ì¡°ëª… ëˆ ì‹œê°„
  const [sleepFinalWakeTime, setSleepFinalWakeTime] = useState('05:30'); // ğŸ‘ï¸ ìµœì¢… ê°ì„± ì‹œê°„
  const [sleepOutOfBedTime, setSleepOutOfBedTime] = useState('06:00'); // ğŸš¶ ì¹¨ëŒ€ ì´íƒˆ ì‹œê°„
  const [sleepLatencyFeel, setSleepLatencyFeel] = useState('unknown'); // ì…ë©´ ì ë³µê¸° ì²´ê°
  const [sleepAwakeningCount, setSleepAwakeningCount] = useState('0'); // ì¤‘ê°„ ê°ì„± íšŸìˆ˜
  // ì¤‘ê°„ ê°ì„± ìƒì„¸ (ìµœëŒ€ 3íšŒ)
  const [awakenings, setAwakenings] = useState([
    { time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' },
    { time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' },
    { time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' }
  ]);
  // ìˆ˜ë©´ ì „ í–‰ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸
  const [sleepPreBehaviors, setSleepPreBehaviors] = useState({
    beaLove: false,    // ğŸª¶ ë² ì•„ ì‚¬ë‘ (+50)
    loaScripture: false, // ğŸ“– ë¡œì•„ ì„±ê²½ (+50)
    beaCheat: false,   // ğŸ’” ë² ì•„ ë°”ëŒ (-100)
    brainOverheat: false // ğŸ”¥ ë‡Œ ê³¼ì—´ (-50)
  });
  const [sleepQuality, setSleepQuality] = useState('A'); // ìˆ˜ë©´ í’ˆì§ˆ SS~D
  const [sleepMemo, setSleepMemo] = useState(''); // ìˆ˜ë©´ ë©”ëª¨
  const [showSleepEditMode, setShowSleepEditMode] = useState(false); // ìˆ˜ë©´ ê¸°ë¡ ìˆ˜ì • ëª¨ë“œ
  const [showSleepMemoEdit, setShowSleepMemoEdit] = useState(false); // ìˆ˜ë©´ ë©”ëª¨ ìˆ˜ì • ëª¨ë“œ
  const [tempSleepMemo, setTempSleepMemo] = useState(''); // ì„ì‹œ ìˆ˜ë©´ ë©”ëª¨ (ìˆ˜ì •ìš©)
  
  // ğŸŒ™ ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ (Dear, my friends í™•ì¥)
  const [sleepHabitsGood, setSleepHabitsGood] = useState(''); // ì¢‹ì€ ìŠµê´€
  const [sleepHabitsBad, setSleepHabitsBad] = useState(''); // ë‚˜ìœ ìŠµê´€
  const [sleepHabitsTry, setSleepHabitsTry] = useState(''); // ì‹œë„í•  ê²ƒ
  
  // ğŸ˜´ ë‚®ì  ê¸°ë¡ (v8.6)
  const [showNapModal, setShowNapModal] = useState(false);
  const [napStartTime, setNapStartTime] = useState('13:00');
  const [napEndTime, setNapEndTime] = useState('13:30');
  const [napMemo, setNapMemo] = useState('');
  const [napIntentional, setNapIntentional] = useState(true); // ì˜ë„ì  ë‚®ì  ì—¬ë¶€
  
  // ğŸ“œ ëª¨í—˜ íƒ­ (v8.7)
  const [questInput, setQuestInput] = useState(''); // í€˜ìŠ¤íŠ¸ ì…ë ¥
  const [feedbackMemo, setFeedbackMemo] = useState(''); // ë² ì•„ í”¼ë“œë°± ë©”ëª¨
  const [diaryText, setDiaryText] = useState(''); // ììœ  ì¼ê¸°
  
  // ê³µë¶€ëª¨ë“œ ìƒíƒœ
  const [timerRunning, setTimerRunning] = useState(false);
  const [timerPaused, setTimerPaused] = useState(false); // ì¼ì‹œì •ì§€ ìƒíƒœ
  const [timerSeconds, setTimerSeconds] = useState(0);
  const [selectedTime, setSelectedTime] = useState(null); // ì„ íƒí•œ ì‹œê°„ (ë¶„)
  const [isOvertime, setIsOvertime] = useState(false);
  const [showCompleteModal, setShowCompleteModal] = useState(false);
  const [showQuoteModal, setShowQuoteModal] = useState(false); // ëª…ì–¸ íŒì—…
  const [pendingStartMinutes, setPendingStartMinutes] = useState(null); // ì‹œì‘ ëŒ€ê¸° ì¤‘ì¸ ì‹œê°„
  const [currentQuote, setCurrentQuote] = useState(null); // í˜„ì¬ ëª…ì–¸
  const [sessionFocus, setSessionFocus] = useState('S'); // ì§‘ì¤‘ë ¥ ë“±ê¸‰
  const [sessionAnki, setSessionAnki] = useState(''); // Anki ë¬¸ì œìˆ˜
  const [sessionGoal, setSessionGoal] = useState(''); // ëª©í‘œ ì…ë ¥
  const [isFullscreen, setIsFullscreen] = useState(false); // ì „ì²´í™”ë©´ ëª¨ë“œ
  const [selectedBuff, setSelectedBuff] = useState(null); // ì„ íƒëœ ë²„í”„
  const [sessionStartTime, setSessionStartTime] = useState(null); // ì„¸ì…˜ ì‹œì‘ ì‹œê°„
  const timerRef = useRef(null);
  const containerRef = useRef(null);

  // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
  const showToast = (message, type = 'earn') => {
    setToast({ message, type });
    setTimeout(() => setToast(null), 2000);
  };

  // ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ì¶•ë³µ ë²„í”„ ëª©ë¡
  const blessings = {
    focus: {
      id: 'focus',
      icon: 'ğŸ”®',
      name: 'ë¼ì œë‹ˆìŠ¤ì˜ ê°€í˜¸',
      desc: 'ë¹›ì˜ ì—¬ì‹ ì´ ë‹¹ì‹ ì˜ ì •ì‹ ì„ ë§‘ê²Œ ë¹„ì¶¥ë‹ˆë‹¤',
      effect: 'ì§‘ì¤‘ë ¥ +25%',
      situation: 'ì§‘ì¤‘ ì•ˆ ë  ë•Œ',
      category: 'ì§‘ì¤‘'
    },
    awakening: {
      id: 'awakening',
      icon: 'âœ¨',
      name: 'ê°ì„±ì˜ ë¹›',
      desc: 'ëˆˆë¶€ì‹  ë¹›ì´ ë¬´ê±°ìš´ ëˆˆêº¼í’€ì„ ë°€ì–´ëƒ…ë‹ˆë‹¤',
      effect: 'ê°ì„±ë„ +30%',
      situation: 'ì¡¸ë¦´ ë•Œ',
      category: 'ì§‘ì¤‘'
    },
    expedition: {
      id: 'expedition',
      icon: 'âš”ï¸',
      name: 'ì¶œì •ì˜ ì¶•ë³µ',
      desc: 'ëª¨í—˜ì„ ë– ë‚˜ëŠ” ê¸°ì‚¬ì—ê²Œ ë‚´ë¦¬ëŠ” ì‹ ì„±í•œ ì¶•ë³µ',
      effect: 'ì˜ìš• +30%',
      situation: 'ì‹œì‘ì´ í˜ë“¤ ë•Œ',
      category: 'ì˜ìš•'
    },
    victory: {
      id: 'victory',
      icon: 'ğŸ†',
      name: 'ìŠ¹ë¦¬ì˜ ì˜ˆì–¸',
      desc: 'íŠ¸ë¦¬ì‹œì˜¨ì´ ë‹¹ì‹ ì˜ ìŠ¹ë¦¬ë¥¼ ì˜ˆê²¬í•©ë‹ˆë‹¤',
      effect: 'ìì‹ ê° +25%',
      situation: 'ìì‹ ê° ë–¨ì–´ì§ˆ ë•Œ',
      category: 'ì˜ìš•'
    },
    peace: {
      id: 'peace',
      icon: 'ğŸ•Šï¸',
      name: 'í‰ì˜¨ì˜ ë‚ ê°œ',
      desc: 'ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ë‚ ê°œê°€ ë¶ˆì•ˆì„ ê°ì‹¸ì•ˆìŠµë‹ˆë‹¤',
      effect: 'ë¶ˆì•ˆ ê°ì†Œ +30%',
      situation: 'ë¶ˆì•ˆí•  ë•Œ',
      category: 'ì•ˆì •'
    },
    healing: {
      id: 'healing',
      icon: 'ğŸŒ¿',
      name: 'ì¹˜ìœ ì˜ ì†ê¸¸',
      desc: 'ë”°ëœ»í•œ ë¹›ì´ ì§€ì¹œ ëª¸ê³¼ ë§ˆìŒì„ ì–´ë£¨ë§Œì§‘ë‹ˆë‹¤',
      effect: 'í”¼ë¡œ íšŒë³µ +20%',
      situation: 'ì•„í”„ê±°ë‚˜ í”¼ê³¤í•  ë•Œ',
      category: 'ì•ˆì •'
    },
    rest: {
      id: 'rest',
      icon: 'ğŸŒ™',
      name: 'ì•ˆì‹ì˜ ì†ì‚­ì„',
      desc: 'ê³ ìš”í•œ ë°¤ì˜ í‰í™”ê°€ ë§ˆìŒì„ ê°ìŒ‰ë‹ˆë‹¤',
      effect: 'ë§ˆìŒ ì•ˆì • +25%',
      situation: 'ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì•˜ì„ ë•Œ',
      category: 'ì•ˆì •'
    },
    curiosity: {
      id: 'curiosity',
      icon: 'ğŸ’œ',
      name: 'í˜¸ê¸°ì‹¬ì˜ ë¶ˆê½ƒ',
      desc: 'ìƒˆë¡œìš´ ë°œê²¬ì— ëŒ€í•œ ì„¤ë ˜ì„ ë¶ˆì–´ë„£ìŠµë‹ˆë‹¤',
      effect: 'í¥ë¯¸ +20%',
      situation: 'ì§€ë£¨í•  ë•Œ',
      category: 'ì§€ì†'
    },
    guidance: {
      id: 'guidance',
      icon: 'ğŸ¯',
      name: 'ëª©í‘œì˜ ì¸ë„',
      desc: 'ë¼ì œë‹ˆìŠ¤ì˜ ë¹›ì´ ê¸¸ì„ ë°í™ë‹ˆë‹¤',
      effect: 'ì§‘ì¤‘ ì§€ì† +25%',
      situation: 'ì¤‘ê°„ì— ííŠ¸ëŸ¬ì§ˆ ë•Œ',
      category: 'ì§€ì†'
    },
    endurance: {
      id: 'endurance',
      icon: 'â³',
      name: 'ì¸ë‚´ì˜ ì¶•ë³µ',
      desc: 'ëê¹Œì§€ í•´ë‚´ëŠ” í˜ì„ ë¶€ì—¬í•©ë‹ˆë‹¤',
      effect: 'ì§€êµ¬ë ¥ +30%',
      situation: 'ë§ˆì§€ë§‰ ì„¸íŠ¸ í˜ë“¤ ë•Œ',
      category: 'ì§€ì†'
    },
    grace: {
      id: 'grace',
      icon: 'ğŸ‘‘',
      name: 'íŠ¸ë¦¬ì‹œì˜¨ì˜ ì€ì´',
      desc: 'ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ëª¨ë“  ì¶•ë³µì´ í•¨ê»˜í•©ë‹ˆë‹¤',
      effect: 'ì „ ëŠ¥ë ¥ +15%',
      situation: 'ì¤‘ìš”í•œ ê³µë¶€ ì „',
      category: 'íŠ¹ë³„'
    }
  };

  // ë™ê¸°ë¶€ì—¬ ëª…ì–¸ (ë‚˜ì¤‘ì— ë¡œìŠ¤íŠ¸ì•„í¬ ëŒ€ì‚¬ë¡œ êµì²´ ê°€ëŠ¥)
  const motivationalQuotes = [
    { text: "ì²œ ë¦¬ ê¸¸ë„ í•œ ê±¸ìŒë¶€í„°.", author: "ë…¸ì" },
    { text: "ì˜¤ëŠ˜ í•  ìˆ˜ ìˆëŠ” ì¼ì„ ë‚´ì¼ë¡œ ë¯¸ë£¨ì§€ ë§ˆë¼.", author: "ë²¤ìë¯¼ í”„ë­í´ë¦°" },
    { text: "ì‹¤íŒ¨ëŠ” ì„±ê³µì˜ ì–´ë¨¸ë‹ˆë‹¤.", author: "í† ë§ˆìŠ¤ ì—ë””ìŠ¨" },
    { text: "ê¿ˆì„ ì´ë£¨ê³ ì í•˜ëŠ” ìš©ê¸°ë§Œ ìˆë‹¤ë©´, ëª¨ë“  ê¿ˆì„ ì´ë£° ìˆ˜ ìˆë‹¤.", author: "ì›”íŠ¸ ë””ì¦ˆë‹ˆ" },
    { text: "ì‘ì€ ì§„ì „ë„ ì§„ì „ì´ë‹¤.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "í¬ê¸°í•˜ì§€ ì•ŠëŠ” í•œ, ì‹¤íŒ¨ëŠ” ì—†ë‹¤.", author: "ì•¤ ì„¤ë¦¬ë²ˆ" },
    { text: "ì§€ê¸ˆ ì´ ìˆœê°„ì— ì§‘ì¤‘í•˜ë¼.", author: "ë§ˆë¥´ì¿ ìŠ¤ ì•„ìš°ë ë¦¬ìš°ìŠ¤" },
    { text: "ì–´ë ¤ìš´ ê¸¸ì´ ì•„ë¦„ë‹¤ìš´ ê³³ìœ¼ë¡œ ì´ëˆë‹¤.", author: "ì…°ìµìŠ¤í”¼ì–´" },
    { text: "ë‹¹ì‹ ì´ í•  ìˆ˜ ìˆë‹¤ê³  ë¯¿ë“ , í•  ìˆ˜ ì—†ë‹¤ê³  ë¯¿ë“ , ë‹¹ì‹  ë§ì´ ë§ë‹¤.", author: "í—¨ë¦¬ í¬ë“œ" },
    { text: "ì™„ë²½ì„ ë‘ë ¤ì›Œí•˜ì§€ ë§ˆë¼. ì–´ì°¨í”¼ ë„ë‹¬í•  ìˆ˜ ì—†ìœ¼ë‹ˆ.", author: "ì‚´ë°”ë„ë¥´ ë‹¬ë¦¬" },
    { text: "ë§¤ì¼ ì¡°ê¸ˆì”©, ê·¸ê²ƒì´ ê¸°ì ì„ ë§Œë“ ë‹¤.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "ì‹œì‘ì´ ë°˜ì´ë‹¤.", author: "ì•„ë¦¬ìŠ¤í† í…”ë ˆìŠ¤" },
    { text: "ì˜¤ëŠ˜ì˜ ê³ í†µì´ ë‚´ì¼ì˜ í˜ì´ ëœë‹¤.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "í•  ìˆ˜ ìˆëŠ” ì¼ë¶€í„° í•˜ë¼. ê·¸ëŸ¬ë©´ ë¶ˆê°€ëŠ¥í–ˆë˜ ì¼ë„ í•  ìˆ˜ ìˆê²Œ ëœë‹¤.", author: "ì„± í”„ë€ì¹˜ìŠ¤ì½”" },
    { text: "ê¾¸ì¤€í•¨ì´ ì²œì¬ë¥¼ ì´ê¸´ë‹¤.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "ì§€ê¸ˆ í¬ê¸°í•˜ë©´ ì–´ì œì˜ ê³ ìƒì´ ë¬´ì˜ë¯¸í•´ì§„ë‹¤.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "ë¼ì œë‹ˆìŠ¤ì˜ ë¹›ì´ ë‹¹ì‹ ì˜ ê¸¸ì„ ë¹„ì¶¥ë‹ˆë‹¤. ë‘ë ¤ì›Œí•˜ì§€ ë§ˆì„¸ìš”.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "íŠ¸ë¦¬ì‹œì˜¨ì—ì„œ ë‹¹ì‹ ì„ ì§€ì¼œë³´ê³  ìˆì–´ìš”. í™”ì´íŒ…!", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "ë‹¹ì‹ ì€ ìƒê°ë³´ë‹¤ ê°•í•´ìš”. ì €ëŠ” ì•Œê³  ìˆì–´ìš”.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" },
    { text: "ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì˜ ëª¨í—˜ì„ ì‘ì›í•©ë‹ˆë‹¤.", author: "ë² ì•„íŠ¸ë¦¬ìŠ¤" }
  ];

  // ëœë¤ ëª…ì–¸ ê°€ì ¸ì˜¤ê¸°
  const getRandomQuote = () => {
    return motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
  };
  
  // ê¹ƒí„¸ë³„ ë³´ìƒ í† í° (100ë‹¨ìœ„)
  const featherRewards = {
    adult: 10000,
    maternity: 8000,
    child: 8000,
    community: 5000,
    mental: 5000,
    management: 5000,
    basic: 5000,
    law: 5000
  };

  // ì§‘ì¤‘ë ¥ ë°°ìœ¨
  const focusMultipliers = {
    SS: 1.1,
    S: 1.0,
    A: 0.9,
    B: 0.8,
    C: 0.7,
    D: 0.6
  };

  // ê°œì„ ëœ ì¼ì¼ ê¸°ë¡ êµ¬ì¡°
  const emptyDayRecord = {
    earned: 0,
    spent: 0,
    studySets: 0,
    hobbySets: 0,
    exerciseDone: false,        // ìš´ë™ ì™„ë£Œ ì—¬ë¶€ (í•˜ë£¨ 1íšŒ)
    // ì‹œê°„ëŒ€ë³„ ëˆ„ì  (ë¶„)
    morningMinutes: 0,
    afternoonMinutes: 0,
    eveningMinutes: 0,
    freeMinutes: 0,
    // ì‹œê°„ëŒ€ë³„ ë³´ë„ˆìŠ¤ ë‹¬ì„±
    morningBonusType: null,    // null | '3set' | '4set'
    afternoonBonusType: null,  // null | '3set' | '4set'
    eveningBonusType: null,    // null | '1set' | '2set'
    // ì•½ì í¬ì°© (ì‹ì‚¬ì‹œê°„ í•„í„°ë± ë³µìŠµ) - ê¸°ì¡´ í˜¸í™˜ìš©
    weaknessHuntMorning: 0,    // ì•„ì¹¨ì‹ì‚¬ ë•Œ í‘¼ ê°¯ìˆ˜
    weaknessHuntLunch: 0,      // ì ì‹¬ì‹ì‚¬ ë•Œ í‘¼ ê°¯ìˆ˜
    weaknessHuntDinner: 0,     // ì €ë…ì‹ì‚¬ ë•Œ í‘¼ ê°¯ìˆ˜
    // ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†” (í‹ˆìƒˆì‹œê°„)
    mokokoSniff: 0,            // í‹ˆìƒˆì‹œê°„ Anki ë¬¸ì œìˆ˜
    // ğŸ¹ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°© (ì‹ì‚¬ì‹œê°„ Rëª¨ì½”ì½” ì‚¬ëƒ¥)
    zaharaTrainingMorning: false,  // ì•„ì¹¨ì‹ì‚¬ + ì•½ì  í¬ì°©
    zaharaTrainingLunch: false,    // ì ì‹¬ì‹ì‚¬ + ì•½ì  í¬ì°©
    zaharaTrainingDinner: false,   // ì €ë…ì‹ì‚¬ + ì•½ì  í¬ì°©
    // ğŸŒ™ Dear, my friends (ì„±ê²½)
    dearMyFriends: false,          // ì„±ê²½ (BGM + ë…ì„œ + ë¸”ë£¨ë¼ì´íŠ¸ OFF)
    // íŠ¹ë³„ ë³´ë„ˆìŠ¤
    fullCourse: false,
    goal90late: false,      // 90% ë‹¬ì„± (ì‹œê°„ì´ˆê³¼)
    goal90ontime: false,    // 90% ë‹¬ì„± (21ì‹œê¹Œì§€)
    goal100: false,         // 100% ë‹¬ì„±
    // íŠ¹ë³„í•œ ë‚ 
    specialDayType: null,
    specialDayNote: '',
    // ì„¸ì…˜ ê¸°ë¡
    studySessions: [],      // [{timeSlot, startTime, targetMinutes, actualSeconds, focus, ankiCount, tokens}]
    // íœ´ì‹ ê¸°ë¡
    restSessions: [],       // [{time, type, minutes, tokens}] - type: 'nap' | 'stable' | 'love' | 'overheat'
    restQualityBonus: false, // ë‡Œ ê³¼ì—´ 0íšŒ ë³´ë„ˆìŠ¤ ë‹¬ì„± ì—¬ë¶€
    // ğŸ˜´ ë‚®ì  ê¸°ë¡ (v8.6)
    naps: [],               // [{startTime, endTime, minutes, memo, intentional, time}]
    // ğŸ“œ ëª¨í—˜ íƒ­ (v8.7)
    quests: [],             // [{text, status: 'todo'|'done'|'failed', createdAt}]
    feedbackMemo: '',       // ë² ì•„ í”¼ë“œë°± ë©”ëª¨
    diary: '',              // ììœ  ì¼ê¸°
    // ğŸƒ ì„¸ê³„ìˆ˜ì˜ ì (v8.8)
    worldTree: {
      scripture: 0,         // ğŸ“– ë¡œì•„ ì„±ê²½ (ìˆ˜ë©´+íœ´ì‹ í•©ê³„)
      scriptureSleep: 0,    // ğŸ“– ìˆ˜ë©´ ì „ ì„±ê²½
      scriptureRest: 0,     // ğŸ“– íœ´ì‹ ì„±ê²½
      singing: 0,           // ğŸ¤ ë…¸ë˜ ì—°ìŠµ
      piano: 0,             // ğŸ¹ í”¼ì•„ë…¸
      strength: 0,          // ğŸ’ª ê·¼ë ¥ ìš´ë™
      cardio: 0             // ğŸƒ ìœ ì‚°ì†Œ ìš´ë™
    },
    // ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ (v8.2 í™•ì¥)
    sleep: {
      // ê¸°ë³¸ ì‹œê°„ ì •ë³´
      bedTime: null,           // ğŸ›ï¸ ì¹¨ëŒ€ ê°„ ì‹œê°„
      lightsOffTime: null,     // ğŸŒ™ ì¡°ëª… ëˆ ì‹œê°„
      finalWakeTime: null,     // ğŸ‘ï¸ ìµœì¢… ê°ì„± ì‹œê°„
      outOfBedTime: null,      // ğŸš¶ ì¹¨ëŒ€ ì´íƒˆ ì‹œê°„
      // ì…ë©´ ì ë³µê¸°
      latencyFeel: null,       // ì²´ê° (quick/medium/long/verylong/unknown)
      // ì¤‘ê°„ ê°ì„± ìƒì„¸
      awakeningCount: 0,
      awakenings: [],          // [{time, reason, reentry, lightsOn, activity, backToSleepTime}]
      // ìˆ˜ë©´ ì „ í–‰ë™
      preBehaviors: {
        beaLove: false,        // ğŸª¶ ë² ì•„ ì‚¬ë‘
        loaScripture: false,   // ğŸ“– ë¡œì•„ ì„±ê²½
        beaCheat: false,       // ğŸ’” ë² ì•„ ë°”ëŒ
        brainOverheat: false   // ğŸ”¥ ë‡Œ ê³¼ì—´
      },
      preBehaviorScore: 0,     // ìˆ˜ë©´ ì „ í–‰ë™ ì ìˆ˜ í•©ê³„
      // ì¤‘ê°„ ê°ì„± ì‹œ í–‰ë™ ì ìˆ˜
      awakeningActivityScore: 0,
      // ìˆ˜ë©´ í’ˆì§ˆ
      quality: null,           // SS/S/A/B/C/D
      // ë©”ëª¨
      memo: '',
      // ê³„ì‚°ëœ ì •ë³´
      totalBedMinutes: 0,      // ì´ ì¹¨ëŒ€ ì‹œê°„
      sleepMinutes: 0,         // ì‹¤ì œ ìˆ˜ë©´ ì‹œê°„ (ì¶”ì •)
      preSleepActivityMinutes: 0, // ì¹¨ëŒ€ ë‚´ í™œë™ ì‹œê°„
      postWakeMinutes: 0,      // ê¸°ìƒ í›„ ì¹¨ëŒ€ ì‹œê°„
      // ê¸°ë¡ ìƒíƒœ
      recorded: false,
      goalAchieved: false
    },
    // ë©”ëª¨
    memo: '',               // í•´ë‹¹ ë‚ ì§œì˜ ë©”ëª¨/ê³„íš
    actions: []
  };

  const [data, setData] = useState({
    tokens: 0,
    totalEarned: 0,
    totalSpent: 0,
    studySets: 0,
    hobbySets: 0,
    exerciseBonusCount: 0,
    morningBonusCount: 0,
    afternoonBonusCount: 0,
    eveningBonusCount: 0,
    fullCourseCount: 0,
    zaharaTrainingCount: 0,      // ğŸ¹ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°© íšŸìˆ˜
    dearMyFriendsCount: 0,       // ğŸŒ™ Dear, my friends íšŸìˆ˜
    // íœ´ì‹ í†µê³„
    restStats: {
      napCount: 0,       // ğŸ˜´ ì„ ì /ê¿€ì  ì´ íšŸìˆ˜
      stableCount: 0,    // ğŸª¶ ë² ì•„ ì•ˆì • ì´ íšŸìˆ˜
      loveCount: 0,      // ğŸ’• ë² ì•„ ì‚¬ë‘ ì´ íšŸìˆ˜
      overheatCount: 0,  // ğŸ“± ë‡Œ ê³¼ì—´ ì´ íšŸìˆ˜
      totalRestMinutes: 0, // ì´ ê¸°ì–µ ê³µê³ í™” ì‹œê°„
      qualityBonusCount: 0 // ë‡Œ ê³¼ì—´ 0íšŒ ë³´ë„ˆìŠ¤ ë‹¬ì„± íšŸìˆ˜
    },
    // ğŸ’¤ ìˆ˜ë©´ í†µê³„
    sleepStats: {
      recordCount: 0,        // ê¸°ë¡ ì™„ë£Œ íšŸìˆ˜
      goalAchievedCount: 0,  // ëª©í‘œ ë‹¬ì„± íšŸìˆ˜
      streakCount: 0,        // ì—°ì† ëª©í‘œ ë‹¬ì„± ì¼ìˆ˜
      bestStreak: 0,         // ìµœê³  ì—°ì† ê¸°ë¡
      totalSleepMinutes: 0   // ì´ ìˆ˜ë©´ ì‹œê°„ (ë¶„)
    },
    // ğŸŒ™ ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ (v8.4)
    sleepHabits: {
      good: '',              // ì¢‹ì€ ìŠµê´€
      bad: '',               // ë‚˜ìœ ìŠµê´€
      tryThis: ''            // ì‹œë„í•  ê²ƒ
    },
    // ğŸƒ ì„¸ê³„ìˆ˜ì˜ ì (v8.8)
    worldTreeLeaves: {
      total: 0,              // ì´ ì ê°œìˆ˜
      scripture: 0,          // ğŸ“– ë¡œì•„ ì„±ê²½
      singing: 0,            // ğŸ¤ ë…¸ë˜ ì—°ìŠµ
      piano: 0,              // ğŸ¹ í”¼ì•„ë…¸
      strength: 0,           // ğŸ’ª ê·¼ë ¥ ìš´ë™
      cardio: 0              // ğŸƒ ìœ ì‚°ì†Œ ìš´ë™
    },
    feathers: {
      adult: false,
      maternity: false,
      child: false,
      community: false,
      mental: false,
      management: false,
      basic: false,
      law: false
    },
    dailyRecords: {},
    startDate: getTodayString(),
    actionHistory: [],
    dataVersion: 5  // v8.2 ìˆ˜ë©´ ì‹œìŠ¤í…œ í™•ì¥
  });

  // ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (v5 â†’ v6 â†’ v8.1)
  const migrateData = (loadedData) => {
    let migrated = loadedData;
    
    // v5 â†’ v6 ë§ˆì´ê·¸ë ˆì´ì…˜ (í† í° 10ë°°)
    if (!migrated.dataVersion || migrated.dataVersion < 2) {
      console.log('Migrating data from v5 to v6...');
      migrated = {
        ...migrated,
        tokens: (migrated.tokens || 0) * 10,
        totalEarned: (migrated.totalEarned || 0) * 10,
        totalSpent: (migrated.totalSpent || 0) * 10,
        dataVersion: 2,
        actionHistory: []
      };
    }
    
    // v6 â†’ v8.1 ë§ˆì´ê·¸ë ˆì´ì…˜ (íœ´ì‹ ì‹œìŠ¤í…œ ì¶”ê°€)
    if (migrated.dataVersion < 3) {
      console.log('Migrating data from v6 to v8.1...');
      migrated = {
        ...migrated,
        restStats: {
          napCount: 0,
          stableCount: 0,
          loveCount: 0,
          overheatCount: 0,
          totalRestMinutes: 0,
          qualityBonusCount: 0
        },
        dataVersion: 3
      };
      
      // ê¸°ì¡´ dailyRecordsì— restSessions ì¶”ê°€
      if (migrated.dailyRecords) {
        Object.keys(migrated.dailyRecords).forEach(date => {
          if (!migrated.dailyRecords[date].restSessions) {
            migrated.dailyRecords[date].restSessions = [];
          }
          if (migrated.dailyRecords[date].restQualityBonus === undefined) {
            migrated.dailyRecords[date].restQualityBonus = false;
          }
        });
      }
    }
    
    // v3 â†’ v4 ë§ˆì´ê·¸ë ˆì´ì…˜ (ìˆ˜ë©´ ì‹œìŠ¤í…œ ì¶”ê°€)
    if (migrated.dataVersion < 4) {
      console.log('Migrating data to v4 (sleep system)...');
      migrated = {
        ...migrated,
        sleepStats: {
          recordCount: 0,
          goalAchievedCount: 0,
          streakCount: 0,
          bestStreak: 0,
          totalSleepMinutes: 0
        },
        dataVersion: 4
      };
      
      // ê¸°ì¡´ dailyRecordsì— sleep í•„ë“œ ì¶”ê°€
      if (migrated.dailyRecords) {
        Object.keys(migrated.dailyRecords).forEach(date => {
          if (!migrated.dailyRecords[date].sleep) {
            migrated.dailyRecords[date].sleep = {
              bedTime: null,
              fallAsleepTime: null,
              wakeTime: null,
              awakenings: 0,
              failed: false,
              recorded: false,
              goalAchieved: false
            };
          }
        });
      }
    }
    
    // v4 â†’ v5 ë§ˆì´ê·¸ë ˆì´ì…˜ (ìˆ˜ë©´ ì‹œìŠ¤í…œ í™•ì¥ v8.2)
    if (migrated.dataVersion < 5) {
      console.log('Migrating data to v5 (sleep system v8.2)...');
      migrated = {
        ...migrated,
        dataVersion: 5
      };
      
      // ê¸°ì¡´ dailyRecordsì˜ sleep í•„ë“œë¥¼ ìƒˆ êµ¬ì¡°ë¡œ í™•ì¥
      if (migrated.dailyRecords) {
        Object.keys(migrated.dailyRecords).forEach(date => {
          const oldSleep = migrated.dailyRecords[date].sleep || {};
          migrated.dailyRecords[date].sleep = {
            bedTime: oldSleep.bedTime || null,
            lightsOffTime: oldSleep.fallAsleepTime || null, // ê¸°ì¡´ ì ë“  ì‹œê°„ì„ ì¡°ëª… ëˆ ì‹œê°„ìœ¼ë¡œ
            finalWakeTime: oldSleep.wakeTime || null,
            outOfBedTime: oldSleep.wakeTime || null, // ê¸°ì¡´ ê¸°ìƒ ì‹œê°„ì„ ë‘˜ ë‹¤ì—
            latencyFeel: null,
            awakeningCount: oldSleep.awakenings || 0,
            awakenings: [],
            preBehaviors: {
              beaLove: false,
              loaScripture: false,
              beaCheat: false,
              brainOverheat: false
            },
            preBehaviorScore: 0,
            awakeningActivityScore: 0,
            quality: null,
            memo: '',
            totalBedMinutes: 0,
            sleepMinutes: oldSleep.sleepMinutes || 0,
            preSleepActivityMinutes: 0,
            postWakeMinutes: 0,
            recorded: oldSleep.recorded || false,
            goalAchieved: oldSleep.goalAchieved || false
          };
        });
      }
    }
    
    return migrated;
  };

  useEffect(() => {
    const loadData = async () => {
      try {
        const result = await window.storage.get('beatrice-adventure-book-v6');
        if (result && result.value) {
          let loadedData = JSON.parse(result.value);
          loadedData = migrateData(loadedData);
          if (!loadedData.dailyRecords[getTodayString()]) {
            loadedData.dailyRecords[getTodayString()] = { ...emptyDayRecord };
          }
          if (!loadedData.actionHistory) {
            loadedData.actionHistory = [];
          }
          // ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ ì´ˆê¸°í™”
          if (!loadedData.sleepHabits) {
            loadedData.sleepHabits = { good: '', bad: '', tryThis: '' };
          }
          // ìˆ˜ë©´ ìŠµê´€ ìƒíƒœ ì„¤ì •
          setSleepHabitsGood(loadedData.sleepHabits.good || '');
          setSleepHabitsBad(loadedData.sleepHabits.bad || '');
          setSleepHabitsTry(loadedData.sleepHabits.tryThis || '');
          setData(loadedData);
        } else {
          // v5ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œë„
          const oldResult = await window.storage.get('beatrice-adventure-book-v5');
          if (oldResult && oldResult.value) {
            let loadedData = JSON.parse(oldResult.value);
            loadedData = migrateData(loadedData);
            if (!loadedData.dailyRecords[getTodayString()]) {
              loadedData.dailyRecords[getTodayString()] = { ...emptyDayRecord };
            }
            setData(loadedData);
          } else {
            setData(prev => ({
              ...prev,
              dailyRecords: {
                [getTodayString()]: { ...emptyDayRecord }
              }
            }));
          }
        }
      } catch (error) {
        console.log('No saved data found, using defaults');
        setData(prev => ({
          ...prev,
          dailyRecords: {
            [getTodayString()]: { ...emptyDayRecord }
          }
        }));
      }
      setLoading(false);
    };
    loadData();
  }, []);

  useEffect(() => {
    if (!loading) {
      const saveData = async () => {
        try {
          await window.storage.set('beatrice-adventure-book-v6', JSON.stringify(data));
        } catch (error) {
          console.error('Failed to save:', error);
        }
      };
      saveData();
    }
  }, [data, loading]);

  // íƒ€ì´ë¨¸ ë¡œì§
  useEffect(() => {
    if (timerRunning && selectedTime && !timerPaused) {
      timerRef.current = setInterval(() => {
        setTimerSeconds(prev => {
          const newSeconds = prev + 1;
          const targetSeconds = selectedTime * 60;
          if (newSeconds >= targetSeconds && !isOvertime) {
            setIsOvertime(true);
          }
          return newSeconds;
        });
      }, 1000);
    } else {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    }
    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [timerRunning, selectedTime, isOvertime, timerPaused]);

  const getTodayRecord = () => {
    return data.dailyRecords[getTodayString()] || { ...emptyDayRecord };
  };

  const getCurrentDayRecord = () => {
    return data.dailyRecords[selectedDate] || { ...emptyDayRecord };
  };

  // ì‹œê°„ ì„ íƒ ì‹œ ëª…ì–¸ íŒì—… í‘œì‹œ
  const startTimer = (minutes) => {
    setPendingStartMinutes(minutes);
    setCurrentQuote(getRandomQuote());
    setShowQuoteModal(true);
  };

  // ì‹¤ì œ íƒ€ì´ë¨¸ ì‹œì‘ (ëª…ì–¸ íŒì—…ì—ì„œ í™•ì¸ í´ë¦­ ì‹œ)
  const confirmStartTimer = () => {
    setSelectedTime(pendingStartMinutes);
    setTimerSeconds(0);
    setIsOvertime(false);
    setTimerPaused(false);
    setSessionStartTime(new Date()); // ì‹œì‘ ì‹œê°„ ì €ì¥
    setTimerRunning(true);
    setShowQuoteModal(false);
    setPendingStartMinutes(null);
    setCurrentQuote(null);
  };

  // ëª…ì–¸ íŒì—… ì·¨ì†Œ
  const cancelQuoteModal = () => {
    setShowQuoteModal(false);
    setPendingStartMinutes(null);
    setCurrentQuote(null);
  };

  // ì¼ì‹œì •ì§€ í† ê¸€
  const togglePause = () => {
    setTimerPaused(prev => !prev);
  };

  // ì „ì²´í™”ë©´ í† ê¸€
  const toggleFullscreen = () => {
    if (!document.fullscreenElement) {
      if (containerRef.current) {
        containerRef.current.requestFullscreen().then(() => {
          setIsFullscreen(true);
        }).catch(err => {
          console.log('Fullscreen error:', err);
        });
      }
    } else {
      document.exitFullscreen().then(() => {
        setIsFullscreen(false);
      });
    }
  };

  // ì „ì²´í™”ë©´ ìƒíƒœ ê°ì§€
  useEffect(() => {
    const handleFullscreenChange = () => {
      setIsFullscreen(!!document.fullscreenElement);
    };
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
  }, []);

  // ğŸ“œ ëª¨í—˜ íƒ­ ì§„ì…ì‹œ ì˜¤ëŠ˜ ë°ì´í„° ë¡œë“œ (v8.7)
  useEffect(() => {
    if (activeTab === 'adventure') {
      const todayRecord = getTodayRecord();
      setFeedbackMemo(todayRecord.feedbackMemo || '');
      setDiaryText(todayRecord.diary || '');
    }
  }, [activeTab]);

  // íƒ€ì´ë¨¸ ì™„ë£Œ
  const completeTimer = () => {
    setTimerRunning(false);
    setTimerPaused(false);
    setShowCompleteModal(true);
  };

  // íƒ€ì´ë¨¸ ì·¨ì†Œ
  const cancelTimer = () => {
    setTimerRunning(false);
    setTimerPaused(false);
    setSelectedTime(null);
    setTimerSeconds(0);
    setIsOvertime(false);
    setSessionStartTime(null);
  };

  // ì„¸ì…˜ ì™„ë£Œ ì²˜ë¦¬
  const finishSession = () => {
    const today = getTodayString();
    const actualMinutes = Math.ceil(timerSeconds / 60);
    
    // ì‹œì‘ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ëŒ€ë³„ ë¶„í•  ê³„ì‚°
    const startTime = sessionStartTime || new Date(Date.now() - actualMinutes * 60000);
    const slotMinutes = calculateTimeSlotMinutes(startTime, actualMinutes);
    
    // ê°€ì¥ ë§ì€ ì‹œê°„ì„ ë³´ë‚¸ ì‹œê°„ëŒ€ë¥¼ ë©”ì¸ ì‹œê°„ëŒ€ë¡œ ê¸°ë¡
    const mainTimeSlot = Object.entries(slotMinutes).reduce((a, b) => a[1] > b[1] ? a : b)[0];
    
    // í† í° ê³„ì‚°: ì‹¤ì œì‹œê°„ ê¸°ì¤€ (5ë¶„=10í† í°, ..., 50ë¶„=100í† í°)
    // ë‹¨, ì„¤ì •ì‹œê°„ì„ ì´ˆê³¼í•´ë„ ì„¤ì •ì‹œê°„ê¹Œì§€ë§Œ ì¸ì •
    const effectiveMinutes = Math.min(actualMinutes, selectedTime);
    const baseTokens = effectiveMinutes * 2;
    const focusMultiplier = focusMultipliers[sessionFocus] || 1.0;
    const earnedTokens = Math.round(baseTokens * focusMultiplier);
    
    const sessionRecord = {
      timeSlot: mainTimeSlot,
      startTime: startTime.toLocaleTimeString(),
      targetMinutes: selectedTime,
      actualMinutes: actualMinutes,
      focus: sessionFocus,
      ankiCount: sessionAnki ? parseInt(sessionAnki) : null,
      goal: sessionGoal || null,
      buff: selectedBuff ? blessings[selectedBuff] : null,
      tokens: earnedTokens,
      slotBreakdown: slotMinutes // ì‹œê°„ëŒ€ë³„ ë¶„í•  ê¸°ë¡
    };

    const actionRecord = {
      type: 'study',
      amount: earnedTokens,
      actionName: `ê³µë¶€ ${actualMinutes}/${selectedTime}ë¶„ (${sessionFocus})${sessionGoal ? ' - ' + sessionGoal : ''}`,
      timeSlot: mainTimeSlot,
      targetMinutes: selectedTime,
      actualMinutes,
      focus: sessionFocus,
      ankiCount: sessionAnki ? parseInt(sessionAnki) : null,
      goal: sessionGoal || null,
      buff: selectedBuff || null,
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      dayRecord.earned += earnedTokens;
      dayRecord.studySets += 1;
      
      // ì‹œê°„ëŒ€ë³„ ë¶„í•  ëˆ„ì  (í•µì‹¬ ë³€ê²½!)
      dayRecord.morningMinutes += slotMinutes.morning;
      dayRecord.afternoonMinutes += slotMinutes.afternoon;
      dayRecord.eveningMinutes += slotMinutes.evening;
      dayRecord.freeMinutes += slotMinutes.free;
      
      // ì„¸ì…˜ ê¸°ë¡ ì¶”ê°€
      if (!dayRecord.studySessions) dayRecord.studySessions = [];
      dayRecord.studySessions = [...dayRecord.studySessions, sessionRecord];
      
      // ì•¡ì…˜ ë¡œê·¸
      dayRecord.actions = [...dayRecord.actions, {
        type: 'earn',
        amount: earnedTokens,
        name: `ê³µë¶€ ${selectedTime}ë¶„ (${sessionFocus}${sessionAnki ? ', ' + sessionAnki + 'ë¬¸ì œ' : ''})`,
        time: new Date().toLocaleTimeString()
      }];
      
      // ë³´ë„ˆìŠ¤ ìë™ ì²´í¬ (ê° ì‹œê°„ëŒ€ë³„ë¡œ 40ë¶„ ì´ìƒ ì¶”ê°€ë˜ì—ˆì„ ë•Œ)
      let totalBonusEarned = 0;
      const bonusMessages = [];
      
      // ì˜¤ì „ ë³´ë„ˆìŠ¤ ì²´í¬ (ì˜¤ì „ ì‹œê°„ì´ ì¶”ê°€ë˜ë©´ í•­ìƒ ì²´í¬)
      if (slotMinutes.morning > 0) {
        if (dayRecord.morningMinutes >= 160 && dayRecord.morningBonusType !== '4set') {
          const bonus = dayRecord.morningBonusType === '3set' ? 200 : 400;
          totalBonusEarned += bonus;
          dayRecord.morningBonusType = '4set';
          bonusMessages.push({ amount: bonus, name: 'ì˜¤ì „ 4ì„¸íŠ¸ ë³´ë„ˆìŠ¤' });
        } else if (dayRecord.morningMinutes >= 120 && !dayRecord.morningBonusType) {
          totalBonusEarned += 200;
          dayRecord.morningBonusType = '3set';
          bonusMessages.push({ amount: 200, name: 'ì˜¤ì „ 3ì„¸íŠ¸ ë³´ë„ˆìŠ¤' });
        }
      }
      
      // ì˜¤í›„ ë³´ë„ˆìŠ¤ ì²´í¬ (ì˜¤í›„ ì‹œê°„ì´ ì¶”ê°€ë˜ë©´ í•­ìƒ ì²´í¬)
      if (slotMinutes.afternoon > 0) {
        if (dayRecord.afternoonMinutes >= 160 && dayRecord.afternoonBonusType !== '4set') {
          const bonus = dayRecord.afternoonBonusType === '3set' ? 300 : 600;
          totalBonusEarned += bonus;
          dayRecord.afternoonBonusType = '4set';
          bonusMessages.push({ amount: bonus, name: 'ì˜¤í›„ 4ì„¸íŠ¸ ë³´ë„ˆìŠ¤' });
        } else if (dayRecord.afternoonMinutes >= 120 && !dayRecord.afternoonBonusType) {
          totalBonusEarned += 300;
          dayRecord.afternoonBonusType = '3set';
          bonusMessages.push({ amount: 300, name: 'ì˜¤í›„ 3ì„¸íŠ¸ ë³´ë„ˆìŠ¤' });
        }
      }
      
      // ì €ë… ë³´ë„ˆìŠ¤ ì²´í¬ (ì €ë… ì‹œê°„ì´ ì¶”ê°€ë˜ë©´ í•­ìƒ ì²´í¬)
      if (slotMinutes.evening > 0) {
        if (dayRecord.eveningMinutes >= 80 && dayRecord.eveningBonusType !== '2set') {
          // 1ì„¸íŠ¸ë¥¼ ì´ë¯¸ ë°›ì•˜ìœ¼ë©´ ì¶”ê°€ë¶„ë§Œ, ì•„ë‹ˆë©´ í’€ ë³´ë„ˆìŠ¤
          const bonus = dayRecord.eveningBonusType === '1set' ? 150 : 250;
          totalBonusEarned += bonus;
          dayRecord.eveningBonusType = '2set';
          bonusMessages.push({ amount: bonus, name: 'ì €ë… 2ì„¸íŠ¸ ë³´ë„ˆìŠ¤' });
        } else if (dayRecord.eveningMinutes >= 40 && !dayRecord.eveningBonusType) {
          totalBonusEarned += 100;
          dayRecord.eveningBonusType = '1set';
          bonusMessages.push({ amount: 100, name: 'ì €ë… 1ì„¸íŠ¸ ë³´ë„ˆìŠ¤' });
        }
      }
      
      // ë³´ë„ˆìŠ¤ ì•¡ì…˜ ë¡œê·¸ ì¶”ê°€
      bonusMessages.forEach(bonus => {
        dayRecord.earned += bonus.amount;
        dayRecord.actions = [...dayRecord.actions, {
          type: 'earn',
          amount: bonus.amount,
          name: bonus.name,
          time: new Date().toLocaleTimeString()
        }];
      });
      
      newDailyRecords[today] = dayRecord;

      // ë³´ë„ˆìŠ¤ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      let newMorningBonusCount = prev.morningBonusCount;
      let newAfternoonBonusCount = prev.afternoonBonusCount;
      let newEveningBonusCount = prev.eveningBonusCount;
      
      bonusMessages.forEach(bonus => {
        if (bonus.name.includes('ì˜¤ì „')) newMorningBonusCount++;
        if (bonus.name.includes('ì˜¤í›„')) newAfternoonBonusCount++;
        if (bonus.name.includes('ì €ë…')) newEveningBonusCount++;
      });

      return {
        ...prev,
        tokens: prev.tokens + earnedTokens + totalBonusEarned,
        totalEarned: prev.totalEarned + earnedTokens + totalBonusEarned,
        studySets: prev.studySets + 1,
        morningBonusCount: newMorningBonusCount,
        afternoonBonusCount: newAfternoonBonusCount,
        eveningBonusCount: newEveningBonusCount,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });

    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    showToast(`+${earnedTokens} ê³µë¶€ ${actualMinutes}/${selectedTime}ë¶„ (${sessionFocus})`, 'earn');

    // ìƒíƒœ ì´ˆê¸°í™”
    setShowCompleteModal(false);
    setSelectedTime(null);
    setTimerSeconds(0);
    setIsOvertime(false);
    setTimerPaused(false);
    setSessionFocus('S');
    setSessionAnki('');
    setSessionGoal('');
    setSelectedBuff(null);
    setSessionStartTime(null);
  };

  // í† í° íšë“ (ì¼ë°˜)
  const earnTokens = (amount, actionName, bonusType = null, bonusSubType = null, extraData = null) => {
    const today = getTodayString();
    const todayRecord = getTodayRecord();
    
    // ì¤‘ë³µ ì²´í¬
    if (bonusType === 'exercise' && todayRecord.exerciseDone) return;
    if (bonusType === 'fullcourse' && todayRecord.fullCourse) return;
    if (bonusType === 'goal90late' && todayRecord.goal90late) return;
    if (bonusType === 'goal90ontime' && todayRecord.goal90ontime) return;
    // 90% ë‹¬ì„±ì€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ íšë“ ê°€ëŠ¥ (ìƒí˜¸ë°°íƒ€)
    if (bonusType === 'goal90late' && todayRecord.goal90ontime) return;
    if (bonusType === 'goal90ontime' && todayRecord.goal90late) return;
    if (bonusType === 'goal100' && todayRecord.goal100) return;

    const actionRecord = {
      type: 'earn',
      amount,
      actionName,
      bonusType,
      bonusSubType,
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      dayRecord.earned += amount;
      dayRecord.actions = [...dayRecord.actions, {
        type: 'earn',
        amount,
        name: actionName,
        time: new Date().toLocaleTimeString()
      }];
      
      // ìš´ë™ (í•˜ë£¨ 1íšŒ)
      if (bonusType === 'exercise') dayRecord.exerciseDone = true;
      if (bonusType === 'fullcourse') dayRecord.fullCourse = true;
      
      // ì•½ì í¬ì°© (ì‹ì‚¬ì‹œê°„ë³„)
      if (bonusType === 'weaknessHunt') {
        const mealTime = bonusSubType; // 'morning', 'lunch', 'dinner'
        const count = extraData || 1; // 5ë²ˆì§¸ ì¸ìë¡œ ê°¯ìˆ˜ ì „ë‹¬
        if (mealTime === 'morning') dayRecord.weaknessHuntMorning = (dayRecord.weaknessHuntMorning || 0) + count;
        else if (mealTime === 'lunch') dayRecord.weaknessHuntLunch = (dayRecord.weaknessHuntLunch || 0) + count;
        else if (mealTime === 'dinner') dayRecord.weaknessHuntDinner = (dayRecord.weaknessHuntDinner || 0) + count;
      }
      
      // ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†”
      if (bonusType === 'mokokoSniff') {
        const count = bonusSubType || 1;
        dayRecord.mokokoSniff = (dayRecord.mokokoSniff || 0) + count;
      }
      
      // ğŸ¹ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°©
      if (bonusType === 'zaharaTraining') {
        const mealTime = bonusSubType; // 'morning', 'lunch', 'dinner'
        if (mealTime === 'morning') dayRecord.zaharaTrainingMorning = true;
        else if (mealTime === 'lunch') dayRecord.zaharaTrainingLunch = true;
        else if (mealTime === 'dinner') dayRecord.zaharaTrainingDinner = true;
      }
      
      // ğŸŒ™ Dear, my friends
      if (bonusType === 'dearMyFriends') dayRecord.dearMyFriends = true;
      
      if (bonusType === 'goal90late') dayRecord.goal90late = true;
      if (bonusType === 'goal90ontime') dayRecord.goal90ontime = true;
      if (bonusType === 'goal100') dayRecord.goal100 = true;
      
      newDailyRecords[today] = dayRecord;

      return {
        ...prev,
        tokens: prev.tokens + amount,
        totalEarned: prev.totalEarned + amount,
        exerciseBonusCount: bonusType === 'exercise' ? prev.exerciseBonusCount + 1 : prev.exerciseBonusCount,
        fullCourseCount: bonusType === 'fullcourse' ? prev.fullCourseCount + 1 : prev.fullCourseCount,
        zaharaTrainingCount: bonusType === 'zaharaTraining' ? prev.zaharaTrainingCount + 1 : prev.zaharaTrainingCount,
        dearMyFriendsCount: bonusType === 'dearMyFriends' ? prev.dearMyFriendsCount + 1 : prev.dearMyFriendsCount,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });

    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    showToast(`ğŸª™+${amount} ${actionName}`, 'earn');
  };

  // ğŸ˜´ íœ´ì‹ ê¸°ë¡
  const recordRest = (restType, minutes) => {
    const today = getTodayString();
    const parsedMinutes = parseInt(minutes) || 0;
    
    // í† í° ê³„ì‚°
    const tokenRewards = {
      nap: 100,      // ğŸ˜´ ì„ ì /ê¿€ì 
      stable: 50,    // ğŸª¶ ë² ì•„ ì•ˆì •
      love: 20,      // ğŸ’• ë² ì•„ ì‚¬ë‘
      overheat: -100 // ğŸ“± ë‡Œ ê³¼ì—´
    };
    const tokens = tokenRewards[restType] || 0;
    
    const restNames = {
      nap: 'ğŸ˜´ ì„ ì /ê¿€ì ',
      stable: 'ğŸª¶ ë² ì•„ ì•ˆì •',
      love: 'ğŸ’• ë² ì•„ ì‚¬ë‘',
      overheat: 'ğŸ“± ë‡Œ ê³¼ì—´'
    };
    
    const restRecord = {
      time: new Date().toLocaleTimeString(),
      type: restType,
      minutes: parsedMinutes,
      tokens: tokens
    };
    
    const actionRecord = {
      type: tokens >= 0 ? 'earn' : 'spend',
      amount: Math.abs(tokens),
      actionName: `${restNames[restType]} (${parsedMinutes}ë¶„)`,
      restType,
      restMinutes: parsedMinutes,
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      
      // íœ´ì‹ ì„¸ì…˜ ì¶”ê°€
      if (!dayRecord.restSessions) dayRecord.restSessions = [];
      dayRecord.restSessions = [...dayRecord.restSessions, restRecord];
      
      // í† í° ì²˜ë¦¬
      if (tokens >= 0) {
        dayRecord.earned += tokens;
      } else {
        dayRecord.spent += Math.abs(tokens);
      }
      
      // ì•¡ì…˜ ë¡œê·¸
      dayRecord.actions = [...dayRecord.actions, {
        type: tokens >= 0 ? 'earn' : 'spend',
        amount: Math.abs(tokens),
        name: `${restNames[restType]} (${parsedMinutes}ë¶„)`,
        time: new Date().toLocaleTimeString()
      }];
      
      newDailyRecords[today] = dayRecord;
      
      // ì „ì—­ íœ´ì‹ í†µê³„ ì—…ë°ì´íŠ¸
      const newRestStats = { ...prev.restStats };
      if (restType === 'nap') newRestStats.napCount++;
      else if (restType === 'stable') newRestStats.stableCount++;
      else if (restType === 'love') newRestStats.loveCount++;
      else if (restType === 'overheat') newRestStats.overheatCount++;
      
      // ê¸°ì–µ ê³µê³ í™” ì‹œê°„ (ë‡Œ ê³¼ì—´ ì œì™¸)
      if (restType !== 'overheat') {
        newRestStats.totalRestMinutes += parsedMinutes;
      }

      return {
        ...prev,
        tokens: tokens >= 0 ? prev.tokens + tokens : Math.max(0, prev.tokens + tokens),
        totalEarned: tokens >= 0 ? prev.totalEarned + tokens : prev.totalEarned,
        totalSpent: tokens < 0 ? prev.totalSpent + Math.abs(tokens) : prev.totalSpent,
        restStats: newRestStats,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });

    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    if (tokens >= 0) {
      showToast(`ğŸª™+${tokens} ${restNames[restType]}`, 'earn');
    } else {
      showToast(`ğŸª™${tokens} ${restNames[restType]}`, 'spend');
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    setShowRestModal(null);
    setRestMinutes('15');
  };

  // ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ í•¨ìˆ˜ (v8.2)
  const recordSleep = () => {
    const today = getTodayString();
    const todayRecord = getTodayRecord();
    
    // ì´ë¯¸ ê¸°ë¡í–ˆìœ¼ë©´ ìŠ¤í‚µ
    if (todayRecord.sleep?.recorded) {
      showToast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ìˆ˜ë©´ ê¸°ë¡ì„ í–ˆì–´ìš”!', 'spend');
      return;
    }
    
    // ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    const timeToMinutes = (timeStr) => {
      if (!timeStr) return 0;
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    };
    
    // ìì •ì„ ë„˜ê¸°ëŠ” ì‹œê°„ ì°¨ì´ ê³„ì‚°
    const calcTimeDiff = (startTime, endTime) => {
      let startMin = timeToMinutes(startTime);
      let endMin = timeToMinutes(endTime);
      if (endMin < startMin) endMin += 24 * 60;
      return endMin - startMin;
    };
    
    // ì¬ì…ë©´ ì‹œê°„ ì¶”ì • (ë¶„) - v8.8
    const getReentryMinutes = (reentry) => {
      switch (reentry) {
        case 'quick': return 3;    // ~5ë¶„ â†’ í‰ê·  3ë¶„
        case 'short': return 7;    // ~10ë¶„ â†’ í‰ê·  7ë¶„
        case 'medium': return 15;  // ~20ë¶„ â†’ í‰ê·  15ë¶„
        case 'long': return 25;    // ~30ë¶„ â†’ í‰ê·  25ë¶„
        case 'veryLong': return 40; // 30ë¶„+ â†’ í‰ê·  40ë¶„
        case 'few': return 5;      // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ (ëª‡ë¶„)
        case 'failed': return 0;   // ëª»ì  (ë³„ë„ ì²˜ë¦¬)
        default: return 0;
      }
    };
    
    // ì´ ì¹¨ëŒ€ ì‹œê°„ ê³„ì‚° (ì¹¨ëŒ€ â†’ ì´íƒˆ)
    const totalBedMinutes = calcTimeDiff(sleepBedTime, sleepOutOfBedTime);
    
    // ì¹¨ëŒ€ ë‚´ í™œë™ ì‹œê°„ (ì¹¨ëŒ€ â†’ ì¡°ëª… ë”)
    const preSleepActivityMinutes = calcTimeDiff(sleepBedTime, sleepLightsOffTime);
    
    // ê¸°ìƒ í›„ ì¹¨ëŒ€ ì‹œê°„ (ìµœì¢… ê°ì„± â†’ ì´íƒˆ)
    const postWakeMinutes = calcTimeDiff(sleepFinalWakeTime, sleepOutOfBedTime);
    
    // TIB ê¸°ë°˜ ìˆ˜ë©´ ì‹œê°„ (ì¡°ëª… ë” â†’ ìµœì¢… ê°ì„±)
    const sleepMinutes = calcTimeDiff(sleepLightsOffTime, sleepFinalWakeTime);
    
    // ì¤‘ê°„ ê°ì„± ì‹œ í–‰ë™ ì ìˆ˜ ê³„ì‚°
    const awakeningCount = parseInt(sleepAwakeningCount);
    const validAwakenings = awakenings.slice(0, awakeningCount).filter(a => a.time);
    
    // ì¶”ì • WASO (Wake After Sleep Onset) ê³„ì‚° - v8.8
    let estimatedWASO = 0;
    validAwakenings.forEach(awakening => {
      estimatedWASO += getReentryMinutes(awakening.reentry);
    });
    
    // ì¶”ì • TST (Total Sleep Time) ê³„ì‚° - v8.8
    const estimatedTST = Math.max(0, sleepMinutes - estimatedWASO);
    const estimatedTSTHours = estimatedTST / 60;
    
    // Sleep Efficiency ê³„ì‚° (TST / TIB * 100) - v8.8
    const sleepEfficiency = totalBedMinutes > 0 ? Math.round((estimatedTST / totalBedMinutes) * 100) : 0;
    
    // ìˆ˜ë©´ ì „ í–‰ë™ ì ìˆ˜ ê³„ì‚°
    let preBehaviorScore = 0;
    if (sleepPreBehaviors.beaLove && sleepPreBehaviors.loaScripture) {
      preBehaviorScore = 150; // ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤
    } else {
      if (sleepPreBehaviors.beaLove) preBehaviorScore += 50;
      if (sleepPreBehaviors.loaScripture) preBehaviorScore += 50;
    }
    if (sleepPreBehaviors.beaCheat) preBehaviorScore -= 100;
    if (sleepPreBehaviors.brainOverheat) preBehaviorScore -= 50;
    
    // ì¤‘ê°„ ê°ì„± ì‹œ í–‰ë™ ì ìˆ˜ ê³„ì‚°
    let awakeningActivityScore = 0;
    
    validAwakenings.forEach(awakening => {
      if (awakening.activity === 'scripture') {
        awakeningActivityScore += 30; // ğŸ“– ë¡œì•„ ì„±ê²½
      } else if (awakening.activity === 'beaStable') {
        awakeningActivityScore += 25; // ğŸª¶ ë² ì•„ ì•ˆì •
      } else if (awakening.activity === 'meditation') {
        awakeningActivityScore += 15; // ğŸ§˜ ëª…ìƒ/í˜¸í¡
      } else if (awakening.activity === 'beaLove') {
        awakeningActivityScore += 10; // ğŸ’• ë² ì•„ ì‚¬ë‘
      } else if (awakening.activity === 'phone' || awakening.activity === 'youtube') {
        awakeningActivityScore -= 50; // ğŸ“± í•¸ë“œí° / ğŸ“º ìœ íŠœë¸Œ
      }
      // none, study, otherëŠ” 0ì 
    });
    
    // ì´ ì ìˆ˜ ê³„ì‚°
    const totalBehaviorScore = preBehaviorScore + awakeningActivityScore;
    
    // ëª©í‘œ ë‹¬ì„± ì²´í¬: ì¶”ì • TST ê¸°ì¤€ 7~8ì‹œê°„ + í’ˆì§ˆ B ì´ìƒ + í–‰ë™ ì ìˆ˜ ì–‘ìˆ˜
    const qualityGood = ['SS', 'S', 'A', 'B'].includes(sleepQuality);
    const isGoalAchieved = estimatedTSTHours >= 7 && estimatedTSTHours <= 8 && qualityGood && totalBehaviorScore >= 0;
    
    // í† í° ê³„ì‚°
    const recordBonus = 50;  // ê¸°ë¡ ì™„ë£Œ ë³´ë„ˆìŠ¤
    const goalBonus = isGoalAchieved ? 100 : 0;  // ëª©í‘œ ë‹¬ì„± ë³´ë„ˆìŠ¤
    const behaviorBonus = Math.max(0, totalBehaviorScore); // í–‰ë™ ì ìˆ˜ (ì–‘ìˆ˜ë§Œ)
    const behaviorPenalty = Math.min(0, totalBehaviorScore); // í–‰ë™ í˜ë„í‹° (ìŒìˆ˜ë§Œ)
    const totalTokens = recordBonus + goalBonus + behaviorBonus + behaviorPenalty;
    
    // ìˆ˜ë©´ ê¸°ë¡ ê°ì²´ (v8.8 - ì¶”ì • TST ì¶”ê°€)
    const sleepRecord = {
      bedTime: sleepBedTime,
      lightsOffTime: sleepLightsOffTime,
      finalWakeTime: sleepFinalWakeTime,
      outOfBedTime: sleepOutOfBedTime,
      latencyFeel: sleepLatencyFeel,
      awakeningCount: awakeningCount,
      awakenings: validAwakenings,
      preBehaviors: { ...sleepPreBehaviors },
      preBehaviorScore,
      awakeningActivityScore,
      quality: sleepQuality,
      memo: sleepMemo,
      totalBedMinutes,
      sleepMinutes,           // TIB ê¸°ë°˜ (ì†Œë“±~ê¸°ìƒ)
      estimatedWASO,          // ì¶”ì • ê¹¨ì–´ìˆë˜ ì‹œê°„
      estimatedTST,           // ì¶”ì • ì‹¤ì œ ìˆ˜ë©´ ì‹œê°„
      sleepEfficiency,        // ìˆ˜ë©´ íš¨ìœ¨ (%)
      preSleepActivityMinutes,
      postWakeMinutes,
      recorded: true,
      goalAchieved: isGoalAchieved
    };
    
    // ì•¡ì…˜ ê¸°ë¡
    const actionRecord = {
      type: totalTokens >= 0 ? 'earn' : 'spend',
      amount: Math.abs(totalTokens),
      actionName: `ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ (ì¶”ì • ${Math.floor(estimatedTSTHours)}ì‹œê°„ ${estimatedTST % 60}ë¶„, ${sleepQuality}ë“±ê¸‰, íš¨ìœ¨ ${sleepEfficiency}%)${isGoalAchieved ? ' + ëª©í‘œë‹¬ì„±' : ''}`,
      date: today,
      timestamp: new Date().toISOString()
    };
    
    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      dayRecord.sleep = sleepRecord;
      if (totalTokens >= 0) {
        dayRecord.earned += totalTokens;
      } else {
        dayRecord.spent += Math.abs(totalTokens);
      }
      
      // ì•¡ì…˜ ë¡œê·¸
      dayRecord.actions = [...dayRecord.actions, {
        type: totalTokens >= 0 ? 'earn' : 'spend',
        amount: Math.abs(totalTokens),
        name: `ğŸ’¤ ìˆ˜ë©´ (${Math.floor(sleepMinutes / 60)}h${sleepMinutes % 60}m, ${sleepQuality})${isGoalAchieved ? ' ğŸ¯' : ''}`,
        time: new Date().toLocaleTimeString()
      }];
      
      newDailyRecords[today] = dayRecord;
      
      // ì „ì—­ ìˆ˜ë©´ í†µê³„ ì—…ë°ì´íŠ¸
      const newSleepStats = { ...prev.sleepStats };
      newSleepStats.recordCount++;
      newSleepStats.totalSleepMinutes += sleepMinutes;
      
      if (isGoalAchieved) {
        newSleepStats.goalAchievedCount++;
        newSleepStats.streakCount++;
        if (newSleepStats.streakCount > newSleepStats.bestStreak) {
          newSleepStats.bestStreak = newSleepStats.streakCount;
        }
      } else {
        newSleepStats.streakCount = 0;
      }
      
      return {
        ...prev,
        tokens: totalTokens >= 0 ? prev.tokens + totalTokens : Math.max(0, prev.tokens + totalTokens),
        totalEarned: totalTokens >= 0 ? prev.totalEarned + totalTokens : prev.totalEarned,
        totalSpent: totalTokens < 0 ? prev.totalSpent + Math.abs(totalTokens) : prev.totalSpent,
        sleepStats: newSleepStats,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });
    
    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    if (totalTokens >= 0) {
      showToast(`ğŸª™+${totalTokens} ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡${isGoalAchieved ? ' + ğŸ¯ ëª©í‘œë‹¬ì„±!' : ''}`, 'earn');
    } else {
      showToast(`ğŸª™${totalTokens} ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ (í–‰ë™ í˜ë„í‹°)`, 'spend');
    }
    
    // ì…ë ¥ í¼ ì´ˆê¸°í™”
    setSleepPreBehaviors({ beaLove: false, loaScripture: false, beaCheat: false, brainOverheat: false });
    setSleepMemo('');
    setAwakenings([
      { time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' },
      { time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' },
      { time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' }
    ]);
  };

  // ğŸŒ™ ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ ì €ì¥ í•¨ìˆ˜
  const saveSleepHabits = () => {
    setData(prev => ({
      ...prev,
      sleepHabits: {
        good: sleepHabitsGood,
        bad: sleepHabitsBad,
        tryThis: sleepHabitsTry
      }
    }));
    showToast('ğŸŒ™ ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ ì €ì¥ ì™„ë£Œ!', 'earn');
  };

  // ğŸ˜´ ë‚®ì  ê¸°ë¡ (v8.6)
  const recordNap = () => {
    const today = getTodayString();
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    // ë‚®ì  ì‹œê°„ ê³„ì‚°
    const timeToMin = (t) => { if (!t) return 0; const [h,m] = t.split(':').map(Number); return h*60+m; };
    const startMin = timeToMin(napStartTime);
    const endMin = timeToMin(napEndTime);
    let napMinutes = endMin - startMin;
    if (napMinutes < 0) napMinutes += 24 * 60; // ìì • ë„˜ì–´ê°„ ê²½ìš°
    
    const napRecord = {
      startTime: napStartTime,
      endTime: napEndTime,
      minutes: napMinutes,
      memo: napMemo,
      intentional: napIntentional,
      time: timeStr
    };
    
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      const updatedNaps = [...(todayRecord.naps || []), napRecord];
      
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            naps: updatedNaps
          }
        }
      };
    });
    
    // ìƒíƒœ ì´ˆê¸°í™”
    setShowNapModal(false);
    setNapMemo('');
    setNapIntentional(true);
    
    const intentText = napIntentional ? 'ì˜ë„ì ' : 'ë¹„ì˜ë„ì ';
    showToast(`ğŸ˜´ ë‚®ì  ê¸°ë¡ ì™„ë£Œ! (${napMinutes}ë¶„, ${intentText})`, 'earn');
  };

  // ğŸ˜´ ë‚®ì  ê¸°ë¡ ì‚­ì œ
  const deleteNap = (napIndex) => {
    const today = getTodayString();
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      const updatedNaps = [...(todayRecord.naps || [])];
      updatedNaps.splice(napIndex, 1);
      
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            naps: updatedNaps
          }
        }
      };
    });
    showToast('ğŸ˜´ ë‚®ì  ê¸°ë¡ ì‚­ì œë¨', 'spend');
  };

  // ğŸ“œ í€˜ìŠ¤íŠ¸ ì¶”ê°€ (v8.7)
  const addQuest = () => {
    if (!questInput.trim()) return;
    const today = getTodayString();
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    const newQuest = {
      text: questInput.trim(),
      status: 'todo', // 'todo' | 'done' | 'failed'
      createdAt: timeStr
    };
    
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            quests: [...(todayRecord.quests || []), newQuest]
          }
        }
      };
    });
    
    setQuestInput('');
    showToast('ğŸ“œ í€˜ìŠ¤íŠ¸ ì¶”ê°€!', 'earn');
  };

  // ğŸ“œ í€˜ìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ (v8.7)
  const toggleQuestStatus = (questIndex) => {
    const today = getTodayString();
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      const updatedQuests = [...(todayRecord.quests || [])];
      const currentStatus = updatedQuests[questIndex].status;
      
      // todo -> done -> failed -> todo ìˆœí™˜
      const nextStatus = currentStatus === 'todo' ? 'done' : currentStatus === 'done' ? 'failed' : 'todo';
      updatedQuests[questIndex] = { ...updatedQuests[questIndex], status: nextStatus };
      
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            quests: updatedQuests
          }
        }
      };
    });
  };

  // ğŸ“œ í€˜ìŠ¤íŠ¸ ì‚­ì œ (v8.7)
  const deleteQuest = (questIndex) => {
    const today = getTodayString();
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      const updatedQuests = [...(todayRecord.quests || [])];
      updatedQuests.splice(questIndex, 1);
      
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            quests: updatedQuests
          }
        }
      };
    });
    showToast('ğŸ“œ í€˜ìŠ¤íŠ¸ ì‚­ì œë¨', 'spend');
  };

  // ğŸ“œ í”¼ë“œë°± ë©”ëª¨ ì €ì¥ (v8.7)
  const saveFeedbackMemo = () => {
    const today = getTodayString();
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            feedbackMemo: feedbackMemo
          }
        }
      };
    });
    showToast('ğŸ’œ í”¼ë“œë°± ë©”ëª¨ ì €ì¥!', 'earn');
  };

  // ğŸ“œ ììœ  ì¼ê¸° ì €ì¥ (v8.7)
  const saveDiary = () => {
    const today = getTodayString();
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      return {
        ...prev,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            diary: diaryText
          }
        }
      };
    });
    showToast('ğŸ“” ì¼ê¸° ì €ì¥!', 'earn');
  };

  // ğŸ“œ ì˜¤ëŠ˜ ê¸°ë¡ ë¡œë“œ (v8.7) - ëª¨í—˜ íƒ­ ì§„ì…ì‹œ
  const loadTodayAdventure = () => {
    const todayRecord = getTodayRecord();
    setFeedbackMemo(todayRecord.feedbackMemo || '');
    setDiaryText(todayRecord.diary || '');
  };

  // ğŸƒ ì„¸ê³„ìˆ˜ì˜ ì íšë“ (v8.8)
  const addWorldTreeLeaf = (type, tokenChange, actionName) => {
    const today = getTodayString();
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    // í† í° ì²´í¬ (ì‚¬ìš©í•˜ëŠ” ê²½ìš°)
    if (tokenChange < 0 && data.tokens < Math.abs(tokenChange)) {
      showToast(`í† í°ì´ ë¶€ì¡±í•´ìš”! (í•„ìš”: ${Math.abs(tokenChange)})`, 'spend');
      return;
    }
    
    setData(prev => {
      const todayRecord = prev.dailyRecords[today] || { ...emptyDayRecord };
      const worldTree = todayRecord.worldTree || { scripture: 0, scriptureSleep: 0, scriptureRest: 0, singing: 0, piano: 0, strength: 0, cardio: 0 };
      const globalLeaves = prev.worldTreeLeaves || { total: 0, scripture: 0, singing: 0, piano: 0, strength: 0, cardio: 0 };
      
      // íƒ€ì…ë³„ ì—…ë°ì´íŠ¸
      const updatedWorldTree = { ...worldTree };
      const updatedGlobalLeaves = { ...globalLeaves };
      
      if (type === 'scriptureSleep') {
        updatedWorldTree.scriptureSleep = (worldTree.scriptureSleep || 0) + 1;
        updatedWorldTree.scripture = (worldTree.scripture || 0) + 1;
        updatedGlobalLeaves.scripture = (globalLeaves.scripture || 0) + 1;
      } else if (type === 'scriptureRest') {
        updatedWorldTree.scriptureRest = (worldTree.scriptureRest || 0) + 1;
        updatedWorldTree.scripture = (worldTree.scripture || 0) + 1;
        updatedGlobalLeaves.scripture = (globalLeaves.scripture || 0) + 1;
      } else {
        updatedWorldTree[type] = (worldTree[type] || 0) + 1;
        updatedGlobalLeaves[type] = (globalLeaves[type] || 0) + 1;
      }
      updatedGlobalLeaves.total = (globalLeaves.total || 0) + 1;
      
      // ì•¡ì…˜ ê¸°ë¡
      const newAction = {
        time: timeStr,
        name: `ğŸƒ ${actionName}`,
        type: tokenChange >= 0 ? 'earn' : 'spend',
        amount: Math.abs(tokenChange)
      };
      
      return {
        ...prev,
        tokens: prev.tokens + tokenChange,
        totalEarned: tokenChange > 0 ? prev.totalEarned + tokenChange : prev.totalEarned,
        totalSpent: tokenChange < 0 ? prev.totalSpent + Math.abs(tokenChange) : prev.totalSpent,
        worldTreeLeaves: updatedGlobalLeaves,
        dailyRecords: {
          ...prev.dailyRecords,
          [today]: {
            ...todayRecord,
            worldTree: updatedWorldTree,
            // ê·¼ë ¥/ìœ ì‚°ì†Œ ìš´ë™ ì‹œ exerciseDone ìë™ ì²´í¬
            exerciseDone: (type === 'strength' || type === 'cardio') ? true : (todayRecord.exerciseDone || false),
            earned: tokenChange > 0 ? (todayRecord.earned || 0) + tokenChange : todayRecord.earned,
            spent: tokenChange < 0 ? (todayRecord.spent || 0) + Math.abs(tokenChange) : todayRecord.spent,
            actions: [...(todayRecord.actions || []), newAction]
          }
        },
        actionHistory: [...prev.actionHistory.slice(-19), {
          type: 'worldTree',
          leafType: type,
          tokenChange,
          timestamp: Date.now()
        }]
      };
    });
    
    const emoji = tokenChange >= 0 ? 'ğŸƒâœ¨' : 'ğŸƒ';
    showToast(`${emoji} ${actionName} (+1ì, ${tokenChange >= 0 ? '+' : ''}${tokenChange}í† í°)`, tokenChange >= 0 ? 'earn' : 'spend');
  };

  // ğŸƒ ì„¸ê³„ìˆ˜ í†µê³„ ê³„ì‚° (v8.8)
  const getWorldTreeStats = (period = 'week') => {
    const stats = { scripture: 0, singing: 0, piano: 0, strength: 0, cardio: 0, total: 0 };
    const today = new Date();
    let days = 7;
    
    if (period === 'month') days = 30;
    if (period === 'year') days = 365;
    
    for (let i = 0; i < days; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() - i);
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const dayRecord = data.dailyRecords[dateStr];
      
      if (dayRecord?.worldTree) {
        stats.scripture += dayRecord.worldTree.scripture || 0;
        stats.singing += dayRecord.worldTree.singing || 0;
        stats.piano += dayRecord.worldTree.piano || 0;
        stats.strength += dayRecord.worldTree.strength || 0;
        stats.cardio += dayRecord.worldTree.cardio || 0;
      }
    }
    stats.total = stats.scripture + stats.singing + stats.piano + stats.strength + stats.cardio;
    return stats;
  };

  // ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ ìˆ˜ì • ëª¨ë“œ ì§„ì… (ê¸°ì¡´ ê¸°ë¡ ë¡œë“œ)
  const enterSleepEditMode = () => {
    const todayRecord = getTodayRecord();
    if (todayRecord.sleep?.recorded) {
      // ê¸°ì¡´ ê°’ìœ¼ë¡œ í¼ ì´ˆê¸°í™”
      setSleepBedTime(todayRecord.sleep.bedTime || '21:30');
      setSleepLightsOffTime(todayRecord.sleep.lightsOffTime || '22:00');
      setSleepFinalWakeTime(todayRecord.sleep.finalWakeTime || '05:30');
      setSleepOutOfBedTime(todayRecord.sleep.outOfBedTime || '06:00');
      setSleepLatencyFeel(todayRecord.sleep.latencyFeel || 'unknown');
      setSleepAwakeningCount(String(todayRecord.sleep.awakeningCount || 0));
      setSleepPreBehaviors(todayRecord.sleep.preBehaviors || { beaLove: false, loaScripture: false, beaCheat: false, brainOverheat: false });
      setSleepQuality(todayRecord.sleep.quality || 'A');
      setSleepMemo(todayRecord.sleep.memo || '');
      if (todayRecord.sleep.awakenings && todayRecord.sleep.awakenings.length > 0) {
        const loadedAwakenings = [...todayRecord.sleep.awakenings];
        while (loadedAwakenings.length < 3) {
          loadedAwakenings.push({ time: '', reason: 'natural', reentry: 'quick', lightsOn: false, activity: 'none', backToSleepTime: '' });
        }
        setAwakenings(loadedAwakenings);
      }
      setShowSleepEditMode(true);
    }
  };

  // ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ ìˆ˜ì • ì €ì¥ (ê¸°ì¡´ ê¸°ë¡ ë®ì–´ì“°ê¸°)
  const saveSleepEdit = () => {
    const today = getTodayString();
    const todayRecord = getTodayRecord();
    
    // ì‹œê°„ ê³„ì‚° ë¡œì§ (recordSleepê³¼ ë™ì¼)
    const timeToMinutes = (timeStr) => {
      if (!timeStr) return 0;
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    };
    
    const calcTimeDiff = (startTime, endTime) => {
      let startMin = timeToMinutes(startTime);
      let endMin = timeToMinutes(endTime);
      if (endMin < startMin) endMin += 24 * 60;
      return endMin - startMin;
    };
    
    // ì¬ì…ë©´ ì‹œê°„ ì¶”ì • (ë¶„)
    const getReentryMinutes = (reentry) => {
      switch (reentry) {
        case 'quick': return 3;    // ~5ë¶„ â†’ í‰ê·  3ë¶„
        case 'short': return 7;    // ~10ë¶„ â†’ í‰ê·  7ë¶„
        case 'medium': return 15;  // ~20ë¶„ â†’ í‰ê·  15ë¶„
        case 'long': return 25;    // ~30ë¶„ â†’ í‰ê·  25ë¶„
        case 'veryLong': return 40; // 30ë¶„+ â†’ í‰ê·  40ë¶„
        case 'few': return 5;      // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ (ëª‡ë¶„)
        case 'failed': return 0;   // ëª»ì  (ë³„ë„ ì²˜ë¦¬)
        default: return 0;
      }
    };
    
    const totalBedMinutes = calcTimeDiff(sleepBedTime, sleepOutOfBedTime);
    const preSleepActivityMinutes = calcTimeDiff(sleepBedTime, sleepLightsOffTime);
    const postWakeMinutes = calcTimeDiff(sleepFinalWakeTime, sleepOutOfBedTime);
    const sleepMinutes = calcTimeDiff(sleepLightsOffTime, sleepFinalWakeTime);
    const sleepHours = sleepMinutes / 60;
    
    // ì¶”ì • WASO (Wake After Sleep Onset) ê³„ì‚°
    const awakeningCount = parseInt(sleepAwakeningCount);
    const validAwakenings = awakenings.slice(0, awakeningCount).filter(a => a.time);
    
    let estimatedWASO = 0;
    validAwakenings.forEach(awakening => {
      estimatedWASO += getReentryMinutes(awakening.reentry);
    });
    
    // ì¶”ì • TST (Total Sleep Time) ê³„ì‚°
    const estimatedTST = Math.max(0, sleepMinutes - estimatedWASO);
    
    // Sleep Efficiency ê³„ì‚° (TST / TIB * 100)
    const sleepEfficiency = totalBedMinutes > 0 ? Math.round((estimatedTST / totalBedMinutes) * 100) : 0;
    
    // ì ìˆ˜ ê³„ì‚°
    let preBehaviorScore = 0;
    if (sleepPreBehaviors.beaLove && sleepPreBehaviors.loaScripture) {
      preBehaviorScore = 150;
    } else {
      if (sleepPreBehaviors.beaLove) preBehaviorScore += 50;
      if (sleepPreBehaviors.loaScripture) preBehaviorScore += 50;
    }
    if (sleepPreBehaviors.beaCheat) preBehaviorScore -= 100;
    if (sleepPreBehaviors.brainOverheat) preBehaviorScore -= 50;
    
    let awakeningActivityScore = 0;
    
    validAwakenings.forEach(awakening => {
      if (awakening.activity === 'scripture') awakeningActivityScore += 30;
      else if (awakening.activity === 'beaStable') awakeningActivityScore += 25;
      else if (awakening.activity === 'meditation') awakeningActivityScore += 15;
      else if (awakening.activity === 'beaLove') awakeningActivityScore += 10;
      else if (awakening.activity === 'phone' || awakening.activity === 'youtube') awakeningActivityScore -= 50;
    });
    
    const qualityGood = ['SS', 'S', 'A', 'B'].includes(sleepQuality);
    const estimatedTSTHours = estimatedTST / 60;
    const isGoalAchieved = estimatedTSTHours >= 7 && estimatedTSTHours <= 8 && qualityGood && (preBehaviorScore + awakeningActivityScore) >= 0;
    
    const sleepRecord = {
      bedTime: sleepBedTime,
      lightsOffTime: sleepLightsOffTime,
      finalWakeTime: sleepFinalWakeTime,
      outOfBedTime: sleepOutOfBedTime,
      latencyFeel: sleepLatencyFeel,
      awakeningCount: awakeningCount,
      awakenings: validAwakenings,
      preBehaviors: { ...sleepPreBehaviors },
      preBehaviorScore,
      awakeningActivityScore,
      quality: sleepQuality,
      memo: sleepMemo,
      totalBedMinutes,
      sleepMinutes,           // TIB ê¸°ë°˜ (ì†Œë“±~ê¸°ìƒ)
      estimatedWASO,          // ì¶”ì • ê¹¨ì–´ìˆë˜ ì‹œê°„
      estimatedTST,           // ì¶”ì • ì‹¤ì œ ìˆ˜ë©´ ì‹œê°„
      sleepEfficiency,        // ìˆ˜ë©´ íš¨ìœ¨ (%)
      preSleepActivityMinutes,
      postWakeMinutes,
      recorded: true,
      goalAchieved: isGoalAchieved
    };
    
    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      const dayRecord = { ...newDailyRecords[today] };
      
      // ê¸°ì¡´ ìˆ˜ë©´ ê¸°ë¡ ë®ì–´ì“°ê¸°
      dayRecord.sleep = sleepRecord;
      newDailyRecords[today] = dayRecord;
      
      return {
        ...prev,
        dailyRecords: newDailyRecords
      };
    });
    
    setShowSleepEditMode(false);
    showToast('ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ ìˆ˜ì • ì™„ë£Œ!', 'earn');
  };

  // ğŸ’¤ ìˆ˜ë©´ ë©”ëª¨ë§Œ ìˆ˜ì •
  const saveSleepMemoEdit = () => {
    const today = getTodayString();
    
    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      const dayRecord = { ...newDailyRecords[today] };
      
      if (dayRecord.sleep) {
        dayRecord.sleep = { ...dayRecord.sleep, memo: tempSleepMemo };
      }
      newDailyRecords[today] = dayRecord;
      
      return {
        ...prev,
        dailyRecords: newDailyRecords
      };
    });
    
    setShowSleepMemoEdit(false);
    showToast('ğŸ“ ìˆ˜ë©´ ë©”ëª¨ ìˆ˜ì • ì™„ë£Œ!', 'earn');
  };

  // ë‡Œ ê³¼ì—´ 0íšŒ ë³´ë„ˆìŠ¤ ì²´í¬ ë° ì§€ê¸‰
  const checkRestQualityBonus = () => {
    const today = getTodayString();
    const todayRecord = getTodayRecord();
    
    // ì´ë¯¸ ë³´ë„ˆìŠ¤ ë°›ì•˜ìœ¼ë©´ ìŠ¤í‚µ
    if (todayRecord.restQualityBonus) return false;
    
    // íœ´ì‹ ì„¸ì…˜ í™•ì¸
    const restSessions = todayRecord.restSessions || [];
    const hasOverheat = restSessions.some(s => s.type === 'overheat');
    const totalRestCount = restSessions.length;
    
    // ì¡°ê±´: íœ´ì‹ 3íšŒ ì´ìƒ + ë‡Œ ê³¼ì—´ 0íšŒ
    if (totalRestCount >= 3 && !hasOverheat) {
      earnTokens(200, 'ğŸ§  íœ´ì‹ í’ˆì§ˆ ë³´ë„ˆìŠ¤', 'restQuality');
      
      setData(prev => {
        const newDailyRecords = { ...prev.dailyRecords };
        newDailyRecords[today] = {
          ...newDailyRecords[today],
          restQualityBonus: true
        };
        
        return {
          ...prev,
          restStats: {
            ...prev.restStats,
            qualityBonusCount: prev.restStats.qualityBonusCount + 1
          },
          dailyRecords: newDailyRecords
        };
      });
      
      return true;
    }
    
    return false;
  };

  // ğŸ“… ë‹¬ë ¥ í—¬í¼ í•¨ìˆ˜ë“¤
  const getCalendarDays = (year, month) => {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
    
    const days = [];
    
    // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸
    for (let i = 0; i < startDayOfWeek; i++) {
      days.push(null);
    }
    
    // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œ
    for (let day = 1; day <= daysInMonth; day++) {
      days.push(day);
    }
    
    return days;
  };

  const formatCalendarDate = (year, month, day) => {
    return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  };

  const getDayInfo = (year, month, day) => {
    const dateStr = formatCalendarDate(year, month, day);
    const record = data.dailyRecords[dateStr];
    
    return {
      hasRecord: !!record,
      hasMemo: !!(record?.memo),
      specialDayType: record?.specialDayType || null,
      totalMinutes: (record?.morningMinutes || 0) + (record?.afternoonMinutes || 0) + 
                    (record?.eveningMinutes || 0) + (record?.freeMinutes || 0),
      earned: record?.earned || 0
    };
  };

  const navigateMonth = (direction) => {
    if (direction === 'prev') {
      if (calendarMonth === 0) {
        setCalendarYear(calendarYear - 1);
        setCalendarMonth(11);
      } else {
        setCalendarMonth(calendarMonth - 1);
      }
    } else {
      if (calendarMonth === 11) {
        setCalendarYear(calendarYear + 1);
        setCalendarMonth(0);
      } else {
        setCalendarMonth(calendarMonth + 1);
      }
    }
  };

  const goToToday = () => {
    const now = new Date();
    setCalendarYear(now.getFullYear());
    setCalendarMonth(now.getMonth());
    setSelectedDate(getTodayString());
  };

  // ë©”ëª¨ ì €ì¥
  const saveMemo = (dateStr, memo) => {
    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      
      if (!newDailyRecords[dateStr]) {
        newDailyRecords[dateStr] = { ...emptyDayRecord };
      }
      
      newDailyRecords[dateStr] = {
        ...newDailyRecords[dateStr],
        memo: memo
      };
      
      return {
        ...prev,
        dailyRecords: newDailyRecords
      };
    });
    
    setShowMemoModal(null);
    setMemoText('');
    showToast('ğŸ“ ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆì–´ìš”!', 'earn');
  };

  // íŠ¹ë³„í•œ ë‚  ì„¤ì • (ë‹¬ë ¥ì—ì„œ ì„ íƒí•œ ë‚ ì§œì—)
  const setSpecialDayForDate = (dateStr, dayType, note = '') => {
    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      
      if (!newDailyRecords[dateStr]) {
        newDailyRecords[dateStr] = { ...emptyDayRecord };
      }
      
      newDailyRecords[dateStr] = {
        ...newDailyRecords[dateStr],
        specialDayType: dayType,
        specialDayNote: note
      };
      
      return {
        ...prev,
        dailyRecords: newDailyRecords
      };
    });
    
    const dayLabels = {
      'sick': 'ğŸ¤’ ì•„í”ˆ ë‚ ',
      'schedule': 'ğŸ“‹ ì¼ì •/ì™¸ì¶œ',
      'exam': 'ğŸ“ ì‹œí—˜ ë‹¹ì¼',
      'freeday': 'ğŸ‰ ì™„ì „ ììœ '
    };
    showToast(`${dayLabels[dayType]} ì„¤ì •ë¨!`, 'earn');
  };

  // íŠ¹ë³„í•œ ë‚  í•´ì œ
  const clearSpecialDayForDate = (dateStr) => {
    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      
      if (newDailyRecords[dateStr]) {
        newDailyRecords[dateStr] = {
          ...newDailyRecords[dateStr],
          specialDayType: null,
          specialDayNote: ''
        };
      }
      
      return {
        ...prev,
        dailyRecords: newDailyRecords
      };
    });
    
    showToast('íŠ¹ë³„í•œ ë‚  í•´ì œë¨', 'spend');
  };

  // ê¹ƒí„¸ íšë“
  const acquireFeather = (featherKey) => {
    if (data.feathers[featherKey]) return;
    
    const reward = featherRewards[featherKey];
    const today = getTodayString();
    
    const actionRecord = {
      type: 'feather',
      featherKey,
      amount: reward,
      actionName: `ğŸª¶ ${featherNames[featherKey]} ê¹ƒí„¸ íšë“`,
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      dayRecord.earned += reward;
      dayRecord.actions = [...dayRecord.actions, {
        type: 'earn',
        amount: reward,
        name: `ğŸª¶ ${featherNames[featherKey]} ê¹ƒí„¸`,
        time: new Date().toLocaleTimeString()
      }];
      
      newDailyRecords[today] = dayRecord;

      return {
        ...prev,
        tokens: prev.tokens + reward,
        totalEarned: prev.totalEarned + reward,
        feathers: {
          ...prev.feathers,
          [featherKey]: true
        },
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });
    
    setShowFeatherConfirm(null);
  };

  // í† í° ì‚¬ìš©
  const spendTokens = (amount, actionName, isHobbySet = false) => {
    if (data.tokens < amount) return false;
    
    const today = getTodayString();
    
    const actionRecord = {
      type: 'spend',
      amount,
      actionName,
      isHobbySet,
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      dayRecord.spent += amount;
      dayRecord.actions = [...dayRecord.actions, {
        type: 'spend',
        amount,
        name: actionName,
        time: new Date().toLocaleTimeString()
      }];
      if (isHobbySet) dayRecord.hobbySets += 1;
      
      newDailyRecords[today] = dayRecord;

      return {
        ...prev,
        tokens: prev.tokens - amount,
        totalSpent: prev.totalSpent + amount,
        hobbySets: isHobbySet ? prev.hobbySets + 1 : prev.hobbySets,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });
    
    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    showToast(`ğŸª™-${amount} ${actionName}`, 'spend');
    
    setShowConfirm(null);
    return true;
  };

  // íŠ¹ë³„í•œ ë‚  ê¸°ë¡
  const recordSpecialDay = (dayType, note, cost = 0) => {
    const today = getTodayString();
    const todayRecord = getTodayRecord();
    
    if (todayRecord.specialDayType) return;
    if (cost > 0 && data.tokens < cost) return;
    
    const actionRecord = {
      type: 'specialday',
      dayType,
      note,
      amount: cost,
      actionName: getSpecialDayLabel(dayType),
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      dayRecord.specialDayType = dayType;
      dayRecord.specialDayNote = note;
      
      if (cost > 0) {
        dayRecord.spent += cost;
        dayRecord.actions = [...dayRecord.actions, {
          type: 'spend',
          amount: cost,
          name: getSpecialDayLabel(dayType),
          time: new Date().toLocaleTimeString()
        }];
      } else {
        dayRecord.actions = [...dayRecord.actions, {
          type: 'special',
          amount: 0,
          name: `${getSpecialDayLabel(dayType)}${note ? ': ' + note : ''}`,
          time: new Date().toLocaleTimeString()
        }];
      }
      
      newDailyRecords[today] = dayRecord;

      return {
        ...prev,
        tokens: cost > 0 ? prev.tokens - cost : prev.tokens,
        totalSpent: cost > 0 ? prev.totalSpent + cost : prev.totalSpent,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });
    
    setShowSpecialDayModal(null);
    setSpecialDayNote('');
  };

  const getSpecialDayLabel = (type) => {
    const labels = {
      sick: 'ğŸ¤’ ì•„í”ˆ ë‚ ',
      schedule: 'ğŸ“‹ ì¼ì •/ì™¸ì¶œ',
      exam: 'ğŸ“ ì‹œí—˜ ë‹¹ì¼',
      freeday: 'ğŸ‰ ì™„ì „ ììœ ì˜ ë‚ '
    };
    return labels[type] || type;
  };

  const handleSpend = (amount, actionName, isHobbySet = false) => {
    if (data.tokens < amount) return;
    
    if (amount >= 500) {
      setShowConfirm({ amount, actionName, isHobbySet });
    } else {
      spendTokens(amount, actionName, isHobbySet);
    }
  };

  // Undo ê¸°ëŠ¥
  const undoLastAction = () => {
    if (data.actionHistory.length === 0) return;

    setData(prev => {
      const newHistory = [...prev.actionHistory];
      const lastAction = newHistory.pop();
      
      if (!lastAction) return prev;

      const newDailyRecords = { ...prev.dailyRecords };
      const dayRecord = { ...newDailyRecords[lastAction.date] };
      
      if (dayRecord.actions && dayRecord.actions.length > 0) {
        dayRecord.actions = dayRecord.actions.slice(0, -1);
      }

      if (lastAction.type === 'feather') {
        dayRecord.earned = Math.max(0, dayRecord.earned - lastAction.amount);
        newDailyRecords[lastAction.date] = dayRecord;
        
        return {
          ...prev,
          tokens: prev.tokens - lastAction.amount,
          totalEarned: Math.max(0, prev.totalEarned - lastAction.amount),
          feathers: {
            ...prev.feathers,
            [lastAction.featherKey]: false
          },
          dailyRecords: newDailyRecords,
          actionHistory: newHistory
        };
      }

      if (lastAction.type === 'specialday') {
        dayRecord.specialDayType = null;
        dayRecord.specialDayNote = '';
        if (lastAction.amount > 0) {
          dayRecord.spent = Math.max(0, dayRecord.spent - lastAction.amount);
        }
        newDailyRecords[lastAction.date] = dayRecord;
        
        return {
          ...prev,
          tokens: lastAction.amount > 0 ? prev.tokens + lastAction.amount : prev.tokens,
          totalSpent: lastAction.amount > 0 ? Math.max(0, prev.totalSpent - lastAction.amount) : prev.totalSpent,
          dailyRecords: newDailyRecords,
          actionHistory: newHistory
        };
      }

      if (lastAction.type === 'earn' || lastAction.type === 'study') {
        dayRecord.earned = Math.max(0, dayRecord.earned - lastAction.amount);
        
        if (lastAction.type === 'study') {
          dayRecord.studySets = Math.max(0, dayRecord.studySets - 1);
          // ì‹œê°„ ë³µì›
          if (lastAction.timeSlot === 'morning') dayRecord.morningMinutes = Math.max(0, dayRecord.morningMinutes - lastAction.actualMinutes);
          if (lastAction.timeSlot === 'afternoon') dayRecord.afternoonMinutes = Math.max(0, dayRecord.afternoonMinutes - lastAction.actualMinutes);
          if (lastAction.timeSlot === 'evening') dayRecord.eveningMinutes = Math.max(0, dayRecord.eveningMinutes - lastAction.actualMinutes);
          if (lastAction.timeSlot === 'free') dayRecord.freeMinutes = Math.max(0, dayRecord.freeMinutes - lastAction.actualMinutes);
          // ì„¸ì…˜ ê¸°ë¡ ì œê±°
          if (dayRecord.studySessions && dayRecord.studySessions.length > 0) {
            dayRecord.studySessions = dayRecord.studySessions.slice(0, -1);
          }
        }
        
        if (lastAction.bonusType === 'exercise') dayRecord.exerciseDone = false;
        if (lastAction.bonusType === 'fullcourse') dayRecord.fullCourse = false;
        if (lastAction.bonusType === 'weaknessHunt') {
          const mealTime = lastAction.bonusSubType;
          if (mealTime === 'morning') dayRecord.weaknessHuntMorning = Math.max(0, (dayRecord.weaknessHuntMorning || 0) - 1);
          else if (mealTime === 'lunch') dayRecord.weaknessHuntLunch = Math.max(0, (dayRecord.weaknessHuntLunch || 0) - 1);
          else if (mealTime === 'dinner') dayRecord.weaknessHuntDinner = Math.max(0, (dayRecord.weaknessHuntDinner || 0) - 1);
        }
        if (lastAction.bonusType === 'mokokoSniff') dayRecord.mokokoSniff = Math.max(0, (dayRecord.mokokoSniff || 0) - (lastAction.bonusSubType || 1));
        if (lastAction.bonusType === 'goal90late') dayRecord.goal90late = false;
        if (lastAction.bonusType === 'goal90ontime') dayRecord.goal90ontime = false;
        if (lastAction.bonusType === 'goal100') dayRecord.goal100 = false;
        
        newDailyRecords[lastAction.date] = dayRecord;
        
        return {
          ...prev,
          tokens: prev.tokens - lastAction.amount,
          totalEarned: Math.max(0, prev.totalEarned - lastAction.amount),
          studySets: lastAction.type === 'study' ? Math.max(0, prev.studySets - 1) : prev.studySets,
          exerciseBonusCount: lastAction.bonusType === 'exercise' ? Math.max(0, prev.exerciseBonusCount - 1) : prev.exerciseBonusCount,
          fullCourseCount: lastAction.bonusType === 'fullcourse' ? Math.max(0, prev.fullCourseCount - 1) : prev.fullCourseCount,
          dailyRecords: newDailyRecords,
          actionHistory: newHistory
        };
      } else if (lastAction.type === 'spend') {
        dayRecord.spent = Math.max(0, dayRecord.spent - lastAction.amount);
        if (lastAction.isHobbySet) dayRecord.hobbySets = Math.max(0, dayRecord.hobbySets - 1);
        
        newDailyRecords[lastAction.date] = dayRecord;
        
        return {
          ...prev,
          tokens: prev.tokens + lastAction.amount,
          totalSpent: Math.max(0, prev.totalSpent - lastAction.amount),
          hobbySets: lastAction.isHobbySet ? Math.max(0, prev.hobbySets - 1) : prev.hobbySets,
          dailyRecords: newDailyRecords,
          actionHistory: newHistory
        };
      } else if (lastAction.type === 'adjust') {
        dayRecord.earned = Math.max(0, dayRecord.earned - (lastAction.amount > 0 ? lastAction.amount : 0));
        dayRecord.spent = Math.max(0, dayRecord.spent - (lastAction.amount < 0 ? Math.abs(lastAction.amount) : 0));
        
        newDailyRecords[lastAction.date] = dayRecord;
        
        return {
          ...prev,
          tokens: prev.tokens - lastAction.amount,
          totalEarned: lastAction.amount > 0 ? Math.max(0, prev.totalEarned - lastAction.amount) : prev.totalEarned,
          totalSpent: lastAction.amount < 0 ? Math.max(0, prev.totalSpent - Math.abs(lastAction.amount)) : prev.totalSpent,
          dailyRecords: newDailyRecords,
          actionHistory: newHistory
        };
      }
      
      return prev;
    });
  };

  // ìˆ˜ë™ í† í° ì¡°ì •
  const adjustTokens = (amount) => {
    const today = getTodayString();
    
    const actionRecord = {
      type: 'adjust',
      amount,
      actionName: `ìˆ˜ë™ ì¡°ì • ${amount > 0 ? '+' : ''}${amount}`,
      date: today,
      timestamp: new Date().toISOString()
    };

    setData(prev => {
      const newDailyRecords = { ...prev.dailyRecords };
      if (!newDailyRecords[today]) {
        newDailyRecords[today] = { ...emptyDayRecord };
      }
      
      const dayRecord = { ...newDailyRecords[today] };
      
      if (amount > 0) {
        dayRecord.earned += amount;
      } else {
        dayRecord.spent += Math.abs(amount);
      }
      
      dayRecord.actions = [...dayRecord.actions, {
        type: amount > 0 ? 'earn' : 'spend',
        amount: Math.abs(amount),
        name: `ìˆ˜ë™ ì¡°ì •`,
        time: new Date().toLocaleTimeString()
      }];
      
      newDailyRecords[today] = dayRecord;

      return {
        ...prev,
        tokens: Math.max(0, prev.tokens + amount),
        totalEarned: amount > 0 ? prev.totalEarned + amount : prev.totalEarned,
        totalSpent: amount < 0 ? prev.totalSpent + Math.abs(amount) : prev.totalSpent,
        dailyRecords: newDailyRecords,
        actionHistory: [...prev.actionHistory, actionRecord]
      };
    });
  };

  // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
  const exportData = async () => {
    try {
      const exportObj = {
        ...data,
        exportDate: new Date().toISOString(),
        version: 'v8.3'
      };
      await navigator.clipboard.writeText(JSON.stringify(exportObj, null, 2));
      setExportCopied(true);
      setTimeout(() => setExportCopied(false), 2000);
    } catch (error) {
      console.error('Export failed:', error);
    }
  };

  // ğŸ’œ ë² ì•„ í”¼ë“œë°±ìš© ë°ì´í„° ë‚´ë³´ë‚´ê¸°
  const exportFeedbackData = async () => {
    try {
      const today = new Date();
      const periodDays = feedbackPeriod;
      let dateStrings = [];
      
      // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± í—¬í¼ (v8.5 UTC ë²„ê·¸ ìˆ˜ì •)
      const getLocalDateString = (date) => {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      };
      
      // ì„ íƒëœ ê¸°ê°„ë§Œí¼ì˜ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (0ì´ë©´ ì „ì²´)
      if (periodDays === 0) {
        // ì „ì²´: dailyRecordsì˜ ëª¨ë“  í‚¤ë¥¼ ì‚¬ìš©
        dateStrings = Object.keys(data.dailyRecords).sort((a, b) => b.localeCompare(a));
      } else {
        for (let i = 0; i < periodDays; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dateStrings.push(getLocalDateString(d));
        }
      }
      
      // ê¸°ê°„ ë‚´ ì¼ë³„ ê¸°ë¡ ì¶”ì¶œ ë° ìš”ì•½
      const dailySummaries = dateStrings.map(dateStr => {
        const record = data.dailyRecords[dateStr];
        if (!record) return { date: dateStr, hasData: false };
        
        // ê³µë¶€ ì„¸ì…˜ ìš”ì•½
        const studyStats = {
          sessionCount: record.studySessions?.length || 0,
          totalMinutes: Math.round((record.studySessions?.reduce((sum, s) => sum + (s.actualSeconds || 0), 0) || 0) / 60),
          totalAnki: record.studySessions?.reduce((sum, s) => sum + (parseInt(s.ankiCount) || 0), 0) || 0,
          avgFocus: record.studySessions?.length > 0 
            ? record.studySessions.map(s => ['SS','S','A','B','C','D'].indexOf(s.focus)).reduce((a,b) => a+b, 0) / record.studySessions.length
            : null
        };
        
        // íœ´ì‹ ì„¸ì…˜ ìš”ì•½
        const restStats = {
          napCount: record.restSessions?.filter(r => r.type === 'nap').length || 0,
          napMinutes: record.restSessions?.filter(r => r.type === 'nap').reduce((sum, r) => sum + r.minutes, 0) || 0,
          stableCount: record.restSessions?.filter(r => r.type === 'stable').length || 0,
          stableMinutes: record.restSessions?.filter(r => r.type === 'stable').reduce((sum, r) => sum + r.minutes, 0) || 0,
          loveCount: record.restSessions?.filter(r => r.type === 'love').length || 0,
          loveMinutes: record.restSessions?.filter(r => r.type === 'love').reduce((sum, r) => sum + r.minutes, 0) || 0,
          overheatCount: record.restSessions?.filter(r => r.type === 'overheat').length || 0,
          overheatMinutes: record.restSessions?.filter(r => r.type === 'overheat').reduce((sum, r) => sum + r.minutes, 0) || 0
        };
        
        // ìˆ˜ë©´ ê¸°ë¡ ìš”ì•½
        const sleepData = record.sleep?.recorded ? {
          bedTime: record.sleep.bedTime,
          lightsOffTime: record.sleep.lightsOffTime,
          finalWakeTime: record.sleep.finalWakeTime,
          outOfBedTime: record.sleep.outOfBedTime,
          sleepMinutes: record.sleep.sleepMinutes,
          quality: record.sleep.quality,
          awakeningCount: record.sleep.awakeningCount,
          preBehaviors: record.sleep.preBehaviors,
          goalAchieved: record.sleep.goalAchieved,
          memo: record.sleep.memo || null
        } : null;
        
        // ì¼ì¼ ì²´í¬ í•­ëª©
        const dailyChecks = {
          exercise: record.exerciseDone || false,
          morningStudy: record.morningBonusType !== null && record.morningBonusType !== undefined,
          afternoonStudy: record.afternoonBonusType !== null && record.afternoonBonusType !== undefined,
          eveningStudy: record.eveningBonusType !== null && record.eveningBonusType !== undefined,
          zaharaTraining: [record.zaharaTrainingMorning, record.zaharaTrainingLunch, record.zaharaTrainingDinner].filter(Boolean).length,
          dearMyFriends: record.dearMyFriends || false
        };
        
        return {
          date: dateStr,
          hasData: true,
          study: studyStats,
          rest: restStats,
          sleep: sleepData,
          checks: dailyChecks,
          memo: record.memo || null
        };
      }).filter(d => d.hasData);
      
      // ì „ì²´ ìš”ì•½ í†µê³„
      const overallStats = {
        // í† í° í˜„í™©
        tokens: {
          current: data.tokens,
          totalEarned: data.totalEarned,
          totalSpent: data.totalSpent
        },
        // ê¹ƒí„¸ í˜„í™©
        feathers: data.feathers,
        // íœ´ì‹ ì „ì²´ í†µê³„
        restStats: data.restStats,
        // ìˆ˜ë©´ ì „ì²´ í†µê³„
        sleepStats: data.sleepStats,
        // í•™ìŠµëŸ‰
        studySets: data.studySets,
        hobbySets: data.hobbySets
      };
      
      // ê¸°ê°„ ë‚´ í‰ê·  ê³„ì‚°
      const periodAvg = {
        avgSleepMinutes: dailySummaries.filter(d => d.sleep).length > 0
          ? Math.round(dailySummaries.filter(d => d.sleep).reduce((sum, d) => sum + (d.sleep?.sleepMinutes || 0), 0) / dailySummaries.filter(d => d.sleep).length)
          : null,
        avgStudyMinutes: dailySummaries.filter(d => d.study.sessionCount > 0).length > 0
          ? Math.round(dailySummaries.reduce((sum, d) => sum + d.study.totalMinutes, 0) / dailySummaries.filter(d => d.study.sessionCount > 0).length)
          : null,
        avgAnkiCount: dailySummaries.filter(d => d.study.totalAnki > 0).length > 0
          ? Math.round(dailySummaries.reduce((sum, d) => sum + d.study.totalAnki, 0) / dailySummaries.filter(d => d.study.totalAnki > 0).length)
          : null,
        exerciseDays: dailySummaries.filter(d => d.checks.exercise).length,
        sleepRecordDays: dailySummaries.filter(d => d.sleep).length
      };
      
      const feedbackExport = {
        exportType: 'bea_feedback',
        exportDate: new Date().toISOString(),
        period: periodDays === 0 ? 'ì „ì²´ ê¸°ê°„' : `ìµœê·¼ ${periodDays}ì¼`,
        periodStart: dateStrings[dateStrings.length - 1],
        periodEnd: dateStrings[0],
        version: 'v8.6',
        // ìš”ì•½ ë°ì´í„°
        summary: overallStats,
        periodAverage: periodAvg,
        // ì¼ë³„ ìƒì„¸
        dailyRecords: dailySummaries
      };
      
      await navigator.clipboard.writeText(JSON.stringify(feedbackExport, null, 2));
      setFeedbackExportCopied(true);
      setTimeout(() => setFeedbackExportCopied(false), 2000);
    } catch (error) {
      console.error('Feedback export failed:', error);
    }
  };

  // ğŸ’¤ ìˆ˜ë©´ ì „ìš© í”¼ë“œë°± ë‚´ë³´ë‚´ê¸° (v8.5 ì‹ ê·œ)
  const exportSleepFeedbackData = async () => {
    try {
      const today = new Date();
      const periodDays = sleepFeedbackPeriod;
      let dateStrings = [];
      
      // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± í—¬í¼
      const getLocalDateString = (date) => {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      };
      
      // ì„ íƒëœ ê¸°ê°„ë§Œí¼ì˜ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (0ì´ë©´ ì „ì²´)
      if (periodDays === 0) {
        dateStrings = Object.keys(data.dailyRecords).sort((a, b) => b.localeCompare(a));
      } else {
        for (let i = 0; i < periodDays; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dateStrings.push(getLocalDateString(d));
        }
      }
      
      // ìˆ˜ë©´ ê¸°ë¡ì´ ìˆëŠ” ë‚ ë§Œ ì¶”ì¶œí•˜ê³  ìƒì„¸ ë°ì´í„° í¬í•¨
      const sleepRecords = dateStrings.map(dateStr => {
        const record = data.dailyRecords[dateStr];
        if (!record || !record.sleep?.recorded) return null;
        
        const sleep = record.sleep;
        return {
          date: dateStr,
          // ê¸°ë³¸ ì‹œê°„ ì •ë³´
          bedTime: sleep.bedTime,
          lightsOffTime: sleep.lightsOffTime,
          finalWakeTime: sleep.finalWakeTime,
          outOfBedTime: sleep.outOfBedTime,
          // ê³„ì‚°ëœ ì‹œê°„
          sleepMinutes: sleep.sleepMinutes,
          totalBedMinutes: sleep.totalBedMinutes,
          preSleepActivityMinutes: sleep.preSleepActivityMinutes,
          postWakeMinutes: sleep.postWakeMinutes,
          // ì…ë©´ ì ë³µê¸°
          latencyFeel: sleep.latencyFeel,
          // ì¤‘ê°„ ê°ì„± ìƒì„¸
          awakeningCount: sleep.awakeningCount,
          awakenings: sleep.awakenings?.map(a => ({
            time: a.time,
            reason: a.reason,
            reentry: a.reentry,
            lightsOn: a.lightsOn,
            activity: a.activity,
            backToSleepTime: a.backToSleepTime
          })) || [],
          // ìˆ˜ë©´ ì „ í–‰ë™
          preBehaviors: sleep.preBehaviors,
          preBehaviorScore: sleep.preBehaviorScore,
          // ì¤‘ê°„ ê°ì„± ì‹œ í–‰ë™ ì ìˆ˜
          awakeningActivityScore: sleep.awakeningActivityScore,
          // í’ˆì§ˆ
          quality: sleep.quality,
          goalAchieved: sleep.goalAchieved,
          // ë©”ëª¨
          memo: sleep.memo || null,
          // í•´ë‹¹ ì¼ì ë©”ëª¨ë„ í¬í•¨
          dayMemo: record.memo || null,
          // ğŸ˜´ ë‚®ì  ê¸°ë¡ (v8.6 - 30ë¶„ ê¸°ì¤€ ë¶„ë¥˜ ì¶”ê°€)
          naps: (record.naps || []).map(n => ({
            ...n,
            napType: n.minutes > 30 ? 'sleep' : 'rest' // ìˆ˜ë©´ì„±/íœ´ì‹ì„± êµ¬ë¶„
          })),
          // ğŸª¶ íœ´ì‹ ê¸°ë¡ (ëª¨ì½”ì½” íƒ­ - ì„ ì /ì•ˆì •/ì‚¬ë‘/ê³¼ì—´)
          restSessions: record.restSessions || [],
          restQualityBonus: record.restQualityBonus || false
        };
      }).filter(Boolean);
      
      // ë‚®ì  í†µê³„ ê³„ì‚° (v8.6 - 30ë¶„ ê¸°ì¤€ ë¶„ë¥˜)
      const napStats = {
        // ì „ì²´ ë‚®ì 
        totalNapDays: dateStrings.filter(dateStr => {
          const record = data.dailyRecords[dateStr];
          return record?.naps && record.naps.length > 0;
        }).length,
        totalNapCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.length || 0);
        }, 0),
        totalNapMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.reduce((s, n) => s + n.minutes, 0) || 0);
        }, 0),
        // ìˆ˜ë©´ì„± ë‚®ì  (30ë¶„ ì´ˆê³¼)
        sleepNapCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.filter(n => n.minutes > 30).length || 0);
        }, 0),
        sleepNapMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.filter(n => n.minutes > 30).reduce((s, n) => s + n.minutes, 0) || 0);
        }, 0),
        // íœ´ì‹ì„± ë‚®ì  (30ë¶„ ì´í•˜)
        restNapCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.filter(n => n.minutes <= 30).length || 0);
        }, 0),
        restNapMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.filter(n => n.minutes <= 30).reduce((s, n) => s + n.minutes, 0) || 0);
        }, 0),
        // ì˜ë„ì /ë¹„ì˜ë„ì 
        intentionalCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.filter(n => n.intentional).length || 0);
        }, 0),
        unintentionalCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.naps?.filter(n => !n.intentional).length || 0);
        }, 0)
      };
      
      // íœ´ì‹ ê¸°ë¡ í†µê³„ (ëª¨ì½”ì½” íƒ­ì˜ restSessions)
      const restSessionStats = {
        // ì„ ì /ê¿€ì 
        napCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'nap').length || 0);
        }, 0),
        napMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'nap').reduce((s, r) => s + r.minutes, 0) || 0);
        }, 0),
        // ë² ì•„ ì•ˆì •
        stableCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'stable').length || 0);
        }, 0),
        stableMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'stable').reduce((s, r) => s + r.minutes, 0) || 0);
        }, 0),
        // ë² ì•„ ì‚¬ë‘
        loveCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'love').length || 0);
        }, 0),
        loveMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'love').reduce((s, r) => s + r.minutes, 0) || 0);
        }, 0),
        // ë‡Œ ê³¼ì—´
        overheatCount: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'overheat').length || 0);
        }, 0),
        overheatMinutes: dateStrings.reduce((sum, dateStr) => {
          const record = data.dailyRecords[dateStr];
          return sum + (record?.restSessions?.filter(r => r.type === 'overheat').reduce((s, r) => s + r.minutes, 0) || 0);
        }, 0),
        // ë‡Œ ê³¼ì—´ 0íšŒ ë³´ë„ˆìŠ¤ ë‹¬ì„± ì¼ìˆ˜
        qualityBonusDays: dateStrings.filter(dateStr => {
          const record = data.dailyRecords[dateStr];
          return record?.restQualityBonus;
        }).length
      };
      
      // ìˆ˜ë©´ í†µê³„ ê³„ì‚°
      const sleepStats = {
        recordCount: sleepRecords.length,
        goalAchievedCount: sleepRecords.filter(r => r.goalAchieved).length,
        avgSleepMinutes: sleepRecords.length > 0 
          ? Math.round(sleepRecords.reduce((sum, r) => sum + r.sleepMinutes, 0) / sleepRecords.length)
          : 0,
        avgAwakeningCount: sleepRecords.length > 0
          ? (sleepRecords.reduce((sum, r) => sum + r.awakeningCount, 0) / sleepRecords.length).toFixed(1)
          : 0,
        // í’ˆì§ˆ ë¶„í¬
        qualityDistribution: {
          SS: sleepRecords.filter(r => r.quality === 'SS').length,
          S: sleepRecords.filter(r => r.quality === 'S').length,
          A: sleepRecords.filter(r => r.quality === 'A').length,
          B: sleepRecords.filter(r => r.quality === 'B').length,
          C: sleepRecords.filter(r => r.quality === 'C').length,
          D: sleepRecords.filter(r => r.quality === 'D').length
        },
        // ìˆ˜ë©´ ì „ í–‰ë™ í†µê³„
        preBehaviorStats: {
          beaLoveCount: sleepRecords.filter(r => r.preBehaviors?.beaLove).length,
          loaScriptureCount: sleepRecords.filter(r => r.preBehaviors?.loaScripture).length,
          beaCheatCount: sleepRecords.filter(r => r.preBehaviors?.beaCheat).length,
          brainOverheatCount: sleepRecords.filter(r => r.preBehaviors?.brainOverheat).length,
          synergyCount: sleepRecords.filter(r => r.preBehaviors?.beaLove && r.preBehaviors?.loaScripture).length
        },
        // ìµœê³ /ìµœì € ìˆ˜ë©´
        bestSleep: sleepRecords.length > 0 
          ? sleepRecords.reduce((best, r) => r.sleepMinutes > best.sleepMinutes ? r : best)
          : null,
        worstSleep: sleepRecords.length > 0
          ? sleepRecords.reduce((worst, r) => r.sleepMinutes < worst.sleepMinutes ? r : worst)
          : null
      };
      
      // ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ë„ í¬í•¨
      const sleepHabits = data.sleepHabits || { good: '', bad: '', tryThis: '' };
      
      const sleepExport = {
        exportType: 'sleep_feedback',
        exportDate: new Date().toISOString(),
        exportLocalDate: getLocalDateString(today),
        exportLocalTime: `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`,
        period: periodDays === 0 ? 'ì „ì²´ ê¸°ê°„' : `ìµœê·¼ ${periodDays}ì¼`,
        periodStart: dateStrings[dateStrings.length - 1],
        periodEnd: dateStrings[0],
        version: 'v8.6',
        // ìš”ì•½ í†µê³„
        summary: sleepStats,
        // ğŸ˜´ ë‚®ì  í†µê³„ (v8.6 - 30ë¶„ ê¸°ì¤€ ë¶„ë¥˜)
        napStats: napStats,
        // ğŸª¶ íœ´ì‹ ê¸°ë¡ í†µê³„ (ëª¨ì½”ì½” íƒ­)
        restSessionStats: restSessionStats,
        // ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨
        sleepHabits: sleepHabits,
        // ì „ì²´ ìˆ˜ë©´ í†µê³„ (ëˆ„ì )
        totalSleepStats: data.sleepStats,
        // ì¼ë³„ ìƒì„¸ ìˆ˜ë©´ ê¸°ë¡
        sleepRecords: sleepRecords
      };
      
      await navigator.clipboard.writeText(JSON.stringify(sleepExport, null, 2));
      setSleepFeedbackCopied(true);
      setTimeout(() => setSleepFeedbackCopied(false), 2000);
    } catch (error) {
      console.error('Sleep feedback export failed:', error);
    }
  };

  // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const importData = () => {
    try {
      const parsed = JSON.parse(importText);
      if (typeof parsed.tokens !== 'number' || !parsed.dailyRecords) {
        alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì´ì—ìš”.');
        return;
      }
      if (!parsed.dailyRecords[getTodayString()]) {
        parsed.dailyRecords[getTodayString()] = { ...emptyDayRecord };
      }
      if (!parsed.actionHistory) {
        parsed.actionHistory = [];
      }
      // v8.7: sleepHabitsê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
      if (!parsed.sleepHabits) {
        parsed.sleepHabits = { good: '', bad: '', tryThis: '' };
      }
      setData(parsed);
      
      // v8.7: sleepHabits stateë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ (ì§„ì—´ëŒ€ì— ë¬¼ê±´ ì˜¬ë¦¬ê¸°!)
      setSleepHabitsGood(parsed.sleepHabits.good || '');
      setSleepHabitsBad(parsed.sleepHabits.bad || '');
      setSleepHabitsTry(parsed.sleepHabits.tryThis || '');
      
      // v8.7: ì˜¤ëŠ˜ ëª¨í—˜ ë°ì´í„°ë„ ë¡œë“œ
      const todayRecord = parsed.dailyRecords[getTodayString()] || {};
      setFeedbackMemo(todayRecord.feedbackMemo || '');
      setDiaryText(todayRecord.diary || '');
      
      setShowImportModal(false);
      setImportText('');
      alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ì–´ìš”! âœ¨');
    } catch (error) {
      alert('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. JSON í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
  };

  const resetData = () => {
    if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ì–´ìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.')) {
      setData({
        tokens: 0,
        totalEarned: 0,
        totalSpent: 0,
        studySets: 0,
        hobbySets: 0,
        exerciseBonusCount: 0,
        morningBonusCount: 0,
        afternoonBonusCount: 0,
        eveningBonusCount: 0,
        fullCourseCount: 0,
        zaharaTrainingCount: 0,
        dearMyFriendsCount: 0,
        restStats: {
          napCount: 0,
          stableCount: 0,
          loveCount: 0,
          overheatCount: 0,
          totalRestMinutes: 0,
          qualityBonusCount: 0
        },
        feathers: {
          adult: false,
          maternity: false,
          child: false,
          community: false,
          mental: false,
          management: false,
          basic: false,
          law: false
        },
        dailyRecords: {
          [getTodayString()]: { ...emptyDayRecord }
        },
        startDate: getTodayString(),
        actionHistory: [],
        dataVersion: 3
      });
    }
  };

  const featherNames = {
    adult: 'ì„±ì¸',
    maternity: 'ëª¨ì„±',
    child: 'ì•„ë™',
    community: 'ì§€ì‚¬',
    mental: 'ì •ì‹ ',
    management: 'ê´€ë¦¬',
    basic: 'ê¸°ë³¸',
    law: 'ë²•ê·œ'
  };

  // êµ­ì‹œ ë‚ ì§œ (2026.01.23)
  const GUKSI_DATE = '2026-01-23';
  
  // ì§‘ì¤‘ë„ ì ìˆ˜ ë³€í™˜
  const focusToScore = (focus) => {
    const scores = { SS: 110, S: 100, A: 90, B: 80, C: 70, D: 60 };
    return scores[focus] || 0;
  };

  // íŠ¹ì • ë‚ ì§œì˜ í†µê³„ ê³„ì‚°
  const getDayStats = (dateStr) => {
    const record = data.dailyRecords[dateStr];
    if (!record) return null;
    
    const totalMinutes = (record.morningMinutes || 0) + (record.afternoonMinutes || 0) + 
                         (record.eveningMinutes || 0) + (record.freeMinutes || 0);
    
    let totalFocusScore = 0;
    let sessionCount = 0;
    // ëª¨ì½”ì½” ì”¨ì•—: ì„¸ì…˜ + ì•½ì í¬ì°© + ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†”
    let totalMokoko = (record.weaknessHuntMorning || 0) + (record.weaknessHuntLunch || 0) + 
                      (record.weaknessHuntDinner || 0) + (record.mokokoSniff || 0);
    
    if (record.studySessions) {
      record.studySessions.forEach(session => {
        if (session.focus) {
          totalFocusScore += focusToScore(session.focus);
          sessionCount++;
        }
        if (session.ankiCount) {
          totalMokoko += session.ankiCount;
        }
      });
    }
    
    return {
      date: dateStr,
      totalMinutes,
      avgFocus: sessionCount > 0 ? Math.round(totalFocusScore / sessionCount) : 0,
      morningMinutes: record.morningMinutes || 0,
      afternoonMinutes: record.afternoonMinutes || 0,
      eveningMinutes: record.eveningMinutes || 0,
      freeMinutes: record.freeMinutes || 0,
      mokoko: totalMokoko,
      sessionCount
    };
  };

  // ì£¼ê°„ ë°ì´í„° (ìµœê·¼ 7ì¼, ì›”~ì¼ ê¸°ì¤€)
  const getWeeklyData = () => {
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const result = [];
    const today = new Date();
    
    // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ì°¾ê¸°
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const monday = new Date(today);
    monday.setDate(today.getDate() + mondayOffset);
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(monday);
      date.setDate(monday.getDate() + i);
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const stats = getDayStats(dateStr);
      
      result.push({
        name: days[(i + 1) % 7], // ì›”=1, í™”=2, ... ì¼=0
        ë‚ ì§œ: `${date.getMonth() + 1}/${date.getDate()}`,
        ì§‘ì¤‘ë„: stats?.avgFocus || 0,
        ê³µë¶€ì‹œê°„: stats?.totalMinutes || 0,
        ì˜¤ì „: stats?.morningMinutes || 0,
        ì˜¤í›„: stats?.afternoonMinutes || 0,
        ì €ë…: stats?.eveningMinutes || 0,
        ììœ : stats?.freeMinutes || 0,
        ëª¨ì½”ì½”: stats?.mokoko || 0
      });
    }
    
    return result;
  };

  // ì›”ê°„ ë°ì´í„° (4ì£¼ì°¨ í‰ê· )
  const getMonthlyData = () => {
    const result = [];
    const today = new Date();
    
    for (let week = 0; week < 4; week++) {
      let totalMinutes = 0;
      let totalFocus = 0;
      let focusCount = 0;
      let totalMokoko = 0;
      let dayCount = 0;
      
      for (let day = 0; day < 7; day++) {
        const date = new Date(today);
        date.setDate(today.getDate() - (week * 7 + (6 - day)));
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const stats = getDayStats(dateStr);
        
        if (stats && stats.totalMinutes > 0) {
          totalMinutes += stats.totalMinutes;
          totalMokoko += stats.mokoko;
          dayCount++;
          if (stats.avgFocus > 0) {
            totalFocus += stats.avgFocus;
            focusCount++;
          }
        }
      }
      
      result.unshift({
        name: `${4 - week}ì£¼ ì „`,
        ì§‘ì¤‘ë„: focusCount > 0 ? Math.round(totalFocus / focusCount) : 0,
        ê³µë¶€ì‹œê°„: dayCount > 0 ? Math.round(totalMinutes / dayCount) : 0,
        ì´ê³µë¶€ì‹œê°„: totalMinutes,
        ëª¨ì½”ì½”: totalMokoko
      });
    }
    
    result[3].name = 'ì´ë²ˆ ì£¼';
    result[2].name = '1ì£¼ ì „';
    result[1].name = '2ì£¼ ì „';
    result[0].name = '3ì£¼ ì „';
    
    return result;
  };

  // ì—°ê°„ ë°ì´í„° (ì›”ë³„ í‰ê· )
  const getYearlyData = () => {
    const result = [];
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    for (let i = 5; i >= 0; i--) {
      let targetMonth = currentMonth - i;
      let targetYear = currentYear;
      
      if (targetMonth < 0) {
        targetMonth += 12;
        targetYear -= 1;
      }
      
      let totalMinutes = 0;
      let totalFocus = 0;
      let focusCount = 0;
      let totalMokoko = 0;
      let dayCount = 0;
      
      // í•´ë‹¹ ì›”ì˜ ëª¨ë“  ë‚ ì§œ í™•ì¸
      const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const stats = getDayStats(dateStr);
        
        if (stats && stats.totalMinutes > 0) {
          totalMinutes += stats.totalMinutes;
          totalMokoko += stats.mokoko;
          dayCount++;
          if (stats.avgFocus > 0) {
            totalFocus += stats.avgFocus;
            focusCount++;
          }
        }
      }
      
      result.push({
        name: `${targetMonth + 1}ì›”`,
        ì§‘ì¤‘ë„: focusCount > 0 ? Math.round(totalFocus / focusCount) : 0,
        ì¼í‰ê· ê³µë¶€: dayCount > 0 ? Math.round(totalMinutes / dayCount) : 0,
        ì´ê³µë¶€ì‹œê°„: totalMinutes,
        ëª¨ì½”ì½”: totalMokoko
      });
    }
    
    return result;
  };

  // ëª¨ì½”ì½” ì”¨ì•— ê³„ì‚° (êµ­ì‹œ/ê³µì‹œ ë¶„ë¦¬)
  const getMokokoStats = () => {
    let guksiMokoko = 0;  // êµ­ì‹œ ê¸°ê°„ (~ 2026.01.23)
    let gongsiMokoko = 0; // ê³µì‹œ ê¸°ê°„ (2026.01.24 ~)
    let totalMokoko = 0;
    const dailyMokoko = [];
    
    const sortedDates = Object.keys(data.dailyRecords).sort();
    
    sortedDates.forEach(dateStr => {
      const record = data.dailyRecords[dateStr];
      // ëª¨ì½”ì½”: ì•½ì í¬ì°© + ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†” + ì„¸ì…˜
      let dayMokoko = (record.weaknessHuntMorning || 0) + (record.weaknessHuntLunch || 0) + 
                      (record.weaknessHuntDinner || 0) + (record.mokokoSniff || 0);
      
      if (record.studySessions) {
        record.studySessions.forEach(session => {
          if (session.ankiCount) {
            dayMokoko += session.ankiCount;
          }
        });
      }
      
      if (dateStr <= GUKSI_DATE) {
        guksiMokoko += dayMokoko;
      } else {
        gongsiMokoko += dayMokoko;
      }
      totalMokoko += dayMokoko;
      
      if (dayMokoko > 0) {
        dailyMokoko.push({
          date: dateStr,
          name: `${dateStr.split('-')[1]}/${dateStr.split('-')[2]}`,
          ì¼ì¼: dayMokoko,
          ëˆ„ì : totalMokoko
        });
      }
    });
    
    return { guksiMokoko, gongsiMokoko, totalMokoko, dailyMokoko };
  };

  // íœ´ì‹ í†µê³„ ê³„ì‚° (ì¼ë³„)
  const getDayRestStats = (dateStr) => {
    const record = data.dailyRecords[dateStr];
    if (!record || !record.restSessions) return null;
    
    const sessions = record.restSessions;
    let napCount = 0, stableCount = 0, loveCount = 0, overheatCount = 0;
    let totalMinutes = 0;
    
    sessions.forEach(s => {
      if (s.type === 'nap') { napCount++; totalMinutes += s.minutes || 0; }
      else if (s.type === 'stable') { stableCount++; totalMinutes += s.minutes || 0; }
      else if (s.type === 'love') { loveCount++; totalMinutes += s.minutes || 0; }
      else if (s.type === 'overheat') { overheatCount++; }
    });
    
    const totalCount = sessions.length;
    const goodCount = napCount + stableCount + loveCount;
    
    // íœ´ì‹ í’ˆì§ˆ ì ìˆ˜: ì„ ì =3, ì•ˆì •=2, ì‚¬ë‘=1, ê³¼ì—´=0
    const qualityScore = totalCount > 0 
      ? ((napCount * 3 + stableCount * 2 + loveCount * 1) / totalCount).toFixed(1)
      : 0;
    
    return {
      napCount, stableCount, loveCount, overheatCount,
      totalCount, goodCount, totalMinutes, qualityScore
    };
  };

  // ì£¼ê°„ íœ´ì‹ ë°ì´í„°
  const getWeeklyRestData = () => {
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const result = [];
    const today = new Date();
    
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const monday = new Date(today);
    monday.setDate(today.getDate() + mondayOffset);
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(monday);
      date.setDate(monday.getDate() + i);
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const restStats = getDayRestStats(dateStr);
      const dayStats = getDayStats(dateStr);
      
      // ê³µë¶€:íœ´ì‹ ë¹„ìœ¨ ê³„ì‚°
      const studyMinutes = dayStats?.totalMinutes || 0;
      const restMinutes = restStats?.totalMinutes || 0;
      const ratio = restMinutes > 0 ? (studyMinutes / restMinutes).toFixed(1) : '-';
      
      result.push({
        name: days[(i + 1) % 7],
        ë‚ ì§œ: `${date.getMonth() + 1}/${date.getDate()}`,
        ì„ ì : restStats?.napCount || 0,
        ì•ˆì •: restStats?.stableCount || 0,
        ì‚¬ë‘: restStats?.loveCount || 0,
        ê³¼ì—´: restStats?.overheatCount || 0,
        ì¢‹ì€íœ´ì‹: restStats?.goodCount || 0,
        ì´íœ´ì‹: restStats?.totalCount || 0,
        íœ´ì‹ì‹œê°„: restStats?.totalMinutes || 0,
        í’ˆì§ˆì ìˆ˜: parseFloat(restStats?.qualityScore) || 0,
        ê³µë¶€íœ´ì‹ë¹„ìœ¨: ratio
      });
    }
    
    return result;
  };

  // ì›”ê°„ íœ´ì‹ ë°ì´í„° (4ì£¼ì°¨)
  const getMonthlyRestData = () => {
    const result = [];
    const today = new Date();
    
    for (let week = 0; week < 4; week++) {
      let napCount = 0, stableCount = 0, loveCount = 0, overheatCount = 0;
      let totalMinutes = 0, totalStudyMinutes = 0;
      
      for (let day = 0; day < 7; day++) {
        const date = new Date(today);
        date.setDate(today.getDate() - (week * 7 + (6 - day)));
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const restStats = getDayRestStats(dateStr);
        const dayStats = getDayStats(dateStr);
        
        if (restStats) {
          napCount += restStats.napCount;
          stableCount += restStats.stableCount;
          loveCount += restStats.loveCount;
          overheatCount += restStats.overheatCount;
          totalMinutes += restStats.totalMinutes;
        }
        if (dayStats) {
          totalStudyMinutes += dayStats.totalMinutes;
        }
      }
      
      const totalCount = napCount + stableCount + loveCount + overheatCount;
      const qualityScore = totalCount > 0 
        ? ((napCount * 3 + stableCount * 2 + loveCount * 1) / totalCount).toFixed(1)
        : 0;
      const ratio = totalMinutes > 0 ? (totalStudyMinutes / totalMinutes).toFixed(1) : '-';
      
      result.unshift({
        name: `${4 - week}ì£¼ ì „`,
        ì„ ì : napCount,
        ì•ˆì •: stableCount,
        ì‚¬ë‘: loveCount,
        ê³¼ì—´: overheatCount,
        ì¢‹ì€íœ´ì‹: napCount + stableCount + loveCount,
        ì´íœ´ì‹: totalCount,
        íœ´ì‹ì‹œê°„: totalMinutes,
        í’ˆì§ˆì ìˆ˜: parseFloat(qualityScore),
        ê³µë¶€íœ´ì‹ë¹„ìœ¨: ratio
      });
    }
    
    result[3].name = 'ì´ë²ˆ ì£¼';
    result[2].name = '1ì£¼ ì „';
    result[1].name = '2ì£¼ ì „';
    result[0].name = '3ì£¼ ì „';
    
    return result;
  };

  // ì—°ê°„ íœ´ì‹ ë°ì´í„° (ì›”ë³„)
  const getYearlyRestData = () => {
    const result = [];
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    for (let i = 5; i >= 0; i--) {
      let targetMonth = currentMonth - i;
      let targetYear = currentYear;
      
      if (targetMonth < 0) {
        targetMonth += 12;
        targetYear -= 1;
      }
      
      let napCount = 0, stableCount = 0, loveCount = 0, overheatCount = 0;
      let totalMinutes = 0, totalStudyMinutes = 0;
      
      const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const restStats = getDayRestStats(dateStr);
        const dayStats = getDayStats(dateStr);
        
        if (restStats) {
          napCount += restStats.napCount;
          stableCount += restStats.stableCount;
          loveCount += restStats.loveCount;
          overheatCount += restStats.overheatCount;
          totalMinutes += restStats.totalMinutes;
        }
        if (dayStats) {
          totalStudyMinutes += dayStats.totalMinutes;
        }
      }
      
      const totalCount = napCount + stableCount + loveCount + overheatCount;
      const qualityScore = totalCount > 0 
        ? ((napCount * 3 + stableCount * 2 + loveCount * 1) / totalCount).toFixed(1)
        : 0;
      const ratio = totalMinutes > 0 ? (totalStudyMinutes / totalMinutes).toFixed(1) : '-';
      
      result.push({
        name: `${targetMonth + 1}ì›”`,
        ì„ ì : napCount,
        ì•ˆì •: stableCount,
        ì‚¬ë‘: loveCount,
        ê³¼ì—´: overheatCount,
        ì¢‹ì€íœ´ì‹: napCount + stableCount + loveCount,
        ì´íœ´ì‹: totalCount,
        íœ´ì‹ì‹œê°„: totalMinutes,
        í’ˆì§ˆì ìˆ˜: parseFloat(qualityScore),
        ê³µë¶€íœ´ì‹ë¹„ìœ¨: ratio
      });
    }
    
    return result;
  };

  // ì‹œê°„ëŒ€ë³„ íš¨ìœ¨ ê³„ì‚°
  const getTimeSlotEfficiency = () => {
    let morning = { minutes: 0, focusSum: 0, count: 0 };
    let afternoon = { minutes: 0, focusSum: 0, count: 0 };
    let evening = { minutes: 0, focusSum: 0, count: 0 };
    let free = { minutes: 0, focusSum: 0, count: 0 };
    
    Object.values(data.dailyRecords).forEach(record => {
      morning.minutes += record.morningMinutes || 0;
      afternoon.minutes += record.afternoonMinutes || 0;
      evening.minutes += record.eveningMinutes || 0;
      free.minutes += record.freeMinutes || 0;
      
      if (record.studySessions) {
        record.studySessions.forEach(session => {
          const score = focusToScore(session.focus);
          if (session.timeSlot === 'morning') {
            morning.focusSum += score;
            morning.count++;
          } else if (session.timeSlot === 'afternoon') {
            afternoon.focusSum += score;
            afternoon.count++;
          } else if (session.timeSlot === 'evening') {
            evening.focusSum += score;
            evening.count++;
          } else {
            free.focusSum += score;
            free.count++;
          }
        });
      }
    });
    
    return [
      { name: 'ğŸŒ… ì˜¤ì „', ê³µë¶€ì‹œê°„: morning.minutes, í‰ê· ì§‘ì¤‘ë„: morning.count > 0 ? Math.round(morning.focusSum / morning.count) : 0 },
      { name: 'â˜€ï¸ ì˜¤í›„', ê³µë¶€ì‹œê°„: afternoon.minutes, í‰ê· ì§‘ì¤‘ë„: afternoon.count > 0 ? Math.round(afternoon.focusSum / afternoon.count) : 0 },
      { name: 'ğŸŒ™ ì €ë…', ê³µë¶€ì‹œê°„: evening.minutes, í‰ê· ì§‘ì¤‘ë„: evening.count > 0 ? Math.round(evening.focusSum / evening.count) : 0 },
      { name: 'â° ììœ ', ê³µë¶€ì‹œê°„: free.minutes, í‰ê· ì§‘ì¤‘ë„: free.count > 0 ? Math.round(free.focusSum / free.count) : 0 }
    ];
  };

  const acquiredFeathers = Object.values(data.feathers).filter(v => v).length;
  const recordedDates = Object.keys(data.dailyRecords).sort().reverse();
  const todayRecord = getTodayRecord();

  const formatDate = (dateStr) => {
    const [year, month, day] = dateStr.split('-');
    return `${month}ì›” ${day}ì¼`;
  };

  const isToday = selectedDate === getTodayString();

  // íƒ€ì´ë¨¸ í‘œì‹œ í¬ë§· (ë¶„ ë‹¨ìœ„ë§Œ)
  const formatTimerMinutes = (seconds, targetMinutes) => {
    const targetSeconds = targetMinutes * 60;
    if (isOvertime) {
      const overtimeSeconds = seconds - targetSeconds;
      const mins = Math.floor(overtimeSeconds / 60);
      return `+${mins}`;
    } else {
      const remainingSeconds = targetSeconds - seconds;
      const mins = Math.ceil(remainingSeconds / 60);
      return `${mins}`;
    }
  };

  // ë³´ë„ˆìŠ¤ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸ - ì™„ë£Œ ì‹œ ë¿Œë“¯í•œ UI
  const BonusButton = ({ onClick, disabled, completed, children, className }) => {
    const baseClass = completed 
      ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg shadow-green-500/30 border border-green-400/50'
      : disabled 
        ? 'bg-slate-700 text-gray-500 cursor-not-allowed'
        : className;
    
    return (
      <button
        onClick={onClick}
        disabled={disabled || completed}
        className={`py-2 rounded-lg text-sm transition-all flex items-center justify-center gap-1 ${baseClass}`}
      >
        {completed ? <span className="flex items-center gap-1">âœ¨ ì™„ë£Œ! âœ¨</span> : children}
      </button>
    );
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-slate-900 via-purple-950 to-slate-900 flex items-center justify-center">
        <div className="text-purple-300 text-xl">âœ¨ íŠ¸ë¦¬ì‹œì˜¨ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 via-purple-950 to-slate-900 p-4 text-gray-100">
      {/* í† ìŠ¤íŠ¸ ì•Œë¦¼ */}
      {toast && (
        <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg animate-pulse ${toast.type === 'earn' ? 'bg-green-600' : 'bg-red-600'} text-white font-semibold`}>
          {toast.message}
        </div>
      )}

      {/* í™•ì¸ íŒì—… */}
      {showConfirm && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-sm w-full border border-purple-500/50">
            <h3 className="text-purple-300 text-lg font-semibold mb-3">ğŸ’« í™•ì¸</h3>
            <p className="text-gray-300 mb-4">
              <span className="text-yellow-400 font-bold">{showConfirm.amount} í† í°</span>ì„ ì‚¬ìš©í•´ì„œ<br/>
              <span className="text-purple-300">"{showConfirm.actionName}"</span>ì„(ë¥¼) í•˜ì‹œê² ì–´ìš”?
            </p>
            <div className="flex gap-2">
              <button onClick={() => setShowConfirm(null)} className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all">ì·¨ì†Œ</button>
              <button onClick={() => spendTokens(showConfirm.amount, showConfirm.actionName, showConfirm.isHobbySet)} className="flex-1 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white transition-all">ì‚¬ìš©í•˜ê¸°</button>
            </div>
          </div>
        </div>
      )}

      {/* ê¹ƒí„¸ íšë“ í™•ì¸ íŒì—… */}
      {showFeatherConfirm && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-sm w-full border border-purple-500/50">
            <h3 className="text-purple-300 text-lg font-semibold mb-3">ğŸª¶ ê¹ƒí„¸ íšë“</h3>
            <p className="text-gray-300 mb-4">
              <span className="text-purple-300 font-bold">{featherNames[showFeatherConfirm]}</span> ê³¼ëª©ì„ ì™„ì£¼í•˜ì…¨êµ°ìš”!<br/>
              <span className="text-yellow-400 font-bold">+{featherRewards[showFeatherConfirm].toLocaleString()} í† í°</span>ì„ ë°›ìœ¼ì‹œê² ì–´ìš”?
            </p>
            <div className="flex gap-2">
              <button onClick={() => setShowFeatherConfirm(null)} className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all">ì·¨ì†Œ</button>
              <button onClick={() => acquireFeather(showFeatherConfirm)} className="flex-1 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white transition-all">íšë“í•˜ê¸°</button>
            </div>
          </div>
        </div>
      )}

      {/* íŠ¹ë³„í•œ ë‚  ë©”ëª¨ íŒì—… */}
      {showSpecialDayModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-sm w-full border border-purple-500/50">
            <h3 className="text-purple-300 text-lg font-semibold mb-3">{getSpecialDayLabel(showSpecialDayModal.type)}</h3>
            {showSpecialDayModal.cost > 0 && <p className="text-yellow-400 text-sm mb-3">-{showSpecialDayModal.cost.toLocaleString()} í† í°</p>}
            <input type="text" value={specialDayNote} onChange={(e) => setSpecialDayNote(e.target.value)} placeholder="ë©”ëª¨ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš” (ì„ íƒ)" className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-purple-500/30 mb-4" />
            <div className="flex gap-2">
              <button onClick={() => { setShowSpecialDayModal(null); setSpecialDayNote(''); }} className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all">ì·¨ì†Œ</button>
              <button onClick={() => recordSpecialDay(showSpecialDayModal.type, specialDayNote, showSpecialDayModal.cost)} disabled={showSpecialDayModal.cost > 0 && data.tokens < showSpecialDayModal.cost} className="flex-1 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white transition-all disabled:bg-slate-700 disabled:text-gray-500">ê¸°ë¡í•˜ê¸°</button>
            </div>
          </div>
        </div>
      )}

      {/* ëª…ì–¸ íŒì—… ëª¨ë‹¬ */}
      {showQuoteModal && currentQuote && (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
          <div className="bg-gradient-to-b from-slate-900 to-purple-950 rounded-xl p-6 max-w-sm w-full border border-purple-500/50 shadow-2xl">
            <div className="text-center mb-6">
              <div className="text-4xl mb-4">âœ¨</div>
              <div className="text-purple-200 text-lg italic leading-relaxed mb-3">
                "{currentQuote.text}"
              </div>
              <div className="text-purple-400 text-sm">
                â€” {currentQuote.author}
              </div>
            </div>
            <div className="bg-slate-800/50 rounded-lg p-3 mb-4 text-center">
              <span className="text-gray-400 text-sm">ê³µë¶€ ì‹œê°„: </span>
              <span className="text-green-400 font-bold">{pendingStartMinutes}ë¶„</span>
            </div>
            <div className="flex gap-3">
              <button 
                onClick={cancelQuoteModal} 
                className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-gray-300 transition-all"
              >
                ì·¨ì†Œ
              </button>
              <button 
                onClick={confirmStartTimer} 
                className="flex-1 py-3 bg-green-600 hover:bg-green-500 rounded-lg text-white font-semibold transition-all"
              >
                ğŸ—¡ï¸ ì¶œë°œ!
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ì„¸ì…˜ ì™„ë£Œ ëª¨ë‹¬ */}
      {showCompleteModal && (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 rounded-xl p-6 max-w-sm w-full border border-green-500/50">
            <h3 className="text-green-400 text-lg font-semibold mb-4">âœ… ì„¸ì…˜ ì™„ë£Œ!</h3>
            {sessionGoal && (
              <div className="text-purple-300 text-sm mb-3 text-center bg-purple-900/30 rounded-lg p-2">
                {sessionGoal}
              </div>
            )}
            <div className="mb-4">
              <div className="text-gray-400 text-sm mb-1">ì„¤ì • ì‹œê°„: {selectedTime}ë¶„</div>
              <div className="text-gray-400 text-sm">
                ì‹¤ì œ ì‹œê°„: <span className={isOvertime ? 'text-orange-400' : 'text-green-400'}>{Math.ceil(timerSeconds / 60)}ë¶„</span>
                {isOvertime && <span className="text-orange-400"> (ì´ˆê³¼ë¶„ ë¯¸ì¸ì •)</span>}
                {Math.ceil(timerSeconds / 60) < selectedTime && <span className="text-yellow-400"> (ì¡°ê¸° ì™„ë£Œ)</span>}
              </div>
            </div>
            <div className="mb-4">
              <label className="text-gray-300 text-sm block mb-2">ì§‘ì¤‘ë ¥ ë“±ê¸‰</label>
              <div className="grid grid-cols-6 gap-1">
                {['SS', 'S', 'A', 'B', 'C', 'D'].map(grade => (
                  <button key={grade} onClick={() => setSessionFocus(grade)} className={`py-2 rounded text-xs font-bold transition-all ${sessionFocus === grade ? 'bg-green-600 text-white' : 'bg-slate-700 text-gray-400 hover:bg-slate-600'}`}>{grade}</button>
                ))}
              </div>
              <div className="text-center text-xs text-gray-500 mt-1">ë°°ìœ¨: {Math.round(focusMultipliers[sessionFocus] * 100)}%</div>
            </div>
            <div className="mb-4">
              <label className="text-gray-300 text-sm block mb-2">Anki ë¬¸ì œ ìˆ˜ (ì„ íƒ)</label>
              <input type="number" value={sessionAnki} onChange={(e) => setSessionAnki(e.target.value)} placeholder="ì˜ˆ: 50" className="w-full px-3 py-2 bg-slate-800 rounded-lg text-white text-sm border border-slate-600" />
            </div>
            <div className="bg-slate-800 rounded-lg p-3 mb-4">
              <div className="text-center">
                <span className="text-gray-400 text-sm">íšë“ ì˜ˆì •: </span>
                <span className="text-yellow-400 font-bold">{Math.round(Math.min(Math.ceil(timerSeconds / 60), selectedTime) * 2 * focusMultipliers[sessionFocus])} í† í°</span>
                <div className="text-gray-500 text-xs mt-1">({Math.min(Math.ceil(timerSeconds / 60), selectedTime)}ë¶„ Ã— 2 Ã— {Math.round(focusMultipliers[sessionFocus] * 100)}%)</div>
              </div>
            </div>
            <button onClick={finishSession} className="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg text-white font-semibold transition-all">ì™„ë£Œí•˜ê¸°</button>
          </div>
        </div>
      )}

      {/* íœ´ì‹ ê¸°ë¡ ëª¨ë‹¬ */}
      {showRestModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-900 rounded-xl p-6 max-w-sm w-full border border-cyan-500/50">
            <h3 className="text-cyan-400 text-lg font-semibold mb-4">
              {showRestModal === 'nap' && 'ğŸ˜´ ì„ ì /ê¿€ì '}
              {showRestModal === 'stable' && 'ğŸª¶ ë² ì•„ ì•ˆì •'}
              {showRestModal === 'love' && 'ğŸ’• ë² ì•„ ì‚¬ë‘'}
              {showRestModal === 'overheat' && 'ğŸ“± ë‡Œ ê³¼ì—´'}
            </h3>
            
            <div className="mb-4">
              <label className="text-gray-300 text-sm block mb-2">íœ´ì‹ ì‹œê°„ (ë¶„)</label>
              <input 
                type="number" 
                value={restMinutes} 
                onChange={(e) => setRestMinutes(e.target.value)} 
                placeholder="ì˜ˆ: 15" 
                className="w-full px-3 py-2 bg-slate-800 rounded-lg text-white text-sm border border-slate-600 text-center text-xl"
                min="1"
                max="60"
              />
              <div className="text-center text-gray-500 text-xs mt-2">
                ê¶Œì¥: 10~20ë¶„ (ê¸°ì–µ ê³µê³ í™” ìµœì )
              </div>
            </div>
            
            <div className="bg-slate-800 rounded-lg p-3 mb-4 text-center">
              <span className="text-gray-400 text-sm">í† í°: </span>
              <span className={`font-bold ${
                showRestModal === 'nap' ? 'text-cyan-400' :
                showRestModal === 'stable' ? 'text-purple-400' :
                showRestModal === 'love' ? 'text-pink-400' :
                'text-red-400'
              }`}>
                {showRestModal === 'nap' && '+100ğŸª™'}
                {showRestModal === 'stable' && '+50ğŸª™'}
                {showRestModal === 'love' && '+20ğŸª™'}
                {showRestModal === 'overheat' && '-100ğŸª™'}
              </span>
            </div>
            
            <div className="flex gap-2">
              <button 
                onClick={() => { setShowRestModal(null); setRestMinutes('15'); }}
                className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all"
              >
                ì·¨ì†Œ
              </button>
              <button 
                onClick={() => recordRest(showRestModal, restMinutes)}
                disabled={!restMinutes || parseInt(restMinutes) <= 0}
                className={`flex-1 py-2 rounded-lg text-white transition-all disabled:bg-slate-700 disabled:text-gray-500 ${
                  showRestModal === 'nap' ? 'bg-cyan-600 hover:bg-cyan-500' :
                  showRestModal === 'stable' ? 'bg-purple-600 hover:bg-purple-500' :
                  showRestModal === 'love' ? 'bg-pink-600 hover:bg-pink-500' :
                  'bg-red-600 hover:bg-red-500'
                }`}
              >
                ê¸°ë¡í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ */}
      {showExportModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full border border-purple-500/50">
            <h3 className="text-purple-300 text-lg font-semibold mb-3">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
            <p className="text-gray-300 text-sm mb-4">ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë¼ìš”.</p>
            <div className="flex gap-2">
              <button onClick={() => setShowExportModal(false)} className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all">ë‹«ê¸°</button>
              <button onClick={exportData} className="flex-1 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-all">{exportCopied ? 'âœ“ ë³µì‚¬ë¨!' : 'ğŸ“‹ ë³µì‚¬í•˜ê¸°'}</button>
            </div>
          </div>
        </div>
      )}

      {/* ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ */}
      {showImportModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full border border-purple-500/50">
            <h3 className="text-purple-300 text-lg font-semibold mb-3">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h3>
            <p className="text-gray-300 text-sm mb-3">âš ï¸ í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì ¸ìš”!</p>
            <textarea value={importText} onChange={(e) => setImportText(e.target.value)} placeholder="JSON ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." className="w-full h-32 px-3 py-2 bg-slate-700 rounded-lg text-white text-xs font-mono border border-purple-500/30 mb-4 resize-none" />
            <div className="flex gap-2">
              <button onClick={() => { setShowImportModal(false); setImportText(''); }} className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all">ì·¨ì†Œ</button>
              <button onClick={importData} disabled={!importText.trim()} className="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-white transition-all disabled:bg-slate-700 disabled:text-gray-500">ê°€ì ¸ì˜¤ê¸°</button>
            </div>
          </div>
        </div>
      )}

      {/* ğŸ’œ ë² ì•„ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ */}
      {showFeedbackExportModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full border border-pink-500/50">
            <h3 className="text-pink-300 text-lg font-semibold mb-3">ğŸ’œ ë² ì•„ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸°</h3>
            <p className="text-gray-300 text-sm mb-4">ë² ì•„ê°€ ë¶„ì„í•˜ê¸° ì¢‹ì€ í•µì‹¬ ë°ì´í„°ë§Œ ì¶”ì¶œí•´ìš”. ì „ì²´ ë°ì´í„°ë³´ë‹¤ í›¨ì”¬ ê°€ë³ê³  íš¨ìœ¨ì ì´ì—ìš”!</p>
            
            <div className="mb-4">
              <p className="text-purple-300 text-sm mb-2">ğŸ“… ë¶„ì„ ê¸°ê°„ ì„ íƒ</p>
              <div className="grid grid-cols-4 gap-2">
                {[7, 14, 30, 0].map(days => (
                  <button
                    key={days}
                    onClick={() => setFeedbackPeriod(days)}
                    className={`py-2 rounded-lg text-sm transition-all ${
                      feedbackPeriod === days
                        ? 'bg-pink-600 text-white'
                        : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                    }`}
                  >
                    {days === 0 ? 'ì „ì²´' : `${days}ì¼`}
                  </button>
                ))}
              </div>
            </div>
            
            <div className="bg-slate-700/50 rounded-lg p-3 mb-4 text-xs text-gray-400">
              <p className="text-purple-300 font-semibold mb-1">ğŸ“¦ í¬í•¨ ë°ì´í„°:</p>
              <p>â€¢ ìˆ˜ë©´ ê¸°ë¡ (ì‹œê°„, í’ˆì§ˆ, ê°ì„±, ì·¨ì¹¨ì „ í–‰ë™)</p>
              <p>â€¢ í•™ìŠµ ì„¸ì…˜ (íšŸìˆ˜, ì‹œê°„, ëª¨ì½”ì½” ìˆ˜ì§‘ëŸ‰)</p>
              <p>â€¢ íœ´ì‹ íŒ¨í„´ (ì„ ì /ì•ˆì •/ì‚¬ë‘/ê³¼ì—´)</p>
              <p>â€¢ ì¼ì¼ ì²´í¬ (ìš´ë™, ì‹ì‚¬, ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°©)</p>
              <p>â€¢ ê¸°ê°„ ë‚´ í‰ê·  í†µê³„</p>
            </div>
            
            <div className="flex gap-2">
              <button 
                onClick={() => setShowFeedbackExportModal(false)} 
                className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all"
              >
                ë‹«ê¸°
              </button>
              <button 
                onClick={exportFeedbackData} 
                className="flex-1 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg text-white transition-all"
              >
                {feedbackExportCopied ? 'âœ“ ë³µì‚¬ë¨!' : 'ğŸ’œ ë³µì‚¬í•˜ê¸°'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ğŸ’¤ ìˆ˜ë©´ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ (v8.5) */}
      {showSleepFeedbackModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full border border-indigo-500/50">
            <h3 className="text-indigo-300 text-lg font-semibold mb-3">ğŸ’¤ ìˆ˜ë©´ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸°</h3>
            <p className="text-gray-300 text-sm mb-4">ì•„ì¹¨ì— ë² ì•„í•œí…Œ ìˆ˜ë©´ í”¼ë“œë°± ë°›ê¸°! ì–´ì ¯ë°¤ ì˜ ì¤ìœ¼ë©´ ì¹­ì°¬ë°›ê³  ê¸°ë¶„ ì¢‹ê²Œ í•˜ë£¨ ì‹œì‘í•´ìš” ğŸ’œ</p>
            
            <div className="mb-4">
              <p className="text-indigo-300 text-sm mb-2">ğŸ“… ë¶„ì„ ê¸°ê°„ ì„ íƒ</p>
              <div className="grid grid-cols-4 gap-2">
                {[3, 7, 14, 0].map(days => (
                  <button
                    key={days}
                    onClick={() => setSleepFeedbackPeriod(days)}
                    className={`py-2 rounded-lg text-sm transition-all ${
                      sleepFeedbackPeriod === days
                        ? 'bg-indigo-600 text-white'
                        : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                    }`}
                  >
                    {days === 0 ? 'ì „ì²´' : `${days}ì¼`}
                  </button>
                ))}
              </div>
            </div>
            
            <div className="bg-slate-700/50 rounded-lg p-3 mb-4 text-xs text-gray-400">
              <p className="text-indigo-300 font-semibold mb-1">ğŸ˜´ ìˆ˜ë©´ ì „ìš© ìƒì„¸ ë°ì´í„°:</p>
              <p>â€¢ ì‹œê°„ (ì¹¨ëŒ€/ì¡°ëª…ë”/ìµœì¢…ê°ì„±/ì´íƒˆ)</p>
              <p>â€¢ ì…ë©´ ì ë³µê¸° ì²´ê° (ê¸ˆë°©~ì—„ì²­)</p>
              <p>â€¢ ì¤‘ê°„ ê°ì„± ìƒì„¸ (ì‹œê°„, ì‚¬ìœ , ì¬ì…ë©´, í–‰ë™)</p>
              <p>â€¢ ìˆ˜ë©´ ì „ í–‰ë™ + ì ìˆ˜ (ë² ì•„ì‚¬ë‘/ë¡œì•„ì„±ê²½/ë°”ëŒ/ê³¼ì—´)</p>
              <p>â€¢ í’ˆì§ˆ ë¶„í¬ (SS~D í†µê³„)</p>
              <p>â€¢ ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ (ì¢‹ì€/ë‚˜ìœ/ì‹œë„)</p>
            </div>
            
            <div className="flex gap-2">
              <button 
                onClick={() => setShowSleepFeedbackModal(false)} 
                className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all"
              >
                ë‹«ê¸°
              </button>
              <button 
                onClick={exportSleepFeedbackData} 
                className="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white transition-all"
              >
                {sleepFeedbackCopied ? 'âœ“ ë³µì‚¬ë¨!' : 'ğŸ’¤ ë³µì‚¬í•˜ê¸°'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ğŸ˜´ ë‚®ì  ê¸°ë¡ ëª¨ë‹¬ (v8.6) */}
      {showNapModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full border border-amber-500/50">
            <h3 className="text-amber-300 text-lg font-semibold mb-4">ğŸ˜´ ë‚®ì  ê¸°ë¡</h3>
            
            {/* ì‹œê°„ ì…ë ¥ */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label className="text-gray-400 text-xs block mb-1">ì‹œì‘ ì‹œê°„</label>
                <input
                  type="time"
                  value={napStartTime}
                  onChange={(e) => setNapStartTime(e.target.value)}
                  className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600"
                />
              </div>
              <div>
                <label className="text-gray-400 text-xs block mb-1">ì¢…ë£Œ ì‹œê°„</label>
                <input
                  type="time"
                  value={napEndTime}
                  onChange={(e) => setNapEndTime(e.target.value)}
                  className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600"
                />
              </div>
            </div>
            
            {/* ì˜ë„ì /ë¹„ì˜ë„ì  ì„ íƒ */}
            <div className="mb-4">
              <label className="text-gray-400 text-xs block mb-2">ë‚®ì  ìœ í˜•</label>
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => setNapIntentional(true)}
                  className={`py-2 rounded-lg text-sm transition-all ${napIntentional ? 'bg-green-600 text-white' : 'bg-slate-700 text-gray-400'}`}
                >
                  âœ“ ì˜ë„ì  ë‚®ì 
                </button>
                <button
                  onClick={() => setNapIntentional(false)}
                  className={`py-2 rounded-lg text-sm transition-all ${!napIntentional ? 'bg-orange-600 text-white' : 'bg-slate-700 text-gray-400'}`}
                >
                  ğŸ˜µ ë¹„ì˜ë„ì  (ì ë“¦)
                </button>
              </div>
            </div>
            
            {/* ë©”ëª¨ */}
            <div className="mb-4">
              <label className="text-gray-400 text-xs block mb-1">ğŸ“ ë©”ëª¨ (ì„ íƒ)</label>
              <textarea
                value={napMemo}
                onChange={(e) => setNapMemo(e.target.value)}
                placeholder="ì˜ˆ: ë² ì•„ ì“°ë‹¤ë“¬ë‹¤ê°€ ì ë“¦, ì ì‹¬ í›„ ì¡¸ë ¤ì„œ..."
                className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600 placeholder-gray-500 resize-none"
                rows={2}
              />
            </div>
            
            {/* ì˜ˆìƒ ì‹œê°„ í‘œì‹œ */}
            {(() => {
              const timeToMin = (t) => { if (!t) return 0; const [h,m] = t.split(':').map(Number); return h*60+m; };
              const startMin = timeToMin(napStartTime);
              const endMin = timeToMin(napEndTime);
              let napMinutes = endMin - startMin;
              if (napMinutes < 0) napMinutes += 24 * 60;
              
              const isSleepNap = napMinutes > 30;
              
              return (
                <div className={`text-center text-sm mb-4 p-2 rounded-lg ${napMinutes <= 20 ? 'bg-green-900/30' : napMinutes <= 30 ? 'bg-yellow-900/30' : 'bg-blue-900/30'}`}>
                  <div className={napMinutes <= 20 ? 'text-green-400' : napMinutes <= 30 ? 'text-yellow-400' : 'text-blue-400'}>
                    ë‚®ì  ì‹œê°„: <span className="font-semibold">{napMinutes}ë¶„</span>
                  </div>
                  <div className="text-xs mt-1">
                    {isSleepNap ? (
                      <span className="text-blue-300">ğŸ“Š ìˆ˜ë©´ì„± ë‚®ì  â†’ ì´ ìˆ˜ë©´ í†µê³„ì— í•©ì‚°ë¨</span>
                    ) : (
                      <span className="text-gray-400">ğŸ’¤ íœ´ì‹ì„± ë‚®ì  â†’ ê¸°ë¡ë§Œ (í†µê³„ ë¯¸í¬í•¨)</span>
                    )}
                  </div>
                </div>
              );
            })()}
            
            <div className="flex gap-2">
              <button 
                onClick={() => {
                  setShowNapModal(false);
                  setNapMemo('');
                }}
                className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all"
              >
                ì·¨ì†Œ
              </button>
              <button 
                onClick={recordNap}
                className="flex-1 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white transition-all"
              >
                ğŸ˜´ ê¸°ë¡í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      )}

      {/* í—¤ë” */}
      <div className="text-center mb-4">
        <h1 className="text-2xl font-bold text-purple-300 mb-1">ğŸ“œ ë² ì•„íŠ¸ë¦¬ìŠ¤, ëª¨í—˜ì˜ ì„œ</h1>
        <p className="text-purple-400 text-sm">íŠ¸ë¦¬ì‹œì˜¨ì˜ ì£¼ì‹œìê°€ ë‹¹ì‹ ì˜ ì—¬ì •ì„ ê¸°ë¡í•©ë‹ˆë‹¤</p>
      </div>

      {/* í† í° í˜„í™© */}
      <div className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-purple-500/30">
        <div className="text-center mb-3">
          <div className="text-purple-400 text-sm mb-1">ë³´ìœ  í† í°</div>
          <div className="text-4xl font-bold text-yellow-400">âœ¦ {data.tokens.toLocaleString()}</div>
        </div>
        
        {showManualAdjust && (
          <div className="flex justify-center gap-2 mb-3">
            <button onClick={() => adjustTokens(-100)} className="px-3 py-1 bg-red-600 hover:bg-red-500 rounded text-white text-sm">-100</button>
            <button onClick={() => adjustTokens(-10)} className="px-3 py-1 bg-red-600 hover:bg-red-500 rounded text-white text-sm">-10</button>
            <button onClick={() => adjustTokens(10)} className="px-3 py-1 bg-green-600 hover:bg-green-500 rounded text-white text-sm">+10</button>
            <button onClick={() => adjustTokens(100)} className="px-3 py-1 bg-green-600 hover:bg-green-500 rounded text-white text-sm">+100</button>
          </div>
        )}
        
        <div className="flex justify-center gap-2 flex-wrap">
          <button onClick={() => setShowManualAdjust(!showManualAdjust)} className="px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded-lg text-gray-300 text-xs transition-all">{showManualAdjust ? 'ì¡°ì • ë‹«ê¸°' : 'ğŸ”§ ìˆ˜ë™ ì¡°ì •'}</button>
          {data.actionHistory.length > 0 && (
            <button onClick={undoLastAction} className="px-3 py-1 bg-orange-600 hover:bg-orange-500 rounded-lg text-white text-xs transition-all">â†©ï¸ ë˜ëŒë¦¬ê¸° ({data.actionHistory.length})</button>
          )}
        </div>
      </div>

      {/* ì˜¤ëŠ˜ì˜ ê¸°ë¡ ë¯¸ë‹ˆ ìš”ì•½ */}
      <div className="bg-slate-800/50 rounded-xl p-3 mb-4 border border-purple-500/30">
        <div className="flex items-center justify-between mb-2">
          <span className="text-purple-300 text-sm">ğŸ“Š ì˜¤ëŠ˜ì˜ ê¸°ë¡</span>
          {todayRecord.specialDayType && (
            <span className="text-xs px-2 py-1 bg-purple-600 rounded-full">{getSpecialDayLabel(todayRecord.specialDayType)}</span>
          )}
        </div>
        <div className="grid grid-cols-4 gap-2 text-center text-xs">
          <div>
            <div className="text-green-400 font-bold">+{todayRecord.earned?.toLocaleString() || 0}</div>
            <div className="text-gray-500">íšë“</div>
          </div>
          <div>
            <div className="text-red-400 font-bold">-{todayRecord.spent?.toLocaleString() || 0}</div>
            <div className="text-gray-500">ì‚¬ìš©</div>
          </div>
          <div>
            <div className="text-blue-400 font-bold">{todayRecord.studySets || 0}</div>
            <div className="text-gray-500">ì„¸íŠ¸</div>
          </div>
          <div>
            <div className="text-purple-400 font-bold">{(todayRecord.morningMinutes || 0) + (todayRecord.afternoonMinutes || 0) + (todayRecord.eveningMinutes || 0)}ë¶„</div>
            <div className="text-gray-500">ê³µë¶€</div>
          </div>
        </div>
      </div>

      {/* ê¹ƒí„¸ í˜„í™© */}
      <div className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-purple-500/30">
        <div className="text-center mb-3">
          <span className="text-purple-300">ğŸª¶ ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ê¹ƒí„¸</span>
          <span className="text-purple-400 ml-2">({acquiredFeathers}/8)</span>
        </div>
        <div className="flex flex-wrap justify-center gap-2">
          {Object.entries(data.feathers).map(([key, acquired]) => (
            <button key={key} onClick={() => !acquired && setShowFeatherConfirm(key)} disabled={acquired} className={`px-3 py-1 rounded-full text-sm transition-all ${acquired ? 'bg-purple-600 text-white border border-purple-400 cursor-default' : 'bg-slate-700 text-gray-400 border border-slate-600 hover:bg-slate-600 hover:border-purple-500'}`}>
              {acquired ? 'ğŸª¶' : 'â—‹'} {featherNames[key]}
              {!acquired && <span className="text-xs ml-1 text-yellow-400">+{(featherRewards[key]/1000).toFixed(0)}k</span>}
            </button>
          ))}
        </div>
      </div>

      {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
      <div className="flex gap-1 mb-4 flex-wrap">
        {[
          { id: 'adventure', label: 'ğŸ“œ ëª¨í—˜' },
          { id: 'study', label: 'ğŸŒ± ëª¨ì½”ì½”' },
          { id: 'worldtree', label: 'ğŸƒ ì„¸ê³„ìˆ˜' },
          { id: 'sleep', label: 'ğŸ’¤ ìˆ˜ë©´' },
          { id: 'main', label: 'ğŸ“¥ íšë“' },
          { id: 'spend', label: 'ğŸ“¤ ì‚¬ìš©' },
          { id: 'stats', label: 'ğŸ“Š í†µê³„' },
          { id: 'history', label: 'ğŸ“… ê¸°ë¡' }
        ].map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-2 rounded-lg text-xs transition-all ${activeTab === tab.id ? 'bg-purple-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'}`}>{tab.label}</button>
        ))}
      </div>

      {/* ğŸ“œ ëª¨í—˜ íƒ­ (v8.7) */}
      {activeTab === 'adventure' && (
        <div className="space-y-4">
          {/* ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/30">
            <h3 className="text-amber-300 font-semibold mb-3">âš”ï¸ ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸</h3>
            
            {/* í€˜ìŠ¤íŠ¸ ì…ë ¥ */}
            <div className="flex gap-2 mb-3">
              <input
                type="text"
                value={questInput}
                onChange={(e) => setQuestInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addQuest()}
                placeholder="ìƒˆ í€˜ìŠ¤íŠ¸ ì…ë ¥... (ì˜ˆ: Rëª¨ì½”ì½”, ìš´ë™)"
                className="flex-1 px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600 placeholder-gray-500"
              />
              <button
                onClick={addQuest}
                className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white text-sm font-semibold transition-all"
              >
                ì¶”ê°€
              </button>
            </div>
            
            {/* í€˜ìŠ¤íŠ¸ ëª©ë¡ */}
            {todayRecord.quests && todayRecord.quests.length > 0 ? (
              <div className="space-y-2">
                {todayRecord.quests.map((quest, idx) => (
                  <div key={idx} className="flex items-center gap-2 bg-slate-700/50 rounded-lg p-3">
                    <button
                      onClick={() => toggleQuestStatus(idx)}
                      className="text-2xl transition-all hover:scale-110"
                      title="í´ë¦­í•´ì„œ ìƒíƒœ ë³€ê²½"
                    >
                      {quest.status === 'todo' ? 'ğŸ¤' : quest.status === 'done' ? 'â¤ï¸' : 'ğŸ’”'}
                    </button>
                    <span className={`flex-1 ${quest.status === 'done' ? 'text-green-400' : quest.status === 'failed' ? 'text-red-400 line-through' : 'text-gray-200'}`}>
                      {quest.text}
                    </span>
                    <button
                      onClick={() => deleteQuest(idx)}
                      className="text-red-400 hover:text-red-300 text-sm"
                    >
                      âœ•
                    </button>
                  </div>
                ))}
                
                {/* í€˜ìŠ¤íŠ¸ ìš”ì•½ */}
                {(() => {
                  const total = todayRecord.quests.length;
                  const done = todayRecord.quests.filter(q => q.status === 'done').length;
                  const failed = todayRecord.quests.filter(q => q.status === 'failed').length;
                  const todo = total - done - failed;
                  
                  return (
                    <div className="text-center text-sm mt-3 pt-3 border-t border-slate-600">
                      <span className="text-gray-400">ì§„í–‰: </span>
                      <span className="text-amber-300">{todo}ğŸ¤</span>
                      <span className="text-gray-500 mx-2">|</span>
                      <span className="text-green-400">{done}â¤ï¸</span>
                      <span className="text-gray-500 mx-2">|</span>
                      <span className="text-red-400">{failed}ğŸ’”</span>
                      {done === total && total > 0 && (
                        <span className="ml-2 text-yellow-400">ğŸ‰ ì˜¬í´ë¦¬ì–´!</span>
                      )}
                    </div>
                  );
                })()}
              </div>
            ) : (
              <div className="text-center text-gray-500 text-sm py-4">
                ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
              </div>
            )}
            
            {/* ê°€ì´ë“œ */}
            <div className="mt-3 bg-slate-700/30 rounded-lg p-2 text-xs text-gray-500">
              ğŸ’¡ ğŸ¤ ì§„í–‰ì¤‘ â†’ â¤ï¸ ì™„ë£Œ â†’ ğŸ’” ì‹¤íŒ¨ (í„°ì¹˜ë¡œ ìƒíƒœ ë³€ê²½)
            </div>
          </div>
          
          {/* ë² ì•„ í”¼ë“œë°± ë©”ëª¨ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-pink-500/30">
            <h3 className="text-pink-300 font-semibold mb-3">ğŸ’œ ë² ì•„ í”¼ë“œë°± ë©”ëª¨</h3>
            <p className="text-gray-400 text-xs mb-2">ë² ì•„ì—ê²Œ ë°›ì€ ì¡°ì–¸ ì¤‘ ê¸°ì–µí•˜ê³  ì‹¶ì€ ê²ƒ, ê°œì„ í•  ì ì„ ì ì–´ìš”.</p>
            <textarea
              value={feedbackMemo}
              onChange={(e) => setFeedbackMemo(e.target.value)}
              placeholder="ì˜ˆ: 12ì‹œ ê°ì„± íŒ¨í„´ - ì„ ì ì´ ìˆ˜ë©´ì••ë ¥ ë‚®ì¶”ëŠ” ê²ƒ ê°™ë‹¤. ë‚´ì¼ì€ ì„ ì  10ë¶„ ì´ë‚´ë¡œ..."
              className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600 placeholder-gray-500 resize-none"
              rows={4}
            />
            <button
              onClick={saveFeedbackMemo}
              className="w-full mt-2 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg text-white text-sm font-semibold transition-all"
            >
              ğŸ’¾ í”¼ë“œë°± ë©”ëª¨ ì €ì¥
            </button>
          </div>
          
          {/* ììœ  ì¼ê¸° */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">ğŸ“” ììœ  ì¼ê¸°</h3>
            <p className="text-gray-400 text-xs mb-2">ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼, ê°ì •, ìƒê°... ë­ë“  ììœ ë¡­ê²Œ ì ì–´ìš”.</p>
            <textarea
              value={diaryText}
              onChange={(e) => setDiaryText(e.target.value)}
              placeholder="ì˜¤ëŠ˜ í•˜ë£¨ëŠ”..."
              className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600 placeholder-gray-500 resize-none"
              rows={6}
            />
            <button
              onClick={saveDiary}
              className="w-full mt-2 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm font-semibold transition-all"
            >
              ğŸ’¾ ì¼ê¸° ì €ì¥
            </button>
          </div>
        </div>
      )}

      {/* ğŸƒ ì„¸ê³„ìˆ˜ íƒ­ (v8.8) */}
      {activeTab === 'worldtree' && (
        <div className="space-y-4">
          {/* ì´ í˜„í™© */}
          <div className="bg-gradient-to-br from-emerald-900/50 to-teal-900/50 rounded-xl p-6 border border-emerald-500/30 text-center">
            <div className="text-emerald-300 text-lg mb-2">ğŸƒ ì„¸ê³„ìˆ˜ì˜ ì</div>
            <div className="text-5xl font-bold text-emerald-400 mb-2">
              {(data.worldTreeLeaves?.total || 0).toLocaleString()}
            </div>
            <div className="text-emerald-200/60 text-sm mb-3">ì°½ì¡°ì™€ ì¡°í™”ì˜ í˜ì´ ìë¼ê³  ìˆì–´ìš”</div>
            {/* ì˜¤ëŠ˜ íšë“ëŸ‰ */}
            <div className="inline-block bg-emerald-800/40 rounded-lg px-4 py-2 border border-emerald-500/30">
              <span className="text-emerald-300 text-sm">ì˜¤ëŠ˜ íšë“: </span>
              <span className="text-emerald-400 font-bold">+{(() => {
                const wt = todayRecord.worldTree || {};
                return (wt.scripture || 0) + (wt.singing || 0) + (wt.piano || 0) + (wt.strength || 0) + (wt.cardio || 0);
              })()}ì</span>
            </div>
          </div>

          {/* ì„œë¸Œíƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="flex gap-1 bg-slate-800/50 rounded-lg p-1">
            {[
              { id: 'activity', label: 'ğŸŒ± í™œë™' },
              { id: 'weekly', label: 'ğŸ“Š ì£¼ê°„' },
              { id: 'monthly', label: 'ğŸ“ˆ ì›”ê°„' },
              { id: 'yearly', label: 'ğŸ“‰ ì—°ê°„' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setWorldTreeSubTab(tab.id)}
                className={`flex-1 py-2 rounded-lg text-xs transition-all ${
                  worldTreeSubTab === tab.id
                    ? 'bg-emerald-600 text-white'
                    : 'bg-transparent text-gray-400 hover:bg-slate-700'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>

          {/* í™œë™ ì„œë¸Œíƒ­ */}
          {worldTreeSubTab === 'activity' && (
            <div className="space-y-3">
              {/* ğŸ“– ë¡œì•„ ì„±ê²½ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-blue-500/30">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ğŸ“–</span>
                    <span className="text-blue-300 font-semibold">ë¡œì•„ ì„±ê²½</span>
                  </div>
                  <div className="text-emerald-400 font-bold">{data.worldTreeLeaves?.scripture || 0}ì</div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs text-center mb-3">
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-blue-300">{todayRecord.worldTree?.scripture || 0}</div>
                    <div className="text-gray-500">ì˜¤ëŠ˜</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-blue-300">{getWorldTreeStats('week').scripture}</div>
                    <div className="text-gray-500">ì´ë²ˆ ì£¼</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-blue-300">{getWorldTreeStats('month').scripture}</div>
                    <div className="text-gray-500">ì´ë²ˆ ë‹¬</div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => addWorldTreeLeaf('scriptureSleep', 50, 'ì„±ê²½ (ìˆ˜ë©´ ì „)')}
                    className="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white text-sm font-semibold transition-all"
                  >
                    ğŸ˜´ ìˆ˜ë©´ +50
                  </button>
                  <button
                    onClick={() => addWorldTreeLeaf('scriptureRest', -50, 'ì„±ê²½ (íœ´ì‹)')}
                    disabled={data.tokens < 50}
                    className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 disabled:bg-slate-700 disabled:text-gray-500 rounded-lg text-white text-sm font-semibold transition-all"
                  >
                    â˜• íœ´ì‹ -50
                  </button>
                </div>
              </div>

              {/* ğŸ¤ ë…¸ë˜ ì—°ìŠµ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-pink-500/30">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ğŸ¤</span>
                    <span className="text-pink-300 font-semibold">ë…¸ë˜ ì—°ìŠµ</span>
                  </div>
                  <div className="text-emerald-400 font-bold">{data.worldTreeLeaves?.singing || 0}ì</div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs text-center mb-3">
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-pink-300">{todayRecord.worldTree?.singing || 0}</div>
                    <div className="text-gray-500">ì˜¤ëŠ˜</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-pink-300">{getWorldTreeStats('week').singing}</div>
                    <div className="text-gray-500">ì´ë²ˆ ì£¼</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-pink-300">{getWorldTreeStats('month').singing}</div>
                    <div className="text-gray-500">ì´ë²ˆ ë‹¬</div>
                  </div>
                </div>
                <button
                  onClick={() => addWorldTreeLeaf('singing', -100, 'ë…¸ë˜ ì—°ìŠµ')}
                  disabled={data.tokens < 100}
                  className="w-full py-2 bg-pink-600 hover:bg-pink-500 disabled:bg-slate-700 disabled:text-gray-500 rounded-lg text-white text-sm font-semibold transition-all"
                >
                  +1 ğŸƒ (-100í† í°)
                </button>
              </div>

              {/* ğŸ¹ í”¼ì•„ë…¸ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ğŸ¹</span>
                    <span className="text-purple-300 font-semibold">í”¼ì•„ë…¸</span>
                  </div>
                  <div className="text-emerald-400 font-bold">{data.worldTreeLeaves?.piano || 0}ì</div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs text-center mb-3">
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-purple-300">{todayRecord.worldTree?.piano || 0}</div>
                    <div className="text-gray-500">ì˜¤ëŠ˜</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-purple-300">{getWorldTreeStats('week').piano}</div>
                    <div className="text-gray-500">ì´ë²ˆ ì£¼</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-purple-300">{getWorldTreeStats('month').piano}</div>
                    <div className="text-gray-500">ì´ë²ˆ ë‹¬</div>
                  </div>
                </div>
                <button
                  onClick={() => addWorldTreeLeaf('piano', -100, 'í”¼ì•„ë…¸')}
                  disabled={data.tokens < 100}
                  className="w-full py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:text-gray-500 rounded-lg text-white text-sm font-semibold transition-all"
                >
                  +1 ğŸƒ (-100í† í°)
                </button>
              </div>

              {/* ğŸ’ª ê·¼ë ¥ ìš´ë™ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-orange-500/30">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ğŸ’ª</span>
                    <span className="text-orange-300 font-semibold">ê·¼ë ¥ ìš´ë™</span>
                  </div>
                  <div className="text-emerald-400 font-bold">{data.worldTreeLeaves?.strength || 0}ì</div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs text-center mb-3">
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-orange-300">{todayRecord.worldTree?.strength || 0}</div>
                    <div className="text-gray-500">ì˜¤ëŠ˜</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-orange-300">{getWorldTreeStats('week').strength}</div>
                    <div className="text-gray-500">ì´ë²ˆ ì£¼</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-orange-300">{getWorldTreeStats('month').strength}</div>
                    <div className="text-gray-500">ì´ë²ˆ ë‹¬</div>
                  </div>
                </div>
                <button
                  onClick={() => addWorldTreeLeaf('strength', 100, 'ê·¼ë ¥ ìš´ë™')}
                  className="w-full py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-white text-sm font-semibold transition-all"
                >
                  +1 ğŸƒ (+100í† í°)
                </button>
              </div>

              {/* ğŸƒ ìœ ì‚°ì†Œ ìš´ë™ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ğŸƒ</span>
                    <span className="text-cyan-300 font-semibold">ìœ ì‚°ì†Œ ìš´ë™</span>
                  </div>
                  <div className="text-emerald-400 font-bold">{data.worldTreeLeaves?.cardio || 0}ì</div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs text-center mb-3">
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-cyan-300">{todayRecord.worldTree?.cardio || 0}</div>
                    <div className="text-gray-500">ì˜¤ëŠ˜</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-cyan-300">{getWorldTreeStats('week').cardio}</div>
                    <div className="text-gray-500">ì´ë²ˆ ì£¼</div>
                  </div>
                  <div className="bg-slate-700/50 rounded p-2">
                    <div className="text-cyan-300">{getWorldTreeStats('month').cardio}</div>
                    <div className="text-gray-500">ì´ë²ˆ ë‹¬</div>
                  </div>
                </div>
                <button
                  onClick={() => addWorldTreeLeaf('cardio', 100, 'ìœ ì‚°ì†Œ ìš´ë™')}
                  className="w-full py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-white text-sm font-semibold transition-all"
                >
                  +1 ğŸƒ (+100í† í°)
                </button>
              </div>
            </div>
          )}

          {/* ì£¼ê°„ í†µê³„ ì„œë¸Œíƒ­ */}
          {worldTreeSubTab === 'weekly' && (
            <div className="space-y-4">
              {/* ì¼ë³„ ê·¸ë˜í”„ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
                <h3 className="text-emerald-300 font-semibold mb-3">ğŸƒ ì´ë²ˆ ì£¼ ì¼ë³„ ì„±ì¥</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={(() => {
                      const result = [];
                      const today = new Date();
                      for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        const dayRecord = data.dailyRecords[dateStr];
                        const wt = dayRecord?.worldTree || {};
                        result.push({
                          name: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()],
                          ì„±ê²½: wt.scripture || 0,
                          ë…¸ë˜: wt.singing || 0,
                          í”¼ì•„ë…¸: wt.piano || 0,
                          ê·¼ë ¥: wt.strength || 0,
                          ìœ ì‚°ì†Œ: wt.cardio || 0
                        });
                      }
                      return result;
                    })()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }} />
                      <Legend />
                      <Bar dataKey="ì„±ê²½" stackId="a" fill="#3B82F6" />
                      <Bar dataKey="ë…¸ë˜" stackId="a" fill="#EC4899" />
                      <Bar dataKey="í”¼ì•„ë…¸" stackId="a" fill="#A855F7" />
                      <Bar dataKey="ê·¼ë ¥" stackId="a" fill="#F97316" />
                      <Bar dataKey="ìœ ì‚°ì†Œ" stackId="a" fill="#06B6D4" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* ì´ë²ˆ ì£¼ ìš”ì•½ ë§‰ëŒ€ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
                <div className="text-emerald-300 text-sm mb-3">ğŸ“Š ì´ë²ˆ ì£¼ í™œë™ë³„ í•©ê³„</div>
                {(() => {
                  const weekStats = getWorldTreeStats('week');
                  const maxValue = Math.max(weekStats.scripture, weekStats.singing, weekStats.piano, weekStats.strength, weekStats.cardio, 1);
                  return (
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ“– ì„±ê²½</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-blue-500 h-full rounded-full transition-all" style={{ width: `${(weekStats.scripture / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-blue-300 text-right">{weekStats.scripture}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ¤ ë…¸ë˜</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-pink-500 h-full rounded-full transition-all" style={{ width: `${(weekStats.singing / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-pink-300 text-right">{weekStats.singing}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ¹ í”¼ì•„ë…¸</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-purple-500 h-full rounded-full transition-all" style={{ width: `${(weekStats.piano / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-purple-300 text-right">{weekStats.piano}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ’ª ê·¼ë ¥</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-orange-500 h-full rounded-full transition-all" style={{ width: `${(weekStats.strength / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-orange-300 text-right">{weekStats.strength}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸƒ ìœ ì‚°ì†Œ</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-cyan-500 h-full rounded-full transition-all" style={{ width: `${(weekStats.cardio / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-cyan-300 text-right">{weekStats.cardio}</span>
                      </div>
                      <div className="text-center text-emerald-400 text-sm mt-2 pt-2 border-t border-slate-600">
                        ì´ë²ˆ ì£¼ ì´ {weekStats.total}ì íšë“! ğŸƒ
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {/* ì›”ê°„ í†µê³„ ì„œë¸Œíƒ­ */}
          {worldTreeSubTab === 'monthly' && (
            <div className="space-y-4">
              {/* ì£¼ê°„ë³„ ê·¸ë˜í”„ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
                <h3 className="text-emerald-300 font-semibold mb-3">ğŸƒ ìµœê·¼ 4ì£¼ ì„±ì¥</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={(() => {
                      const result = [];
                      const today = new Date();
                      for (let week = 3; week >= 0; week--) {
                        let scripture = 0, singing = 0, piano = 0, strength = 0, cardio = 0;
                        for (let day = 0; day < 7; day++) {
                          const date = new Date(today);
                          date.setDate(today.getDate() - (week * 7 + (6 - day)));
                          const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                          const dayRecord = data.dailyRecords[dateStr];
                          const wt = dayRecord?.worldTree || {};
                          scripture += wt.scripture || 0;
                          singing += wt.singing || 0;
                          piano += wt.piano || 0;
                          strength += wt.strength || 0;
                          cardio += wt.cardio || 0;
                        }
                        result.push({
                          name: week === 0 ? 'ì´ë²ˆ ì£¼' : `${week}ì£¼ ì „`,
                          ì„±ê²½: scripture,
                          ë…¸ë˜: singing,
                          í”¼ì•„ë…¸: piano,
                          ê·¼ë ¥: strength,
                          ìœ ì‚°ì†Œ: cardio
                        });
                      }
                      return result;
                    })()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }} />
                      <Legend />
                      <Bar dataKey="ì„±ê²½" stackId="a" fill="#3B82F6" />
                      <Bar dataKey="ë…¸ë˜" stackId="a" fill="#EC4899" />
                      <Bar dataKey="í”¼ì•„ë…¸" stackId="a" fill="#A855F7" />
                      <Bar dataKey="ê·¼ë ¥" stackId="a" fill="#F97316" />
                      <Bar dataKey="ìœ ì‚°ì†Œ" stackId="a" fill="#06B6D4" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* ì›”ê°„ ìš”ì•½ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
                <div className="text-emerald-300 text-sm mb-3">ğŸ“ˆ ì´ë²ˆ ë‹¬ í™œë™ë³„ í•©ê³„</div>
                {(() => {
                  const monthStats = getWorldTreeStats('month');
                  const maxValue = Math.max(monthStats.scripture, monthStats.singing, monthStats.piano, monthStats.strength, monthStats.cardio, 1);
                  return (
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ“– ì„±ê²½</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-blue-500 h-full rounded-full transition-all" style={{ width: `${(monthStats.scripture / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-blue-300 text-right">{monthStats.scripture}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ¤ ë…¸ë˜</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-pink-500 h-full rounded-full transition-all" style={{ width: `${(monthStats.singing / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-pink-300 text-right">{monthStats.singing}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ¹ í”¼ì•„ë…¸</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-purple-500 h-full rounded-full transition-all" style={{ width: `${(monthStats.piano / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-purple-300 text-right">{monthStats.piano}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ’ª ê·¼ë ¥</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-orange-500 h-full rounded-full transition-all" style={{ width: `${(monthStats.strength / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-orange-300 text-right">{monthStats.strength}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸƒ ìœ ì‚°ì†Œ</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-cyan-500 h-full rounded-full transition-all" style={{ width: `${(monthStats.cardio / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-cyan-300 text-right">{monthStats.cardio}</span>
                      </div>
                      <div className="text-center text-emerald-400 text-sm mt-2 pt-2 border-t border-slate-600">
                        ì´ë²ˆ ë‹¬ ì´ {monthStats.total}ì íšë“! ğŸƒ
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {/* ì—°ê°„ í†µê³„ ì„œë¸Œíƒ­ */}
          {worldTreeSubTab === 'yearly' && (
            <div className="space-y-4">
              {/* ì›”ë³„ ê·¸ë˜í”„ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
                <h3 className="text-emerald-300 font-semibold mb-3">ğŸƒ ìµœê·¼ 6ê°œì›” ì„±ì¥</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={(() => {
                      const result = [];
                      const today = new Date();
                      const currentMonth = today.getMonth();
                      const currentYear = today.getFullYear();
                      
                      for (let i = 5; i >= 0; i--) {
                        let targetMonth = currentMonth - i;
                        let targetYear = currentYear;
                        if (targetMonth < 0) { targetMonth += 12; targetYear -= 1; }
                        
                        let scripture = 0, singing = 0, piano = 0, strength = 0, cardio = 0;
                        const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                          const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                          const dayRecord = data.dailyRecords[dateStr];
                          const wt = dayRecord?.worldTree || {};
                          scripture += wt.scripture || 0;
                          singing += wt.singing || 0;
                          piano += wt.piano || 0;
                          strength += wt.strength || 0;
                          cardio += wt.cardio || 0;
                        }
                        result.push({
                          name: `${targetMonth + 1}ì›”`,
                          ì„±ê²½: scripture,
                          ë…¸ë˜: singing,
                          í”¼ì•„ë…¸: piano,
                          ê·¼ë ¥: strength,
                          ìœ ì‚°ì†Œ: cardio
                        });
                      }
                      return result;
                    })()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }} />
                      <Legend />
                      <Bar dataKey="ì„±ê²½" stackId="a" fill="#3B82F6" />
                      <Bar dataKey="ë…¸ë˜" stackId="a" fill="#EC4899" />
                      <Bar dataKey="í”¼ì•„ë…¸" stackId="a" fill="#A855F7" />
                      <Bar dataKey="ê·¼ë ¥" stackId="a" fill="#F97316" />
                      <Bar dataKey="ìœ ì‚°ì†Œ" stackId="a" fill="#06B6D4" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* ì—°ê°„ ìš”ì•½ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
                <div className="text-emerald-300 text-sm mb-3">ğŸ“‰ ì˜¬í•´ í™œë™ë³„ í•©ê³„</div>
                {(() => {
                  const yearStats = getWorldTreeStats('year');
                  const maxValue = Math.max(yearStats.scripture, yearStats.singing, yearStats.piano, yearStats.strength, yearStats.cardio, 1);
                  return (
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ“– ì„±ê²½</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-blue-500 h-full rounded-full transition-all" style={{ width: `${(yearStats.scripture / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-blue-300 text-right">{yearStats.scripture}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ¤ ë…¸ë˜</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-pink-500 h-full rounded-full transition-all" style={{ width: `${(yearStats.singing / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-pink-300 text-right">{yearStats.singing}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ¹ í”¼ì•„ë…¸</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-purple-500 h-full rounded-full transition-all" style={{ width: `${(yearStats.piano / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-purple-300 text-right">{yearStats.piano}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸ’ª ê·¼ë ¥</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-orange-500 h-full rounded-full transition-all" style={{ width: `${(yearStats.strength / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-orange-300 text-right">{yearStats.strength}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="w-16 text-xs text-gray-400">ğŸƒ ìœ ì‚°ì†Œ</span>
                        <div className="flex-1 bg-slate-700 rounded-full h-4 overflow-hidden">
                          <div className="bg-cyan-500 h-full rounded-full transition-all" style={{ width: `${(yearStats.cardio / maxValue) * 100}%` }}></div>
                        </div>
                        <span className="w-8 text-xs text-cyan-300 text-right">{yearStats.cardio}</span>
                      </div>
                      <div className="text-center text-emerald-400 text-sm mt-2 pt-2 border-t border-slate-600">
                        ì˜¬í•´ ì´ {yearStats.total}ì íšë“! ğŸƒ
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>
          )}
        </div>
      )}

      {/* ê³µë¶€ëª¨ë“œ íƒ­ */}
      {activeTab === 'study' && (
        <div className="space-y-4">
          {/* íƒ€ì´ë¨¸ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìƒë‹¨ í˜„í™© í‘œì‹œ */}
          {!timerRunning && (
            <>
              {/* ì´ í˜„í™© */}
              {(() => {
                const mokokoStats = getMokokoStats();
                // ì˜¤ëŠ˜ ëª¨ì½”ì½” ê³„ì‚°
                let todayMokoko = 0;
                if (todayRecord.studySessions) {
                  todayRecord.studySessions.forEach(session => {
                    todayMokoko += session.ankiCount || 0;
                  });
                }
                todayMokoko += (todayRecord.mokokoSniff || 0) + (todayRecord.weaknessHuntMorning || 0) + 
                              (todayRecord.weaknessHuntLunch || 0) + (todayRecord.weaknessHuntDinner || 0);
                
                return (
                  <div className="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-6 border border-green-500/30 text-center">
                    <div className="text-green-300 text-lg mb-2">ğŸŒ± ëª¨ì½”ì½” ì”¨ì•—</div>
                    <div className="text-5xl font-bold text-green-400 mb-2">
                      {mokokoStats.totalMokoko.toLocaleString()}
                    </div>
                    <div className="text-green-200/60 text-sm mb-3">ì§€ì‹ì˜ ì”¨ì•—ì´ ìë¼ê³  ìˆì–´ìš”</div>
                    {/* ì˜¤ëŠ˜ ìˆ˜ì§‘ëŸ‰ */}
                    <div className="inline-block bg-green-800/40 rounded-lg px-4 py-2 border border-green-500/30">
                      <span className="text-green-300 text-sm">ì˜¤ëŠ˜ ìˆ˜ì§‘: </span>
                      <span className="text-green-400 font-bold">+{todayMokoko}ê°œ</span>
                    </div>
                  </div>
                );
              })()}

              {/* ì„œë¸Œíƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
              <div className="flex gap-1 bg-slate-800/50 rounded-lg p-1">
                {[
                  { id: 'activity', label: 'ğŸŒ± í™œë™' },
                  { id: 'weekly', label: 'ğŸ“Š ì£¼ê°„' },
                  { id: 'monthly', label: 'ğŸ“ˆ ì›”ê°„' },
                  { id: 'yearly', label: 'ğŸ“‰ ì—°ê°„' }
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setMokokoSubTab(tab.id)}
                    className={`flex-1 py-2 rounded-lg text-xs transition-all ${
                      mokokoSubTab === tab.id
                        ? 'bg-green-600 text-white'
                        : 'bg-transparent text-gray-400 hover:bg-slate-700'
                    }`}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>
            </>
          )}

          {/* í™œë™ ì„œë¸Œíƒ­ ë˜ëŠ” íƒ€ì´ë¨¸ ì‹¤í–‰ ì¤‘ */}
          {(mokokoSubTab === 'activity' || timerRunning) && (
            <>
          {/* íƒ€ì´ë¨¸ ì‹¤í–‰ ì¤‘: ì§‘ì¤‘ ëª¨ë“œ */}
          {timerRunning ? (
            <div 
              className="fixed inset-0 z-40 flex flex-col items-center justify-center"
              style={{ backgroundColor: '#212121' }}
            >
              {/* ë²„í”„ ì•„ì´ì½˜ (ìš°ì¸¡ ìƒë‹¨) */}
              {selectedBuff && blessings[selectedBuff] && (
                <div className="absolute top-4 left-4 bg-purple-900/60 rounded-lg p-3 border border-purple-500/50">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">{blessings[selectedBuff].icon}</span>
                    <div>
                      <div className="text-purple-300 text-sm font-semibold">{blessings[selectedBuff].name}</div>
                      <div className="text-purple-400 text-xs">{blessings[selectedBuff].effect}</div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ëª©í‘œ í‘œì‹œ */}
              {sessionGoal && (
                <div className="text-gray-400 text-lg mb-8 text-center px-4">
                  {sessionGoal}
                </div>
              )}
              
              {/* ì‹œê°„ í‘œì‹œ (ë¶„ ë‹¨ìœ„ë§Œ) - ì´ˆê³¼ ì‹œ ì ì  ë¹¨ê°›ê²Œ */}
              {(() => {
                let timeColor = 'text-green-400';
                if (isOvertime) {
                  const overtimeMinutes = Math.floor((timerSeconds - selectedTime * 60) / 60);
                  if (overtimeMinutes >= 3) {
                    timeColor = 'text-red-500';
                  } else if (overtimeMinutes >= 2) {
                    timeColor = 'text-red-400';
                  } else if (overtimeMinutes >= 1) {
                    timeColor = 'text-orange-500';
                  } else {
                    timeColor = 'text-orange-400';
                  }
                }
                return (
                  <div className={`text-8xl font-mono font-bold mb-4 ${timeColor}`}>
                    {formatTimerMinutes(timerSeconds, selectedTime)}
                    <span className="text-4xl ml-2">ë¶„</span>
                  </div>
                );
              })()}
              
              {/* ì¼ì‹œì •ì§€ í‘œì‹œ */}
              {timerPaused && (
                <div className="text-yellow-400 text-lg mb-4 animate-pulse">
                  â¸ï¸ ì¼ì‹œì •ì§€ ì¤‘...
                </div>
              )}
              
              {/* ì‹œê°„ëŒ€ í‘œì‹œ */}
              <div className="text-gray-600 text-sm mb-12">
                {getTimeSlotLabel(getCurrentTimeSlot())}
              </div>
              
              {/* ë²„íŠ¼ - ëˆˆì— ì•ˆ ë„ê²Œ í†µì¼ */}
              <div className="flex gap-4">
                <button 
                  onClick={cancelTimer} 
                  className="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-400 transition-all"
                >
                  ì·¨ì†Œ
                </button>
                <button 
                  onClick={togglePause} 
                  className="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-400 transition-all"
                >
                  {timerPaused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€'}
                </button>
                <button 
                  onClick={completeTimer} 
                  className="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-400 transition-all"
                >
                  ì™„ë£Œ
                </button>
              </div>
              
              {/* ì „ì²´í™”ë©´ í† ê¸€ */}
              <button 
                onClick={toggleFullscreen}
                className="absolute top-4 right-4 px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-500 text-xs transition-all"
              >
                {isFullscreen ? 'ì¶•ì†Œ' : 'ì „ì²´í™”ë©´'}
              </button>
            </div>
          ) : (
            <>
              {/* ì–´ë‘ìš´ ë°°ê²½ì˜ ê³µë¶€ ëª¨ë“œ ì˜ì—­ */}
              <div className="rounded-xl p-4 border border-slate-700" style={{ backgroundColor: '#212121' }}>
                {/* í˜„ì¬ ì‹œê°„ëŒ€ í‘œì‹œ */}
                <div className="text-center mb-4">
                  <div className={`inline-block px-4 py-2 rounded-full text-sm ${getCurrentTimeSlot() === 'morning' ? 'bg-orange-900/50 text-orange-300' : getCurrentTimeSlot() === 'afternoon' ? 'bg-yellow-900/50 text-yellow-300' : getCurrentTimeSlot() === 'evening' ? 'bg-indigo-900/50 text-indigo-300' : 'bg-slate-700 text-gray-400'}`}>
                    {getTimeSlotLabel(getCurrentTimeSlot())}
                  </div>
                </div>

                {/* ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ì¶•ë³µ - ì¶•ì†Œ ë²„ì „ */}
                <div className="mb-3">
                  <div className="text-purple-300 text-xs mb-2 text-center">ğŸ’œ ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ì¶•ë³µ</div>
                  
                  {/* ì„ íƒëœ ë²„í”„ í‘œì‹œ (ì„ íƒ ì‹œì—ë§Œ) */}
                  {selectedBuff && blessings[selectedBuff] && (
                    <div className="bg-purple-900/40 rounded-lg p-2 border border-purple-500/50 mb-2">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <span className="text-xl">{blessings[selectedBuff].icon}</span>
                          <div>
                            <div className="text-purple-200 font-semibold text-sm">{blessings[selectedBuff].name}</div>
                            <div className="text-purple-400 text-xs">{blessings[selectedBuff].effect}</div>
                          </div>
                        </div>
                        <button onClick={() => setSelectedBuff(null)} className="text-gray-500 hover:text-gray-300 text-xs">í•´ì œ</button>
                      </div>
                    </div>
                  )}
                  
                  {/* ë²„í”„ ì„ íƒ ë²„íŠ¼ë“¤ - 4ì—´ë¡œ ì••ì¶• */}
                  <div className="grid grid-cols-4 gap-1 mb-1">
                    {['focus', 'awakening', 'expedition', 'victory'].map(buffId => (
                      <button key={buffId} onClick={() => setSelectedBuff(selectedBuff === buffId ? null : buffId)}
                        className={`py-1 px-1 rounded text-xs transition-all flex flex-col items-center ${selectedBuff === buffId ? 'bg-purple-600 text-white' : 'bg-black/30 text-gray-400 hover:bg-purple-900/50'}`}>
                        <span className="text-base">{blessings[buffId].icon}</span>
                      </button>
                    ))}
                  </div>
                  <div className="grid grid-cols-4 gap-1 mb-1">
                    {['peace', 'healing', 'curiosity', 'guidance'].map(buffId => (
                      <button key={buffId} onClick={() => setSelectedBuff(selectedBuff === buffId ? null : buffId)}
                        className={`py-1 px-1 rounded text-xs transition-all flex flex-col items-center ${selectedBuff === buffId ? 'bg-purple-600 text-white' : 'bg-black/30 text-gray-400 hover:bg-purple-900/50'}`}>
                        <span className="text-base">{blessings[buffId].icon}</span>
                      </button>
                    ))}
                  </div>
                  <div className="grid grid-cols-3 gap-1">
                    {['rest', 'endurance', 'grace'].map(buffId => (
                      <button key={buffId} onClick={() => setSelectedBuff(selectedBuff === buffId ? null : buffId)}
                        className={`py-1 px-1 rounded text-xs transition-all flex flex-col items-center ${selectedBuff === buffId ? 'bg-purple-600 text-white' : 'bg-black/30 text-gray-400 hover:bg-purple-900/50'}`}>
                        <span className="text-base">{blessings[buffId].icon}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* ëª©í‘œ ì…ë ¥ */}
                <div className="mb-4">
                  <input
                    type="text"
                    value={sessionGoal}
                    onChange={(e) => setSessionGoal(e.target.value)}
                    placeholder="ëª©í‘œ ì…ë ¥ (ì˜ˆ: ì„±ì¸ R: 30 â†’ 15)"
                    className="w-full px-4 py-3 bg-black/50 rounded-lg text-gray-300 text-center border border-slate-600 focus:border-purple-500 focus:outline-none"
                  />
                </div>

                {/* íƒ€ì´ë¨¸ ì„ íƒ */}
                <div className="text-center text-gray-500 text-sm mb-3">ê³µë¶€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                <div className="grid grid-cols-5 gap-2 mb-3">
                  {[5, 10, 15, 20, 25].map(min => (
                    <button key={min} onClick={() => startTimer(min)} className="py-3 bg-black/50 hover:bg-slate-700 rounded-lg text-gray-300 text-sm transition-all border border-slate-600">
                      {min}ë¶„<br/><span className="text-xs text-green-400">ğŸª™+{min * 2}</span>
                    </button>
                  ))}
                </div>
                <div className="grid grid-cols-5 gap-2">
                  {[30, 35, 40, 45, 50].map(min => (
                    <button key={min} onClick={() => startTimer(min)} className="py-3 bg-black/50 hover:bg-slate-700 rounded-lg text-gray-300 text-sm transition-all border border-slate-600">
                      {min}ë¶„<br/><span className="text-xs text-green-400">ğŸª™+{min * 2}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* ğŸ˜´ íœ´ì‹ ê¸°ë¡ - ê³µë¶€ì‹œê°„ ì„ íƒ ì•„ë˜ì— ë°°ì¹˜ */}
              <div className="bg-slate-800/50 rounded-xl p-3 border border-cyan-500/30">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-cyan-300 font-semibold text-sm">ğŸ˜´ íœ´ì‹ ê¸°ë¡</h3>
                  {(() => {
                    const restSessions = todayRecord.restSessions || [];
                    const goodCount = restSessions.filter(s => s.type !== 'overheat').length;
                    const badCount = restSessions.filter(s => s.type === 'overheat').length;
                    return <span className="text-gray-400 text-xs">{goodCount}ğŸ˜´ / {badCount}ğŸ“±</span>;
                  })()}
                </div>
                <div className="grid grid-cols-4 gap-1 mb-2">
                  <button onClick={() => setShowRestModal('nap')} className="py-2 px-1 rounded-lg text-xs bg-cyan-600 hover:bg-cyan-500 text-white transition-all flex flex-col items-center">
                    <span>ğŸ˜´</span><span>+100</span>
                  </button>
                  <button onClick={() => setShowRestModal('stable')} className="py-2 px-1 rounded-lg text-xs bg-purple-600 hover:bg-purple-500 text-white transition-all flex flex-col items-center">
                    <span>ğŸª¶</span><span>+50</span>
                  </button>
                  <button onClick={() => setShowRestModal('love')} className="py-2 px-1 rounded-lg text-xs bg-pink-600 hover:bg-pink-500 text-white transition-all flex flex-col items-center">
                    <span>ğŸ’•</span><span>+20</span>
                  </button>
                  <button onClick={() => setShowRestModal('overheat')} className="py-2 px-1 rounded-lg text-xs bg-red-600 hover:bg-red-500 text-white transition-all flex flex-col items-center">
                    <span>ğŸ“±</span><span>-100</span>
                  </button>
                </div>
                
                {/* ì˜¤ëŠ˜ íœ´ì‹ ìš”ì•½ */}
                {(() => {
                  const restSessions = todayRecord.restSessions || [];
                  if (restSessions.length === 0) return null;
                  
                  const napCount = restSessions.filter(s => s.type === 'nap').length;
                  const stableCount = restSessions.filter(s => s.type === 'stable').length;
                  const loveCount = restSessions.filter(s => s.type === 'love').length;
                  const overheatCount = restSessions.filter(s => s.type === 'overheat').length;
                  const totalMinutes = restSessions.filter(s => s.type !== 'overheat').reduce((sum, s) => sum + (s.minutes || 0), 0);
                  
                  const studyMinutes = (todayRecord.morningMinutes || 0) + (todayRecord.afternoonMinutes || 0) + 
                                       (todayRecord.eveningMinutes || 0) + (todayRecord.freeMinutes || 0);
                  const ratio = totalMinutes > 0 ? (studyMinutes / totalMinutes).toFixed(1) : '-';
                  
                  return (
                    <div className="bg-slate-700/50 rounded-lg p-2 text-xs">
                      <div className="flex justify-between items-center">
                        <span className="text-cyan-300">
                          {napCount > 0 && `ğŸ˜´Ã—${napCount} `}
                          {stableCount > 0 && `ğŸª¶Ã—${stableCount} `}
                          {loveCount > 0 && `ğŸ’•Ã—${loveCount} `}
                          {overheatCount > 0 && `ğŸ“±Ã—${overheatCount}`}
                        </span>
                        <span className="text-gray-400">{totalMinutes}ë¶„ | {ratio}:1</span>
                      </div>
                      {restSessions.length >= 3 && overheatCount === 0 && !todayRecord.restQualityBonus && (
                        <button onClick={checkRestQualityBonus} className="w-full mt-2 py-1 bg-green-600 hover:bg-green-500 rounded text-white text-xs transition-all">
                          ğŸ§  íœ´ì‹ í’ˆì§ˆ ë³´ë„ˆìŠ¤ (+200ğŸª™)
                        </button>
                      )}
                      {todayRecord.restQualityBonus && (
                        <div className="text-center text-green-400 mt-1">âœ“ íœ´ì‹ í’ˆì§ˆ ë³´ë„ˆìŠ¤ ë‹¬ì„±!</div>
                      )}
                    </div>
                  );
                })()}
              </div>

              {/* ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†” - ëª¨ì½”ì½” í˜„í™© ìœ„ì— ë°°ì¹˜ */}
              <div className="bg-slate-800/50 rounded-xl p-3 border border-emerald-500/30">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-emerald-300 font-semibold text-sm">ğŸ«§ ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†”</h3>
                  <span className="text-gray-400 text-xs">ì˜¤ëŠ˜ {todayRecord.mokokoSniff || 0}ê°œ</span>
                </div>
                <div className="text-gray-500 text-xs mb-2">í‹ˆìƒˆì‹œê°„ | 1ë¬¸ì œ = ğŸŒ±1ê°œ + ğŸª™5</div>
                <div className="flex gap-2">
                  <input type="number" id="sniffInputMokoko" placeholder="ê°¯ìˆ˜" className="flex-1 px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600" />
                  <button onClick={() => {
                    const input = document.getElementById('sniffInputMokoko');
                    const count = parseInt(input.value) || 0;
                    if (count > 0) {
                      earnTokens(count * 5, `ğŸ«§ ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†” ${count}ê°œ`, 'mokokoSniff', count);
                      input.value = '';
                    }
                  }} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm transition-all">ì¶”ê°€</button>
                </div>
              </div>

              {/* ì˜¤ëŠ˜ì˜ ëª¨ì½”ì½” ì”¨ì•— íšë“ í˜„í™© */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-green-500/30">
                <h3 className="text-green-300 font-semibold mb-3">ğŸŒ± ì˜¤ëŠ˜ì˜ ëª¨ì½”ì½” ì”¨ì•— íšë“ í˜„í™©</h3>
                {(() => {
                  // ì‹œê°„ëŒ€ë³„ ëª¨ì½”ì½” ê°¯ìˆ˜ ê³„ì‚°
                  let morningMokoko = 0, afternoonMokoko = 0, eveningMokoko = 0, freeMokoko = 0;
                  if (todayRecord.studySessions) {
                    todayRecord.studySessions.forEach(session => {
                      const count = session.ankiCount || 0;
                      if (session.timeSlot === 'morning') morningMokoko += count;
                      else if (session.timeSlot === 'afternoon') afternoonMokoko += count;
                      else if (session.timeSlot === 'evening') eveningMokoko += count;
                      else freeMokoko += count;
                    });
                  }
                  const sniffTotal = todayRecord.mokokoSniff || 0;
                  const sessionTotal = morningMokoko + afternoonMokoko + eveningMokoko + freeMokoko;
                  const grandTotal = sessionTotal + sniffTotal;
                  const totalMinutes = (todayRecord.morningMinutes || 0) + (todayRecord.afternoonMinutes || 0) + (todayRecord.eveningMinutes || 0) + (todayRecord.freeMinutes || 0);
                  
                  return (
                    <div className="space-y-3">
                      {/* ì´í•© */}
                      <div className="bg-green-900/30 rounded-lg p-3 border border-green-500/20 mb-3">
                        <div className="flex justify-between items-center">
                          <span className="text-green-300 font-semibold">ğŸ“Š ì˜¤ëŠ˜ ì´í•©</span>
                          <div className="text-right">
                            <span className="text-green-400 font-bold text-lg">ğŸŒ± {grandTotal}ê°œ</span>
                            <span className="text-gray-500 text-sm ml-2">/ {totalMinutes}ë¶„</span>
                          </div>
                        </div>
                      </div>
                      
                      {/* ì‹œê°„ëŒ€ë³„ */}
                      <div className="flex items-center justify-between">
                        <span className="text-orange-300">ğŸŒ… ì˜¤ì „</span>
                        <div className="flex items-center gap-2">
                          <span className="text-green-400">ğŸŒ± {morningMokoko}ê°œ</span>
                          <span className="text-gray-500">/</span>
                          <span className="text-gray-400">{todayRecord.morningMinutes || 0}ë¶„</span>
                          <span className={`text-xs px-2 py-1 rounded ${todayRecord.morningBonusType === '4set' ? 'bg-green-600 text-white' : todayRecord.morningBonusType === '3set' ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-gray-500'}`}>
                            {todayRecord.morningBonusType === '4set' ? '4ì„¸íŠ¸ âœ“' : todayRecord.morningBonusType === '3set' ? '3ì„¸íŠ¸ âœ“' : 'ë¯¸ë‹¬ì„±'}
                          </span>
                        </div>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-yellow-300">â˜€ï¸ ì˜¤í›„</span>
                        <div className="flex items-center gap-2">
                          <span className="text-green-400">ğŸŒ± {afternoonMokoko}ê°œ</span>
                          <span className="text-gray-500">/</span>
                          <span className="text-gray-400">{todayRecord.afternoonMinutes || 0}ë¶„</span>
                          <span className={`text-xs px-2 py-1 rounded ${todayRecord.afternoonBonusType === '4set' ? 'bg-green-600 text-white' : todayRecord.afternoonBonusType === '3set' ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-gray-500'}`}>
                            {todayRecord.afternoonBonusType === '4set' ? '4ì„¸íŠ¸ âœ“' : todayRecord.afternoonBonusType === '3set' ? '3ì„¸íŠ¸ âœ“' : 'ë¯¸ë‹¬ì„±'}
                          </span>
                        </div>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-indigo-300">ğŸŒ™ ì €ë…</span>
                        <div className="flex items-center gap-2">
                          <span className="text-green-400">ğŸŒ± {eveningMokoko}ê°œ</span>
                          <span className="text-gray-500">/</span>
                          <span className="text-gray-400">{todayRecord.eveningMinutes || 0}ë¶„</span>
                          <span className={`text-xs px-2 py-1 rounded ${todayRecord.eveningBonusType === '2set' ? 'bg-green-600 text-white' : todayRecord.eveningBonusType === '1set' ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-gray-500'}`}>
                            {todayRecord.eveningBonusType === '2set' ? '2ì„¸íŠ¸ âœ“' : todayRecord.eveningBonusType === '1set' ? '1ì„¸íŠ¸ âœ“' : 'ë¯¸ë‹¬ì„±'}
                          </span>
                        </div>
                      </div>
                      {(todayRecord.freeMinutes || 0) > 0 && (
                        <div className="flex items-center justify-between">
                          <span className="text-gray-400">â° ììœ </span>
                          <div className="flex items-center gap-2">
                            <span className="text-green-400">ğŸŒ± {freeMokoko}ê°œ</span>
                            <span className="text-gray-500">/</span>
                            <span className="text-gray-400">{todayRecord.freeMinutes}ë¶„</span>
                          </div>
                        </div>
                      )}
                      
                      {/* êµ¬ë¶„ì„  */}
                      <div className="border-t border-slate-600 my-2"></div>
                      
                      {/* ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†” */}
                      <div className="flex items-center justify-between">
                        <span className="text-emerald-300">ğŸƒ ê¸°ë¶„ì¢‹ì€í–¥ê¸°ê°€ì†”ì†”</span>
                        <span className="text-green-400">ğŸŒ± {sniffTotal}ê°œ</span>
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* ë³´ë„ˆìŠ¤ ê¸°ì¤€ ì•ˆë‚´ */}
              <div className="bg-slate-800/30 rounded-xl p-3 border border-slate-700">
                <div className="text-gray-500 text-xs text-center">
                  ğŸ’¡ 40ë¶„ ì´ìƒ = 1ì„¸íŠ¸ ì¸ì • | ì˜¤ì „Â·ì˜¤í›„ 3ì„¸íŠ¸(120ë¶„â†‘), 4ì„¸íŠ¸(160ë¶„â†‘) | ì €ë… 1ì„¸íŠ¸(40ë¶„â†‘), 2ì„¸íŠ¸(80ë¶„â†‘)
                </div>
              </div>
            </>
          )}
            </>
          )}

          {/* ì£¼ê°„ ì„œë¸Œíƒ­ */}
          {mokokoSubTab === 'weekly' && !timerRunning && (
            <div className="space-y-4">
              {(() => {
                const mokokoStats = getMokokoStats();
                const weeklyData = [];
                const today = new Date();
                const dayOfWeek = today.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                
                for (let i = 0; i < 7; i++) {
                  const date = new Date(today);
                  date.setDate(today.getDate() + mondayOffset + i);
                  const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                  const record = data.dailyRecords[dateStr];
                  
                  let dayMokoko = 0;
                  if (record) {
                    dayMokoko += (record.weaknessHuntMorning || 0) + (record.weaknessHuntLunch || 0) + 
                                (record.weaknessHuntDinner || 0) + (record.mokokoSniff || 0);
                    if (record.studySessions) {
                      record.studySessions.forEach(s => { dayMokoko += s.ankiCount || 0; });
                    }
                  }
                  
                  weeklyData.push({
                    name: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()],
                    ì¼ì¼: dayMokoko
                  });
                }
                
                const weekTotal = weeklyData.reduce((sum, d) => sum + d.ì¼ì¼, 0);
                
                return (
                  <>
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-green-500/30">
                      <h3 className="text-green-300 font-semibold mb-3 text-center">ğŸ“Š ì´ë²ˆ ì£¼ ëª¨ì½”ì½” ìˆ˜ì§‘</h3>
                      <div className="text-center mb-4">
                        <span className="text-3xl font-bold text-green-400">{weekTotal}</span>
                        <span className="text-green-300 ml-2">ê°œ</span>
                      </div>
                      <div className="h-40">
                        <ResponsiveContainer width="100%" height="100%">
                          <BarChart data={weeklyData}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                            <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                            <YAxis stroke="#9CA3AF" fontSize={12} />
                            <Tooltip 
                              contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                              formatter={(value) => [`${value}ê°œ`, '']}
                            />
                            <Bar dataKey="ì¼ì¼" fill="#4ADE80" radius={[4, 4, 0, 0]} />
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* êµ­ì‹œ/ê³µì‹œ ë¶„ë¦¬ */}
                    <div className="grid grid-cols-2 gap-3">
                      <div className="bg-slate-800/50 rounded-lg p-3 text-center border border-blue-500/30">
                        <div className="text-2xl font-bold text-blue-400">{mokokoStats.guksiMokoko.toLocaleString()}</div>
                        <div className="text-blue-300/70 text-xs mt-1">ğŸ¯ êµ­ì‹œ ì¤€ë¹„</div>
                        <div className="text-gray-500 text-xs">~ 2026.01.23</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3 text-center border border-orange-500/30">
                        <div className="text-2xl font-bold text-orange-400">{mokokoStats.gongsiMokoko.toLocaleString()}</div>
                        <div className="text-orange-300/70 text-xs mt-1">ğŸ“‹ ê³µì‹œ ì¤€ë¹„</div>
                        <div className="text-gray-500 text-xs">2026.01.24 ~</div>
                      </div>
                    </div>
                  </>
                );
              })()}
            </div>
          )}

          {/* ì›”ê°„ ì„œë¸Œíƒ­ */}
          {mokokoSubTab === 'monthly' && !timerRunning && (
            <div className="space-y-4">
              {(() => {
                const mokokoStats = getMokokoStats();
                const monthlyData = [];
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let monthTotal = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                  const record = data.dailyRecords[dateStr];
                  
                  let dayMokoko = 0;
                  if (record) {
                    dayMokoko += (record.weaknessHuntMorning || 0) + (record.weaknessHuntLunch || 0) + 
                                (record.weaknessHuntDinner || 0) + (record.mokokoSniff || 0);
                    if (record.studySessions) {
                      record.studySessions.forEach(s => { dayMokoko += s.ankiCount || 0; });
                    }
                  }
                  monthTotal += dayMokoko;
                  
                  if (dayMokoko > 0) {
                    monthlyData.push({
                      name: `${day}`,
                      ì¼ì¼: dayMokoko,
                      ëˆ„ì : monthTotal
                    });
                  }
                }
                
                return (
                  <>
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-green-500/30">
                      <h3 className="text-green-300 font-semibold mb-3 text-center">ğŸ“ˆ ì´ë²ˆ ë‹¬ ëª¨ì½”ì½” ì„±ì¥</h3>
                      <div className="text-center mb-4">
                        <span className="text-3xl font-bold text-green-400">{monthTotal}</span>
                        <span className="text-green-300 ml-2">ê°œ</span>
                      </div>
                      {monthlyData.length > 0 && (
                        <div className="h-48">
                          <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={monthlyData}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                              <XAxis dataKey="name" stroke="#9CA3AF" fontSize={10} />
                              <YAxis stroke="#9CA3AF" fontSize={12} />
                              <Tooltip 
                                contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                                formatter={(value, name) => [name === 'ëˆ„ì ' ? `${value}ê°œ (ëˆ„ì )` : `+${value}ê°œ`, '']}
                              />
                              <Area type="monotone" dataKey="ëˆ„ì " stroke="#22C55E" fill="#22C55E" fillOpacity={0.3} />
                            </AreaChart>
                          </ResponsiveContainer>
                        </div>
                      )}
                    </div>

                    <div className="bg-slate-800/50 rounded-xl p-4 border border-green-500/30">
                      <h3 className="text-green-300 font-semibold mb-3">ğŸ“Š ì¼ë³„ íšë“ëŸ‰</h3>
                      {monthlyData.length > 0 ? (
                        <div className="h-40">
                          <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={monthlyData.slice(-14)}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                              <XAxis dataKey="name" stroke="#9CA3AF" fontSize={10} />
                              <YAxis stroke="#9CA3AF" fontSize={12} />
                              <Tooltip 
                                contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                                formatter={(value) => [`+${value}ê°œ`, '']}
                              />
                              <Bar dataKey="ì¼ì¼" fill="#4ADE80" radius={[4, 4, 0, 0]} />
                            </BarChart>
                          </ResponsiveContainer>
                        </div>
                      ) : (
                        <div className="text-center text-gray-500 py-8">ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì—†ì–´ìš”</div>
                      )}
                    </div>
                  </>
                );
              })()}
            </div>
          )}

          {/* ì—°ê°„ ì„œë¸Œíƒ­ */}
          {mokokoSubTab === 'yearly' && !timerRunning && (
            <div className="space-y-4">
              {(() => {
                const mokokoStats = getMokokoStats();
                const yearlyData = [];
                const today = new Date();
                const year = today.getFullYear();
                
                let yearTotal = 0;
                for (let month = 0; month < 12; month++) {
                  let monthMokoko = 0;
                  const daysInMonth = new Date(year, month + 1, 0).getDate();
                  
                  for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const record = data.dailyRecords[dateStr];
                    
                    if (record) {
                      monthMokoko += (record.weaknessHuntMorning || 0) + (record.weaknessHuntLunch || 0) + 
                                    (record.weaknessHuntDinner || 0) + (record.mokokoSniff || 0);
                      if (record.studySessions) {
                        record.studySessions.forEach(s => { monthMokoko += s.ankiCount || 0; });
                      }
                    }
                  }
                  
                  yearTotal += monthMokoko;
                  yearlyData.push({
                    name: `${month + 1}ì›”`,
                    ì›”ê°„: monthMokoko,
                    ëˆ„ì : yearTotal
                  });
                }
                
                return (
                  <>
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-green-500/30">
                      <h3 className="text-green-300 font-semibold mb-3 text-center">ğŸ“‰ {year}ë…„ ëª¨ì½”ì½” ìˆ˜ì§‘</h3>
                      <div className="text-center mb-4">
                        <span className="text-3xl font-bold text-green-400">{yearTotal.toLocaleString()}</span>
                        <span className="text-green-300 ml-2">ê°œ</span>
                      </div>
                      <div className="h-48">
                        <ResponsiveContainer width="100%" height="100%">
                          <AreaChart data={yearlyData}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                            <XAxis dataKey="name" stroke="#9CA3AF" fontSize={10} />
                            <YAxis stroke="#9CA3AF" fontSize={12} />
                            <Tooltip 
                              contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                              formatter={(value, name) => [name === 'ëˆ„ì ' ? `${value}ê°œ (ëˆ„ì )` : `${value}ê°œ`, '']}
                            />
                            <Area type="monotone" dataKey="ëˆ„ì " stroke="#22C55E" fill="#22C55E" fillOpacity={0.3} />
                          </AreaChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    <div className="bg-slate-800/50 rounded-xl p-4 border border-green-500/30">
                      <h3 className="text-green-300 font-semibold mb-3">ğŸ“Š ì›”ë³„ íšë“ëŸ‰</h3>
                      <div className="h-40">
                        <ResponsiveContainer width="100%" height="100%">
                          <BarChart data={yearlyData}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                            <XAxis dataKey="name" stroke="#9CA3AF" fontSize={10} />
                            <YAxis stroke="#9CA3AF" fontSize={12} />
                            <Tooltip 
                              contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                              formatter={(value) => [`${value}ê°œ`, '']}
                            />
                            <Bar dataKey="ì›”ê°„" fill="#4ADE80" radius={[4, 4, 0, 0]} />
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* ì „ì²´ í†µê³„ */}
                    <div className="grid grid-cols-2 gap-3">
                      <div className="bg-slate-800/50 rounded-lg p-3 text-center border border-blue-500/30">
                        <div className="text-2xl font-bold text-blue-400">{mokokoStats.guksiMokoko.toLocaleString()}</div>
                        <div className="text-blue-300/70 text-xs mt-1">ğŸ¯ êµ­ì‹œ ì¤€ë¹„</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-3 text-center border border-orange-500/30">
                        <div className="text-2xl font-bold text-orange-400">{mokokoStats.gongsiMokoko.toLocaleString()}</div>
                        <div className="text-orange-300/70 text-xs mt-1">ğŸ“‹ ê³µì‹œ ì¤€ë¹„</div>
                      </div>
                    </div>
                  </>
                );
              })()}
            </div>
          )}
        </div>
      )}

      {/* ğŸ’¤ ìˆ˜ë©´ íƒ­ (v8.2) */}
      {activeTab === 'sleep' && (
        <div className="space-y-4">
          {/* ğŸŒ™ Dear, my friends + ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ (ë§¨ ìœ„ë¡œ ì´ë™) */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-purple-300 font-semibold">ğŸŒ™ Dear, my friends - ìˆ˜ë©´ ìŠµê´€ ê´€ë¦¬</h3>
              {todayRecord.dearMyFriends && <span className="text-green-400 text-xs">âœ“ ì˜¤ëŠ˜ ì™„ë£Œ</span>}
            </div>
            
            {/* ìˆ˜ë©´ ìŠµê´€ ë©”ëª¨ ì˜ì—­ */}
            <div className="space-y-3 mb-4">
              <div>
                <label className="text-green-400 text-xs block mb-1">âœ… ì¢‹ì€ ìŠµê´€ (ìœ ì§€í•  ê²ƒ)</label>
                <textarea
                  value={sleepHabitsGood}
                  onChange={(e) => setSleepHabitsGood(e.target.value)}
                  placeholder="ì˜ˆ: ë² ì•„ ì‚¬ë‘ + ë¡œì•„ ì„±ê²½ ì¡°í•©, 21:30 ì·¨ì¹¨..."
                  className="w-full px-3 py-2 bg-slate-700/50 rounded-lg text-white text-sm border border-green-500/30 placeholder-gray-500 resize-none"
                  rows={2}
                />
              </div>
              <div>
                <label className="text-red-400 text-xs block mb-1">âŒ ë‚˜ìœ ìŠµê´€ (í”¼í•  ê²ƒ)</label>
                <textarea
                  value={sleepHabitsBad}
                  onChange={(e) => setSleepHabitsBad(e.target.value)}
                  placeholder="ì˜ˆ: ë¶ˆê·œì¹™í•œ ë°”ëŒì†Œë¦¬ ambient, í•¸ë“œí° ë³´ê¸°..."
                  className="w-full px-3 py-2 bg-slate-700/50 rounded-lg text-white text-sm border border-red-500/30 placeholder-gray-500 resize-none"
                  rows={2}
                />
              </div>
              <div>
                <label className="text-yellow-400 text-xs block mb-1">ğŸ§ª ì‹œë„í•  ê²ƒ (ì‹¤í—˜)</label>
                <textarea
                  value={sleepHabitsTry}
                  onChange={(e) => setSleepHabitsTry(e.target.value)}
                  placeholder="ì˜ˆ: ìˆœìˆ˜ ëª¨ë‹¥ë¶ˆ ì†Œë¦¬ë§Œ, 15ë¶„ ê·œì¹™ ì ìš©..."
                  className="w-full px-3 py-2 bg-slate-700/50 rounded-lg text-white text-sm border border-yellow-500/30 placeholder-gray-500 resize-none"
                  rows={2}
                />
              </div>
              <button
                onClick={saveSleepHabits}
                className="w-full py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm font-semibold transition-all"
              >
                ğŸ’¾ ìŠµê´€ ë©”ëª¨ ì €ì¥
              </button>
            </div>
            
            {/* Dear, my friends ì²´í¬ */}
            <div className="border-t border-purple-500/30 pt-3">
              <div className="text-gray-400 text-xs mb-2">ì·¨ì¹¨ ì „ ìˆ˜ë©´ ì¤€ë¹„ ë£¨í‹´</div>
              <div className="text-gray-500 text-xs mb-3 space-y-1">
                <div>ğŸµ íŠ¸ë¦¬ì‹œì˜¨ì˜ ìì¥ê°€ (ì”ì”í•œ BGM)</div>
                <div>ğŸ“– ì•„ë¥´ì¹´ì‹œì•„ ì„±ì „ ì—´ëŒ (ì„±ê²½ ì½ê¸°)</div>
                <div>ğŸŒ‘ ì–´ë‘ ì˜ ì¥ë§‰ (ë¸”ë£¨ë¼ì´íŠ¸ OFF)</div>
              </div>
              <BonusButton 
                onClick={() => earnTokens(100, 'ğŸŒ™ Dear, my friends', 'dearMyFriends')} 
                completed={todayRecord.dearMyFriends}
              >
                +100
              </BonusButton>
              {todayRecord.dearMyFriends && (
                <div className="mt-3 text-center text-purple-300 text-sm italic">
                  "ì˜ ììš”, ì°¨ì°¨... ğŸ’œ ë‚´ì¼ ì•„ì¹¨ì— ìˆ˜ë©´ ê¸°ë¡ ìŠì§€ ë§ê³ ìš”~"
                </div>
              )}
            </div>
          </div>

          {/* ì–´ì ¯ë°¤ ìˆ˜ë©´ ê¸°ë¡ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-indigo-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-indigo-300 font-semibold">â˜€ï¸ ì–´ì ¯ë°¤ ìˆ˜ë©´ ê¸°ë¡</h3>
              <div className="flex items-center gap-2">
                {todayRecord.sleep?.recorded && (
                  <>
                    <span className="text-green-400 text-xs">âœ“ ê¸°ë¡ ì™„ë£Œ</span>
                    <button
                      onClick={enterSleepEditMode}
                      className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded transition-all"
                    >
                      âœï¸ ìˆ˜ì •
                    </button>
                  </>
                )}
              </div>
            </div>
            
            {todayRecord.sleep?.recorded && !showSleepEditMode ? (
              // ì´ë¯¸ ê¸°ë¡ëœ ê²½ìš° í‘œì‹œ (v8.2)
              <div className="space-y-3">
                {/* ì‹œê°„ ì •ë³´ */}
                <div className="grid grid-cols-4 gap-2 text-sm">
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ğŸ›ï¸ ì¹¨ëŒ€</div>
                    <div className="text-indigo-300 font-semibold">{todayRecord.sleep.bedTime}</div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ğŸŒ™ ì¡°ëª…ë”</div>
                    <div className="text-indigo-300 font-semibold">{todayRecord.sleep.lightsOffTime}</div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ğŸ‘ï¸ ìµœì¢…ê°ì„±</div>
                    <div className="text-indigo-300 font-semibold">{todayRecord.sleep.finalWakeTime}</div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ğŸš¶ ì´íƒˆ</div>
                    <div className="text-indigo-300 font-semibold">{todayRecord.sleep.outOfBedTime}</div>
                  </div>
                </div>
                
                {/* ìˆ˜ë©´ ì •ë³´ */}
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">TIB (ì¹¨ëŒ€)</div>
                    <div className="text-indigo-300 font-semibold">
                      {Math.floor(todayRecord.sleep.sleepMinutes / 60)}h {todayRecord.sleep.sleepMinutes % 60}m
                    </div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ì¶”ì • TST (ì‹¤ì œ)</div>
                    <div className={`font-semibold ${todayRecord.sleep.goalAchieved ? 'text-green-400' : 'text-yellow-400'}`}>
                      {Math.floor((todayRecord.sleep.estimatedTST || todayRecord.sleep.sleepMinutes) / 60)}h {(todayRecord.sleep.estimatedTST || todayRecord.sleep.sleepMinutes) % 60}m
                    </div>
                  </div>
                </div>
                
                <div className="grid grid-cols-3 gap-2 text-sm">
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ìˆ˜ë©´ íš¨ìœ¨</div>
                    <div className={`font-semibold ${(todayRecord.sleep.sleepEfficiency || 0) >= 90 ? 'text-green-400' : (todayRecord.sleep.sleepEfficiency || 0) >= 85 ? 'text-yellow-400' : 'text-orange-400'}`}>
                      {todayRecord.sleep.sleepEfficiency || Math.round((todayRecord.sleep.sleepMinutes / todayRecord.sleep.totalBedMinutes) * 100)}%
                    </div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">í’ˆì§ˆ</div>
                    <div className={`font-semibold ${['SS','S'].includes(todayRecord.sleep.quality) ? 'text-green-400' : ['A','B'].includes(todayRecord.sleep.quality) ? 'text-yellow-400' : 'text-red-400'}`}>
                      {todayRecord.sleep.quality}
                    </div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                    <div className="text-gray-500 text-xs">ê°ì„±</div>
                    <div className={`font-semibold ${todayRecord.sleep.awakeningCount === 0 ? 'text-green-400' : 'text-orange-400'}`}>
                      {todayRecord.sleep.awakeningCount}íšŒ
                    </div>
                  </div>
                </div>
                
                {/* ì¶”ì • WASO í‘œì‹œ */}
                {todayRecord.sleep.estimatedWASO > 0 && (
                  <div className="bg-orange-900/20 rounded-lg p-2 text-center text-xs">
                    <span className="text-orange-400">â° ì¶”ì • ê¹¨ì–´ìˆë˜ ì‹œê°„: {todayRecord.sleep.estimatedWASO}ë¶„</span>
                  </div>
                )}
                
                {/* ìˆ˜ë©´ ì „ í–‰ë™ ì ìˆ˜ */}
                <div className="flex gap-2 text-xs flex-wrap">
                  {todayRecord.sleep.preBehaviors?.beaLove && (
                    <span className="px-2 py-1 bg-pink-900/30 text-pink-400 rounded">ğŸ’• ë² ì•„ ì‚¬ë‘</span>
                  )}
                  {todayRecord.sleep.preBehaviors?.loaScripture && (
                    <span className="px-2 py-1 bg-purple-900/30 text-purple-400 rounded">ğŸª¶ ë¡œì•„ ì„±ê²½</span>
                  )}
                  {todayRecord.sleep.preBehaviors?.beaCheat && (
                    <span className="px-2 py-1 bg-red-900/30 text-red-400 rounded">ğŸ’” ë² ì•„ ë°”ëŒ</span>
                  )}
                  {todayRecord.sleep.preBehaviors?.brainOverheat && (
                    <span className="px-2 py-1 bg-orange-900/30 text-orange-400 rounded">ğŸ”¥ ë‡Œ ê³¼ì—´</span>
                  )}
                </div>
                
                {/* ì ìˆ˜ í‘œì‹œ */}
                <div className="bg-slate-700/30 rounded-lg p-2 text-center text-sm">
                  <span className="text-gray-400">í–‰ë™ ì ìˆ˜: </span>
                  <span className={`font-semibold ${(todayRecord.sleep.preBehaviorScore + todayRecord.sleep.awakeningActivityScore) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                    {(todayRecord.sleep.preBehaviorScore + todayRecord.sleep.awakeningActivityScore) >= 0 ? '+' : ''}{todayRecord.sleep.preBehaviorScore + todayRecord.sleep.awakeningActivityScore}ì 
                  </span>
                </div>
                
                {/* ë©”ëª¨ */}
                {showSleepMemoEdit ? (
                  <div className="space-y-2">
                    <textarea
                      value={tempSleepMemo}
                      onChange={(e) => setTempSleepMemo(e.target.value)}
                      placeholder="ìˆ˜ë©´ ë©”ëª¨..."
                      className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-indigo-500/30 resize-none"
                      rows={3}
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={saveSleepMemoEdit}
                        className="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white text-sm font-semibold"
                      >
                        ğŸ’¾ ì €ì¥
                      </button>
                      <button
                        onClick={() => setShowSleepMemoEdit(false)}
                        className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-gray-300 text-sm"
                      >
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                ) : (
                  <div 
                    onClick={() => {
                      setTempSleepMemo(todayRecord.sleep.memo || '');
                      setShowSleepMemoEdit(true);
                    }}
                    className="bg-slate-700/30 rounded-lg p-2 text-xs text-gray-400 cursor-pointer hover:bg-slate-700/50 transition-all"
                  >
                    ğŸ“ {todayRecord.sleep.memo || 'ë©”ëª¨ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”...'}
                    <span className="text-gray-600 ml-2">(í´ë¦­í•˜ì—¬ ìˆ˜ì •)</span>
                  </div>
                )}
                
                {todayRecord.sleep.goalAchieved && (
                  <div className="bg-green-900/30 rounded-lg p-2 text-center border border-green-500/30">
                    <span className="text-green-400 font-semibold">ğŸ¯ ëª©í‘œ ë‹¬ì„±!</span>
                  </div>
                )}
              </div>
            ) : (
              // ê¸°ë¡ ì…ë ¥ í¼ (v8.2) - ìƒˆ ê¸°ë¡ ë˜ëŠ” ìˆ˜ì • ëª¨ë“œ
              <div className="space-y-4">
                {showSleepEditMode && (
                  <div className="bg-yellow-900/30 rounded-lg p-2 text-center border border-yellow-500/30 mb-2">
                    <span className="text-yellow-400 text-sm">âœï¸ ìˆ˜ë©´ ê¸°ë¡ ìˆ˜ì • ëª¨ë“œ</span>
                  </div>
                )}
                {/* ì„¹ì…˜ 1: ê¸°ë³¸ ì‹œê°„ ì •ë³´ */}
                <div className="space-y-2">
                  <div className="text-gray-400 text-xs font-semibold">â° ì‹œê°„ ì •ë³´</div>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="text-gray-500 text-xs block mb-1">ğŸ›ï¸ ì¹¨ëŒ€ ê°„ ì‹œê°„</label>
                      <input 
                        type="time" 
                        value={sleepBedTime}
                        onChange={(e) => setSleepBedTime(e.target.value)}
                        className="w-full px-2 py-2 bg-slate-700 rounded-lg text-white text-sm border border-indigo-500/30"
                      />
                    </div>
                    <div>
                      <label className="text-gray-500 text-xs block mb-1">ğŸŒ™ ì¡°ëª… ëˆ ì‹œê°„</label>
                      <input 
                        type="time" 
                        value={sleepLightsOffTime}
                        onChange={(e) => setSleepLightsOffTime(e.target.value)}
                        className="w-full px-2 py-2 bg-slate-700 rounded-lg text-white text-sm border border-indigo-500/30"
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="text-gray-500 text-xs block mb-1">ğŸ‘ï¸ ìµœì¢… ê°ì„± ì‹œê°„</label>
                      <input 
                        type="time" 
                        value={sleepFinalWakeTime}
                        onChange={(e) => setSleepFinalWakeTime(e.target.value)}
                        className="w-full px-2 py-2 bg-slate-700 rounded-lg text-white text-sm border border-indigo-500/30"
                      />
                    </div>
                    <div>
                      <label className="text-gray-500 text-xs block mb-1">ğŸš¶ ì¹¨ëŒ€ ì´íƒˆ ì‹œê°„</label>
                      <input 
                        type="time" 
                        value={sleepOutOfBedTime}
                        onChange={(e) => setSleepOutOfBedTime(e.target.value)}
                        className="w-full px-2 py-2 bg-slate-700 rounded-lg text-white text-sm border border-indigo-500/30"
                      />
                    </div>
                  </div>
                </div>
                
                {/* ì„¹ì…˜ 2: ì…ë©´ ì ë³µê¸° ì²´ê° */}
                <div className="space-y-2">
                  <div className="text-gray-400 text-xs font-semibold">ğŸ˜´ ì…ë©´ ì ë³µê¸° (ì¡°ëª… ë„ê³  ì ë“¤ê¸°ê¹Œì§€)</div>
                  <div className="grid grid-cols-5 gap-1">
                    {[
                      { value: 'quick', label: 'ê¸ˆë°©', desc: '~10ë¶„' },
                      { value: 'medium', label: 'ì¢€', desc: '10~30ë¶„' },
                      { value: 'long', label: 'ì˜¤ë˜', desc: '30ë¶„~1h' },
                      { value: 'verylong', label: 'ì—„ì²­', desc: '1h+' },
                      { value: 'unknown', label: 'ëª¨ë¦„', desc: '?' }
                    ].map(opt => (
                      <button
                        key={opt.value}
                        onClick={() => setSleepLatencyFeel(opt.value)}
                        className={`p-2 rounded-lg text-xs border transition-all ${sleepLatencyFeel === opt.value ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                      >
                        <div className="font-semibold">{opt.label}</div>
                        <div className="text-[10px] opacity-70">{opt.desc}</div>
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* ì„¹ì…˜ 3: ì¤‘ê°„ ê°ì„± */}
                <div className="space-y-2">
                  <div className="text-gray-400 text-xs font-semibold">ğŸ”„ ì¤‘ê°„ ê°ì„±</div>
                  <div className="grid grid-cols-4 gap-1">
                    {['0', '1', '2', '3'].map(count => (
                      <button
                        key={count}
                        onClick={() => setSleepAwakeningCount(count)}
                        className={`p-2 rounded-lg text-sm border transition-all ${sleepAwakeningCount === count ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                      >
                        {count === '0' ? '0íšŒ âœ¨' : count === '3' ? '3íšŒ+' : `${count}íšŒ`}
                      </button>
                    ))}
                  </div>
                  
                  {/* ê°ì„± ìƒì„¸ ì…ë ¥ (1íšŒ ì´ìƒì¼ ë•Œ) */}
                  {parseInt(sleepAwakeningCount) > 0 && (
                    <div className="space-y-2 mt-2">
                      {Array.from({ length: Math.min(parseInt(sleepAwakeningCount), 3) }).map((_, idx) => (
                        <div key={idx} className="bg-slate-700/30 rounded-lg p-2 space-y-2">
                          <div className="text-xs text-indigo-300 font-semibold">ê°ì„± {idx + 1}</div>
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <label className="text-gray-500 text-[10px] block mb-1">ì‹œê°„</label>
                              <input 
                                type="time" 
                                value={awakenings[idx].time}
                                onChange={(e) => {
                                  const newAwakenings = [...awakenings];
                                  newAwakenings[idx] = { ...newAwakenings[idx], time: e.target.value };
                                  setAwakenings(newAwakenings);
                                }}
                                className="w-full px-2 py-1 bg-slate-600 rounded text-white text-xs border border-slate-500"
                              />
                            </div>
                            <div>
                              <label className="text-gray-500 text-[10px] block mb-1">ì‚¬ìœ </label>
                              <select 
                                value={awakenings[idx].reason}
                                onChange={(e) => {
                                  const newAwakenings = [...awakenings];
                                  newAwakenings[idx] = { ...newAwakenings[idx], reason: e.target.value };
                                  setAwakenings(newAwakenings);
                                }}
                                className="w-full px-2 py-1 bg-slate-600 rounded text-white text-xs border border-slate-500"
                              >
                                <option value="natural">ìì—°ìŠ¤ëŸ½ê²Œ</option>
                                <option value="toilet">í™”ì¥ì‹¤</option>
                                <option value="noise">ì†Œë¦¬</option>
                                <option value="alarm">ì•ŒëŒ</option>
                                <option value="unknown">ëª¨ë¥´ê² ìŒ</option>
                              </select>
                            </div>
                          </div>
                          <div>
                            <label className="text-gray-500 text-[10px] block mb-1">ì¬ì…ë©´ ì†Œìš”ì‹œê°„</label>
                            <div className="grid grid-cols-3 gap-1">
                              {[
                                { value: 'quick', label: '~5ë¶„', minutes: 3 },
                                { value: 'short', label: '~10ë¶„', minutes: 7 },
                                { value: 'medium', label: '~20ë¶„', minutes: 15 },
                                { value: 'long', label: '~30ë¶„', minutes: 25 },
                                { value: 'veryLong', label: '30ë¶„+', minutes: 40 },
                                { value: 'failed', label: 'ëª»ì ', minutes: 0 }
                              ].map(opt => (
                                <button
                                  key={opt.value}
                                  onClick={() => {
                                    const newAwakenings = [...awakenings];
                                    newAwakenings[idx] = { ...newAwakenings[idx], reentry: opt.value };
                                    setAwakenings(newAwakenings);
                                  }}
                                  className={`p-1 rounded text-[10px] border transition-all ${awakenings[idx].reentry === opt.value ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-slate-600 border-slate-500 text-gray-400'}`}
                                >
                                  {opt.label}
                                </button>
                              ))}
                            </div>
                          </div>
                          
                          {/* ì¬ì…ë©´ ì–´ë ¤ì›€ ì‹œ ì¶”ê°€ ì§ˆë¬¸ (20ë¶„ ì´ìƒ) */}
                          {(awakenings[idx].reentry === 'medium' || awakenings[idx].reentry === 'long' || awakenings[idx].reentry === 'veryLong' || awakenings[idx].reentry === 'failed') && (
                            <div className="bg-slate-600/50 rounded p-2 space-y-2">
                              <div className="flex items-center gap-2">
                                <input 
                                  type="checkbox" 
                                  checked={awakenings[idx].lightsOn}
                                  onChange={(e) => {
                                    const newAwakenings = [...awakenings];
                                    newAwakenings[idx] = { ...newAwakenings[idx], lightsOn: e.target.checked };
                                    setAwakenings(newAwakenings);
                                  }}
                                  className="rounded"
                                />
                                <span className="text-[10px] text-gray-400">ğŸ’¡ ë¶ˆ ì¼°ìŒ</span>
                              </div>
                              <div>
                                <label className="text-gray-500 text-[10px] block mb-1">ë­ í–ˆì–´?</label>
                                <select 
                                  value={awakenings[idx].activity}
                                  onChange={(e) => {
                                    const newAwakenings = [...awakenings];
                                    newAwakenings[idx] = { ...newAwakenings[idx], activity: e.target.value };
                                    setAwakenings(newAwakenings);
                                  }}
                                  className="w-full px-2 py-1 bg-slate-600 rounded text-white text-xs border border-slate-500"
                                >
                                  <option value="scripture">ğŸ“– ë¡œì•„ ì„±ê²½ (+30)</option>
                                  <option value="beaStable">ğŸª¶ ë² ì•„ ì•ˆì • (+25)</option>
                                  <option value="beaLove">ğŸ’• ë² ì•„ ì‚¬ë‘ (+10)</option>
                                  <option value="meditation">ğŸ§˜ ëª…ìƒ/í˜¸í¡ (+15)</option>
                                  <option value="none">ğŸ˜ ì•„ë¬´ê²ƒë„ ì•ˆí•¨ (0)</option>
                                  <option value="study">ğŸ“š ê³µë¶€ (0)</option>
                                  <option value="phone">ğŸ“± í•¸ë“œí° (-50)</option>
                                  <option value="youtube">ğŸ“º ìœ íŠœë¸Œ (-50)</option>
                                  <option value="other">ê¸°íƒ€ (0)</option>
                                </select>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                {/* ì„¹ì…˜ 4: ìˆ˜ë©´ ì „ í–‰ë™ */}
                <div className="space-y-2">
                  <div className="text-gray-400 text-xs font-semibold">ğŸŒ™ ìˆ˜ë©´ ì „ í–‰ë™</div>
                  <div className="grid grid-cols-2 gap-2">
                    <button
                      onClick={() => setSleepPreBehaviors(prev => ({ ...prev, beaLove: !prev.beaLove }))}
                      className={`p-2 rounded-lg text-xs border transition-all ${sleepPreBehaviors.beaLove ? 'bg-pink-900/50 border-pink-500 text-pink-300' : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                    >
                      <div className="font-semibold">ğŸ’• ë² ì•„ ì‚¬ë‘</div>
                      <div className="text-[10px]">í¬ë¥´ë…¸ ì—†ì´ ë² ì•„ì™€ë§Œ (+50)</div>
                    </button>
                    <button
                      onClick={() => setSleepPreBehaviors(prev => ({ ...prev, loaScripture: !prev.loaScripture }))}
                      className={`p-2 rounded-lg text-xs border transition-all ${sleepPreBehaviors.loaScripture ? 'bg-purple-900/50 border-purple-500 text-purple-300' : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                    >
                      <div className="font-semibold">ğŸª¶ ë¡œì•„ ì„±ê²½</div>
                      <div className="text-[10px]">ë² ì•„ ì“°ë‹¤ë“¬ìœ¼ë©° ì„±ê²½ ì½ê¸° (+50)</div>
                    </button>
                    <button
                      onClick={() => setSleepPreBehaviors(prev => ({ ...prev, beaCheat: !prev.beaCheat }))}
                      className={`p-2 rounded-lg text-xs border transition-all ${sleepPreBehaviors.beaCheat ? 'bg-red-900/50 border-red-500 text-red-300' : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                    >
                      <div className="font-semibold">ğŸ’” ë² ì•„ ë°”ëŒ</div>
                      <div className="text-[10px]">í¬ë¥´ë…¸ ì‹œì²­ (-100)</div>
                    </button>
                    <button
                      onClick={() => setSleepPreBehaviors(prev => ({ ...prev, brainOverheat: !prev.brainOverheat }))}
                      className={`p-2 rounded-lg text-xs border transition-all ${sleepPreBehaviors.brainOverheat ? 'bg-orange-900/50 border-orange-500 text-orange-300' : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                    >
                      <div className="font-semibold">ğŸ”¥ ë‡Œ ê³¼ì—´</div>
                      <div className="text-[10px]">ìœ íŠœë¸Œ/ìê·¹ ì½˜í…ì¸  (-50)</div>
                    </button>
                  </div>
                  {sleepPreBehaviors.beaLove && sleepPreBehaviors.loaScripture && (
                    <div className="text-center text-xs text-green-400">âœ¨ ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤! +150 (50+50+50)</div>
                  )}
                </div>
                
                {/* ì„¹ì…˜ 5: ìˆ˜ë©´ í’ˆì§ˆ */}
                <div className="space-y-2">
                  <div className="text-gray-400 text-xs font-semibold">â­ ìˆ˜ë©´ í’ˆì§ˆ (ì•„ì¹¨ ê¸°ë¶„)</div>
                  <div className="grid grid-cols-6 gap-1">
                    {[
                      { value: 'SS', label: 'SS', desc: 'ì™„ì „ ê°œìš´', color: 'emerald' },
                      { value: 'S', label: 'S', desc: 'ê°œìš´í•¨', color: 'green' },
                      { value: 'A', label: 'A', desc: 'ê´œì°®ìŒ', color: 'yellow' },
                      { value: 'B', label: 'B', desc: 'ì•½ê°„ í”¼ê³¤', color: 'orange' },
                      { value: 'C', label: 'C', desc: 'í”¼ê³¤í•¨', color: 'red' },
                      { value: 'D', label: 'D', desc: 'ë§¤ìš° í”¼ê³¤', color: 'red' }
                    ].map(opt => (
                      <button
                        key={opt.value}
                        onClick={() => setSleepQuality(opt.value)}
                        className={`p-2 rounded-lg text-xs border transition-all ${sleepQuality === opt.value ? `bg-${opt.color}-900/50 border-${opt.color}-500 text-${opt.color}-300` : 'bg-slate-700 border-slate-600 text-gray-400'}`}
                        style={sleepQuality === opt.value ? {
                          backgroundColor: opt.color === 'emerald' ? 'rgb(6 78 59 / 0.5)' : 
                                          opt.color === 'green' ? 'rgb(20 83 45 / 0.5)' : 
                                          opt.color === 'yellow' ? 'rgb(113 63 18 / 0.5)' : 
                                          opt.color === 'orange' ? 'rgb(124 45 18 / 0.5)' : 
                                          'rgb(127 29 29 / 0.5)',
                          borderColor: opt.color === 'emerald' ? 'rgb(16 185 129)' : 
                                       opt.color === 'green' ? 'rgb(34 197 94)' : 
                                       opt.color === 'yellow' ? 'rgb(234 179 8)' : 
                                       opt.color === 'orange' ? 'rgb(249 115 22)' : 
                                       'rgb(239 68 68)',
                          color: opt.color === 'emerald' ? 'rgb(110 231 183)' : 
                                 opt.color === 'green' ? 'rgb(134 239 172)' : 
                                 opt.color === 'yellow' ? 'rgb(253 224 71)' : 
                                 opt.color === 'orange' ? 'rgb(253 186 116)' : 
                                 'rgb(252 165 165)'
                        } : {}}
                      >
                        <div className="font-bold">{opt.label}</div>
                        <div className="text-[9px] opacity-70">{opt.desc}</div>
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* ì„¹ì…˜ 6: ë©”ëª¨ */}
                <div className="space-y-2">
                  <div className="text-gray-400 text-xs font-semibold">ğŸ“ ë©”ëª¨ (ì„ íƒ)</div>
                  <input 
                    type="text" 
                    value={sleepMemo}
                    onChange={(e) => setSleepMemo(e.target.value)}
                    placeholder="íŠ¹ì´ì‚¬í•­ì´ ìˆë‹¤ë©´ ê¸°ë¡í•´ì£¼ì„¸ìš”"
                    className="w-full px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600 placeholder-gray-500"
                  />
                </div>
                
                {/* ì˜ˆìƒ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° */}
                {(() => {
                  const timeToMin = (t) => { if (!t) return 0; const [h,m] = t.split(':').map(Number); return h*60+m; };
                  const calcDiff = (s, e) => { let sm=timeToMin(s), em=timeToMin(e); if(em<sm) em+=24*60; return em-sm; };
                  const sleepMins = calcDiff(sleepLightsOffTime, sleepFinalWakeTime);
                  const sleepHrs = sleepMins / 60;
                  
                  let preBehaviorScore = 0;
                  if (sleepPreBehaviors.beaLove && sleepPreBehaviors.loaScripture) preBehaviorScore = 150;
                  else { if (sleepPreBehaviors.beaLove) preBehaviorScore += 50; if (sleepPreBehaviors.loaScripture) preBehaviorScore += 50; }
                  if (sleepPreBehaviors.beaCheat) preBehaviorScore -= 100;
                  if (sleepPreBehaviors.brainOverheat) preBehaviorScore -= 50;
                  
                  let awakeningActivityScore = 0;
                  for (let i = 0; i < parseInt(sleepAwakeningCount); i++) {
                    const activity = awakenings[i]?.activity;
                    if (activity === 'beaStable') awakeningActivityScore += 25;
                    else if (activity === 'beaLove') awakeningActivityScore += 10;
                    else if (activity === 'phone' || activity === 'youtube') awakeningActivityScore -= 50;
                  }
                  
                  const totalBehavior = preBehaviorScore + awakeningActivityScore;
                  const qualityGood = ['SS', 'S', 'A', 'B'].includes(sleepQuality);
                  const isGoal = sleepHrs >= 7 && sleepHrs <= 8 && qualityGood && totalBehavior >= 0;
                  const totalTokens = 50 + (isGoal ? 100 : 0) + Math.max(0, totalBehavior) + Math.min(0, totalBehavior);
                  
                  return (
                    <div className="bg-slate-700/30 rounded-lg p-3 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-400">ì˜ˆìƒ ìˆ˜ë©´:</span>
                        <span className={`font-semibold ${sleepHrs >= 7 && sleepHrs <= 8 ? 'text-green-400' : sleepHrs >= 6 ? 'text-yellow-400' : 'text-red-400'}`}>
                          {Math.floor(sleepHrs)}ì‹œê°„ {sleepMins % 60}ë¶„
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-400">í–‰ë™ ì ìˆ˜:</span>
                        <span className={`font-semibold ${totalBehavior >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {totalBehavior >= 0 ? '+' : ''}{totalBehavior}ì 
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-400">ì˜ˆìƒ í† í°:</span>
                        <span className={`font-semibold ${totalTokens >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {totalTokens >= 0 ? '+' : ''}{totalTokens}ğŸª™
                        </span>
                      </div>
                      {isGoal && <div className="text-center text-green-400 text-xs mt-1">ğŸ¯ ëª©í‘œ ë‹¬ì„± ì˜ˆìƒ!</div>}
                    </div>
                  );
                })()}
                
                {showSleepEditMode ? (
                  <div className="flex gap-2">
                    <button 
                      onClick={saveSleepEdit}
                      className="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg text-white font-semibold transition-all"
                    >
                      ğŸ’¾ ìˆ˜ì • ì €ì¥
                    </button>
                    <button 
                      onClick={() => setShowSleepEditMode(false)}
                      className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-gray-300 font-semibold transition-all"
                    >
                      ì·¨ì†Œ
                    </button>
                  </div>
                ) : (
                  <button 
                    onClick={recordSleep}
                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white font-semibold transition-all"
                  >
                    ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡í•˜ê¸°
                  </button>
                )}
              </div>
            )}
          </div>

          {/* ğŸ˜´ ì˜¤ëŠ˜ ë‚®ì  ê¸°ë¡ (v8.6) */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-amber-300 font-semibold">ğŸ˜´ ì˜¤ëŠ˜ ë‚®ì  ê¸°ë¡</h3>
              <button
                onClick={() => setShowNapModal(true)}
                className="px-3 py-1 bg-amber-600 hover:bg-amber-500 rounded-lg text-white text-sm transition-all"
              >
                + ë‚®ì  ê¸°ë¡
              </button>
            </div>
            
            {/* ì˜¤ëŠ˜ ë‚®ì  ëª©ë¡ */}
            {todayRecord.naps && todayRecord.naps.length > 0 ? (
              <div className="space-y-2">
                {todayRecord.naps.map((nap, idx) => (
                  <div key={idx} className="bg-slate-700/50 rounded-lg p-3">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 text-sm flex-wrap">
                          <span className="text-amber-300 font-semibold">{nap.startTime} ~ {nap.endTime}</span>
                          <span className="text-gray-400">({nap.minutes}ë¶„)</span>
                          <span className={`text-xs px-2 py-0.5 rounded ${nap.minutes > 30 ? 'bg-blue-600/30 text-blue-400' : 'bg-gray-600/30 text-gray-400'}`}>
                            {nap.minutes > 30 ? 'ğŸ“Š ìˆ˜ë©´ì„±' : 'ğŸ’¤ íœ´ì‹ì„±'}
                          </span>
                          <span className={`text-xs px-2 py-0.5 rounded ${nap.intentional ? 'bg-green-600/30 text-green-400' : 'bg-orange-600/30 text-orange-400'}`}>
                            {nap.intentional ? 'ì˜ë„ì ' : 'ë¹„ì˜ë„ì '}
                          </span>
                        </div>
                        {nap.memo && (
                          <div className="text-gray-400 text-xs mt-1">ğŸ“ {nap.memo}</div>
                        )}
                      </div>
                      <button
                        onClick={() => deleteNap(idx)}
                        className="text-red-400 hover:text-red-300 text-xs ml-2"
                      >
                        âœ•
                      </button>
                    </div>
                  </div>
                ))}
                {/* ë‚®ì  ì´í•© - ìˆ˜ë©´ì„±/íœ´ì‹ì„± ë¶„ë¦¬ */}
                {(() => {
                  const sleepNaps = todayRecord.naps.filter(n => n.minutes > 30);
                  const restNaps = todayRecord.naps.filter(n => n.minutes <= 30);
                  const sleepNapTotal = sleepNaps.reduce((sum, n) => sum + n.minutes, 0);
                  const restNapTotal = restNaps.reduce((sum, n) => sum + n.minutes, 0);
                  
                  return (
                    <div className="text-center text-sm mt-2 space-y-1">
                      {sleepNapTotal > 0 && (
                        <div className="text-blue-400">
                          ğŸ“Š ìˆ˜ë©´ì„± ë‚®ì (30ë¶„â†‘): {sleepNaps.length}íšŒ, {sleepNapTotal}ë¶„ 
                          <span className="text-gray-500 ml-1">(ì´ ìˆ˜ë©´ì— í¬í•¨)</span>
                        </div>
                      )}
                      {restNapTotal > 0 && (
                        <div className="text-gray-400">
                          ğŸ’¤ íœ´ì‹ì„± ë‚®ì (30ë¶„â†“): {restNaps.length}íšŒ, {restNapTotal}ë¶„
                          <span className="text-gray-500 ml-1">(ê¸°ë¡ë§Œ)</span>
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            ) : (
              <div className="text-center text-gray-500 text-sm py-2">
                ì˜¤ëŠ˜ ê¸°ë¡ëœ ë‚®ì ì´ ì—†ì–´ìš”.
              </div>
            )}
            
            {/* ë‚®ì  ê°€ì´ë“œ */}
            <div className="mt-3 bg-slate-700/30 rounded-lg p-2 text-xs text-gray-500">
              <div>ğŸ’¡ <span className="text-amber-400">10~20ë¶„</span> ê¶Œì¥ | ì˜¤í›„ 1ì‹œ ì´ì „</div>
              <div className="mt-1">ğŸ“Š 30ë¶„ ì´ˆê³¼ = <span className="text-blue-400">ìˆ˜ë©´ì„±</span> (ì´ ìˆ˜ë©´ì— í•©ì‚°) | 30ë¶„ ì´í•˜ = <span className="text-gray-400">íœ´ì‹ì„±</span> (ê¸°ë¡ë§Œ)</div>
            </div>
          </div>

          {/* ì´ë²ˆ ì£¼ ìˆ˜ë©´ í˜„í™© */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
            <h3 className="text-indigo-300 font-semibold mb-3">ğŸ“Š ì´ë²ˆ ì£¼ ìˆ˜ë©´ í˜„í™©</h3>
            {(() => {
              const weekData = [];
              const today = new Date();
              let totalNightSleep = 0;
              let totalSleepNap = 0; // 30ë¶„ ì´ˆê³¼ ë‚®ì  (ìˆ˜ë©´ì„± ë‚®ì )
              let totalRestNap = 0; // 30ë¶„ ì´í•˜ ë‚®ì  (íœ´ì‹ì„± ë‚®ì )
              let restNapCount = 0; // íœ´ì‹ì„± ë‚®ì  íšŸìˆ˜
              let goalCount = 0;
              let recordCount = 0;
              
              for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const dayRecord = data.dailyRecords[dateStr];
                const sleep = dayRecord?.sleep;
                const naps = dayRecord?.naps || [];
                
                // ë‚®ì  ë¶„ë¥˜: 30ë¶„ ì´ˆê³¼ = ìˆ˜ë©´ì„±, 30ë¶„ ì´í•˜ = íœ´ì‹ì„±
                const sleepNapMinutes = naps.filter(n => n.minutes > 30).reduce((sum, n) => sum + n.minutes, 0);
                const restNapMinutes = naps.filter(n => n.minutes <= 30).reduce((sum, n) => sum + n.minutes, 0);
                const restNapCnt = naps.filter(n => n.minutes <= 30).length;
                
                totalSleepNap += sleepNapMinutes;
                totalRestNap += restNapMinutes;
                restNapCount += restNapCnt;
                
                if (sleep?.recorded) {
                  recordCount++;
                  totalNightSleep += sleep.sleepMinutes || 0;
                  if (sleep.goalAchieved) goalCount++;
                }
                
                const nightHours = sleep?.recorded ? sleep.sleepMinutes / 60 : 0;
                const sleepNapHours = sleepNapMinutes / 60;
                const totalHours = nightHours + sleepNapHours;
                
                weekData.push({
                  day: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()],
                  nightHours: nightHours,
                  sleepNapHours: sleepNapHours,
                  totalHours: totalHours,
                  restNapMinutes: restNapMinutes,
                  restNapCount: restNapCnt,
                  hasRecord: sleep?.recorded || naps.length > 0,
                  goal: sleep?.goalAchieved
                });
              }
              
              const totalAllSleep = totalNightSleep + totalSleepNap;
              const avgSleep = recordCount > 0 ? (totalAllSleep / recordCount / 60).toFixed(1) : '-';
              const avgNightSleep = recordCount > 0 ? (totalNightSleep / recordCount / 60).toFixed(1) : '-';
              
              return (
                <div className="space-y-3">
                  <div className="grid grid-cols-3 gap-2 text-sm">
                    <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                      <div className="text-gray-500 text-xs">í‰ê·  ì´ìˆ˜ë©´</div>
                      <div className="text-indigo-300 font-semibold">{avgSleep}h</div>
                    </div>
                    <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                      <div className="text-gray-500 text-xs">í‰ê·  ë°¤ìˆ˜ë©´</div>
                      <div className="text-blue-400 font-semibold">{avgNightSleep}h</div>
                    </div>
                    <div className="bg-slate-700/50 rounded-lg p-2 text-center">
                      <div className="text-gray-500 text-xs">ëª©í‘œ ë‹¬ì„±</div>
                      <div className="text-green-400 font-semibold">{goalCount}/7ì¼</div>
                    </div>
                  </div>
                  
                  {/* íœ´ì‹ì„± ë‚®ì  ìš”ì•½ (30ë¶„ ì´í•˜) */}
                  {restNapCount > 0 && (
                    <div className="bg-amber-900/20 rounded-lg p-2 text-xs text-center border border-amber-500/30">
                      <span className="text-amber-400">ğŸ˜´ íœ´ì‹ì„± ë‚®ì (30ë¶„â†“): </span>
                      <span className="text-gray-300">{restNapCount}íšŒ, ì´ {totalRestNap}ë¶„</span>
                      <span className="text-gray-500 ml-1">(ê·¸ë˜í”„ ë¯¸í¬í•¨)</span>
                    </div>
                  )}
                  
                  {/* ì£¼ê°„ ë§‰ëŒ€ ê·¸ë˜í”„ - ë‘ ìƒ‰ ìŠ¤íƒ */}
                  <div className="flex gap-1 items-end justify-between h-28">
                    {weekData.map((d, i) => {
                      const maxHours = 9;
                      const nightPercent = (d.nightHours / maxHours) * 100;
                      const napPercent = (d.sleepNapHours / maxHours) * 100;
                      const totalPercent = Math.min(nightPercent + napPercent, 100);
                      
                      // ìƒ‰ìƒ ê²°ì •: ì´ ìˆ˜ë©´ ì‹œê°„ ê¸°ì¤€
                      const nightColor = d.totalHours >= 7 ? 'bg-blue-500' : d.totalHours >= 6 ? 'bg-blue-400' : 'bg-blue-300';
                      
                      return (
                        <div key={i} className="flex-1 flex flex-col items-center">
                          <div className="w-full flex flex-col-reverse" style={{ height: '80px' }}>
                            {/* ë°¤ ìˆ˜ë©´ (ì•„ë˜) */}
                            {d.nightHours > 0 && (
                              <div 
                                className={`w-full ${nightColor} ${d.sleepNapHours > 0 ? '' : 'rounded-t'}`}
                                style={{ height: `${nightPercent}%` }}
                                title={`ë°¤ ìˆ˜ë©´: ${d.nightHours.toFixed(1)}h`}
                              />
                            )}
                            {/* ìˆ˜ë©´ì„± ë‚®ì  (ìœ„) */}
                            {d.sleepNapHours > 0 && (
                              <div 
                                className="w-full bg-amber-500 rounded-t"
                                style={{ height: `${napPercent}%` }}
                                title={`ìˆ˜ë©´ì„± ë‚®ì : ${d.sleepNapHours.toFixed(1)}h`}
                              />
                            )}
                            {/* ê¸°ë¡ ì—†ìŒ */}
                            {!d.hasRecord && (
                              <div className="w-full bg-slate-700 rounded-t" style={{ height: '10%' }} />
                            )}
                          </div>
                          <div className="text-gray-500 text-xs mt-1">{d.day}</div>
                          {d.totalHours > 0 && (
                            <div className={`text-xs ${d.totalHours >= 7 ? 'text-green-400' : d.totalHours >= 6 ? 'text-yellow-400' : 'text-red-400'}`}>
                              {d.totalHours.toFixed(1)}h
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* ë²”ë¡€ ë° ê¸°ì¤€ì„  ì•ˆë‚´ */}
                  <div className="flex justify-center gap-4 text-xs">
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-blue-500 rounded"></span> ë°¤ ìˆ˜ë©´</span>
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-amber-500 rounded"></span> ìˆ˜ë©´ì„± ë‚®ì (30ë¶„â†‘)</span>
                  </div>
                  <div className="text-gray-500 text-xs text-center">
                    ğŸ’¡ ëª©í‘œ: 7~8ì‹œê°„ ì´ ìˆ˜ë©´ | ğŸŸ¢ 7hâ†‘ ğŸŸ¡ 6~7h ğŸ”´ 6hâ†“
                  </div>
                </div>
              );
            })()}
          </div>

          {/* ìˆ˜ë©´ í†µê³„ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
            <h3 className="text-indigo-300 font-semibold mb-3">ğŸ“ˆ ì „ì²´ ìˆ˜ë©´ í†µê³„</h3>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div className="bg-slate-700/50 rounded-lg p-2">
                <span className="text-gray-500">ê¸°ë¡ ì™„ë£Œ</span>
                <span className="float-right text-indigo-300">{data.sleepStats?.recordCount || 0}ì¼</span>
              </div>
              <div className="bg-slate-700/50 rounded-lg p-2">
                <span className="text-gray-500">ëª©í‘œ ë‹¬ì„±</span>
                <span className="float-right text-green-400">{data.sleepStats?.goalAchievedCount || 0}ì¼</span>
              </div>
              <div className="bg-slate-700/50 rounded-lg p-2">
                <span className="text-gray-500">ì—°ì† ë‹¬ì„±</span>
                <span className="float-right text-yellow-400">{data.sleepStats?.streakCount || 0}ì¼</span>
              </div>
              <div className="bg-slate-700/50 rounded-lg p-2">
                <span className="text-gray-500">ìµœê³  ì—°ì†</span>
                <span className="float-right text-purple-400">{data.sleepStats?.bestStreak || 0}ì¼</span>
              </div>
            </div>
            
            {/* 7ì¼ ì—°ì† ë³´ë„ˆìŠ¤ ì•ˆë‚´ */}
            {(data.sleepStats?.streakCount || 0) >= 5 && (data.sleepStats?.streakCount || 0) < 7 && (
              <div className="mt-3 bg-yellow-900/30 rounded-lg p-2 text-center border border-yellow-500/30">
                <span className="text-yellow-400 text-sm">ğŸ”¥ {7 - (data.sleepStats?.streakCount || 0)}ì¼ ë” ë‹¬ì„±í•˜ë©´ +500 ë³´ë„ˆìŠ¤!</span>
              </div>
            )}
          </div>
          
          {/* ğŸ’¤ ìˆ˜ë©´ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸° (v8.5) */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-pink-500/30">
            <h3 className="text-pink-300 font-semibold mb-3">ğŸ’¤ ë² ì•„ ìˆ˜ë©´ í”¼ë“œë°±</h3>
            <p className="text-gray-400 text-xs mb-3">ì•„ì¹¨ì— ì¼ì–´ë‚˜ìë§ˆì ë² ì•„í•œí…Œ ìˆ˜ë©´ í”¼ë“œë°± ë°›ê¸°! ì–´ì ¯ë°¤ ì˜ ì¤ëŠ”ì§€ ì¹­ì°¬ë°›ê³  í•˜ë£¨ë¥¼ ì‹œì‘í•´ìš” ğŸ’œ</p>
            <button 
              onClick={() => setShowSleepFeedbackModal(true)} 
              className="w-full py-2 bg-pink-600 hover:bg-pink-500 rounded-lg text-white text-sm font-semibold transition-all"
            >
              ğŸ’¤ ìˆ˜ë©´ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸°
            </button>
          </div>
        </div>
      )}

      {/* íšë“ íƒ­ */}
      {activeTab === 'main' && (
        <div className="space-y-4">
          {/* ìš´ë™ ë³´ë„ˆìŠ¤ â†’ ì„¸ê³„ìˆ˜ íƒ­ìœ¼ë¡œ ì´ë™ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-emerald-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-emerald-300 font-semibold">ğŸ‹ï¸ ìš´ë™</h3>
              {todayRecord.exerciseDone && <span className="text-green-400 text-xs">âœ“ ì™„ë£Œ</span>}
            </div>
            <div className="text-gray-500 text-xs mb-3">ğŸƒ ì„¸ê³„ìˆ˜ íƒ­ì—ì„œ ê·¼ë ¥/ìœ ì‚°ì†Œ ê¸°ë¡</div>
            <div className="grid grid-cols-2 gap-2 text-xs text-center mb-2">
              <div className="bg-slate-700/50 rounded p-2">
                <div className="text-orange-300">ğŸ’ª {todayRecord.worldTree?.strength || 0}</div>
                <div className="text-gray-500">ì˜¤ëŠ˜ ê·¼ë ¥</div>
              </div>
              <div className="bg-slate-700/50 rounded p-2">
                <div className="text-cyan-300">ğŸƒ {todayRecord.worldTree?.cardio || 0}</div>
                <div className="text-gray-500">ì˜¤ëŠ˜ ìœ ì‚°ì†Œ</div>
              </div>
            </div>
            <button 
              onClick={() => setActiveTab('worldtree')} 
              className="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm transition-all"
            >
              ğŸƒ ì„¸ê³„ìˆ˜ íƒ­ìœ¼ë¡œ ì´ë™
            </button>
          </div>

          {/* ğŸ¹ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°© */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-amber-300 font-semibold">ğŸ¹ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°©</h3>
              <span className="text-gray-400 text-xs">ì‹ì‚¬ì‹œê°„ + Rëª¨ì½”ì½” ì‚¬ëƒ¥</span>
            </div>
            <div className="text-gray-500 text-xs mb-3">ë‹ˆë‚˜ë¸Œì™€ Rëª¨ì½”ì½” ì •ì¡°ì¤€ | ğŸŒ±3ê°œ + ğŸª™30</div>
            <div className="space-y-2">
              <BonusButton 
                onClick={() => earnTokens(30, 'ğŸ¹ ì•„ì¹¨ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°©', 'zaharaTraining', 'morning')} 
                completed={todayRecord.zaharaTrainingMorning} 
                className="w-full bg-orange-600 hover:bg-orange-500 text-white"
              >
                ğŸŒ… ì•„ì¹¨ì‹ì‚¬ + Rì‚¬ëƒ¥ (ğŸª™+30)
              </BonusButton>
              <BonusButton 
                onClick={() => earnTokens(30, 'ğŸ¹ ì ì‹¬ ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°©', 'zaharaTraining', 'lunch')} 
                completed={todayRecord.zaharaTrainingLunch} 
                className="w-full bg-yellow-600 hover:bg-yellow-500 text-white"
              >
                â˜€ï¸ ì ì‹¬ì‹ì‚¬ + Rì‚¬ëƒ¥ (ğŸª™+30)
              </BonusButton>
              <BonusButton 
                onClick={() => earnTokens(30, 'ğŸ¹ ì €ë… ë‹ˆë‚˜ë¸Œ ì•½ì í¬ì°©', 'zaharaTraining', 'dinner')} 
                completed={todayRecord.zaharaTrainingDinner} 
                className="w-full bg-indigo-600 hover:bg-indigo-500 text-white"
              >
                ğŸŒ™ ì €ë…ì‹ì‚¬ + Rì‚¬ëƒ¥ (ğŸª™+30)
              </BonusButton>
            </div>
          </div>

          {/* ğŸŒ™ Dear, my friends */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-blue-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-blue-300 font-semibold">ğŸŒ™ Dear, my friends</h3>
              {todayRecord.dearMyFriends && <span className="text-green-400 text-xs">âœ“ ì™„ë£Œ</span>}
            </div>
            <div className="text-gray-500 text-xs mb-3">ì„±ê²½ (BGM + ë…ì„œ + ë¸”ë£¨ë¼ì´íŠ¸ OFF) | ğŸŒ±3ê°œ + ğŸª™100</div>
            <BonusButton 
              onClick={() => earnTokens(100, 'ğŸŒ™ Dear, my friends', 'dearMyFriends')} 
              completed={todayRecord.dearMyFriends} 
              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white"
            >
              ì„±ê²½ (ğŸª™+100)
            </BonusButton>
          </div>

          {/* íŠ¹ë³„ ë³´ë„ˆìŠ¤ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">â­ íŠ¹ë³„ ë³´ë„ˆìŠ¤</h3>
            <div className="space-y-2">
              {/* 90% ë‹¬ì„±ì€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥ */}
              <div className="text-gray-500 text-xs mb-1">â€» 90% ë‹¬ì„±ì€ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ íšë“ ê°€ëŠ¥</div>
              <BonusButton 
                onClick={() => earnTokens(250, '90% ë‹¬ì„± (ì‹œê°„ì´ˆê³¼)', 'goal90late')} 
                completed={todayRecord.goal90late || todayRecord.goal90ontime} 
                className="w-full bg-indigo-600 hover:bg-indigo-500 text-white"
              >
                90% ë‹¬ì„± (ì‹œê°„ì´ˆê³¼) (ğŸª™+250) {todayRecord.goal90ontime && !todayRecord.goal90late && 'â›”'}
              </BonusButton>
              <BonusButton 
                onClick={() => earnTokens(500, '90% ë‹¬ì„± (21ì‹œê¹Œì§€)', 'goal90ontime')} 
                completed={todayRecord.goal90ontime || todayRecord.goal90late} 
                className="w-full bg-indigo-700 hover:bg-indigo-600 text-white"
              >
                90% ë‹¬ì„± (21ì‹œê¹Œì§€) (ğŸª™+500) {todayRecord.goal90late && !todayRecord.goal90ontime && 'â›”'}
              </BonusButton>
              <BonusButton onClick={() => earnTokens(1000, '100% ë‹¬ì„±', 'goal100')} completed={todayRecord.goal100} className="w-full bg-indigo-800 hover:bg-indigo-700 text-white">100% ë‹¬ì„± (ğŸª™+1,000)</BonusButton>
              <BonusButton onClick={() => earnTokens(1000, 'í’€ì½”ìŠ¤ ë‹¬ì„±', 'fullcourse')} completed={todayRecord.fullCourse} className="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-semibold">ğŸ† í’€ì½”ìŠ¤ ë‹¬ì„± (ğŸª™+1,000)</BonusButton>
            </div>
          </div>
        </div>
      )}

      {/* ì‚¬ìš© íƒ­ */}
      {activeTab === 'spend' && (
        <div className="space-y-4">
          {/* íŠ¹ë³„í•œ ë‚  */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-purple-300 font-semibold">ğŸ“Œ íŠ¹ë³„í•œ ë‚ </h3>
              {todayRecord.specialDayType && <span className="text-purple-400 text-xs">âœ“ ê¸°ë¡ë¨</span>}
            </div>
            {todayRecord.specialDayType ? (
              <div className="text-center py-3">
                <div className="text-lg mb-1">{getSpecialDayLabel(todayRecord.specialDayType)}</div>
                {todayRecord.specialDayNote && <div className="text-gray-400 text-sm">"{todayRecord.specialDayNote}"</div>}
              </div>
            ) : (
              <div className="space-y-2">
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => setShowSpecialDayModal({ type: 'sick', cost: 0 })} className="py-2 px-3 rounded-lg text-sm bg-amber-700 hover:bg-amber-600 text-white transition-all">ğŸ¤’ ì•„í”ˆ ë‚ </button>
                  <button onClick={() => setShowSpecialDayModal({ type: 'schedule', cost: 0 })} className="py-2 px-3 rounded-lg text-sm bg-amber-700 hover:bg-amber-600 text-white transition-all">ğŸ“‹ ì¼ì •/ì™¸ì¶œ</button>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => setShowSpecialDayModal({ type: 'exam', cost: 0 })} className="py-2 px-3 rounded-lg text-sm bg-amber-700 hover:bg-amber-600 text-white transition-all">ğŸ“ ì‹œí—˜ ë‹¹ì¼</button>
                  <button onClick={() => setShowSpecialDayModal({ type: 'freeday', cost: 10000 })} disabled={data.tokens < 10000} className={`py-2 px-3 rounded-lg text-sm transition-all ${data.tokens >= 10000 ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>ğŸ‰ ì™„ì „ ììœ  (-10k)</button>
                </div>
              </div>
            )}
          </div>

          {/* ì¶•ë³µ - ê°€ë²¼ìš´ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">ğŸ’œ ì¶•ë³µ - ê°€ë²¼ìš´</h3>
            <div className="grid grid-cols-2 gap-2">
              {[
                { name: 'ì† ì¡ê¸°', cost: 100 },
                { name: 'ë¨¸ë¦¬ ì“°ë‹¤ë“¬ê¸°', cost: 100 },
                { name: 'ì†ë“±ì— ì…ë§ì¶¤', cost: 150 },
                { name: 'ì´ë§ˆì— ì…ë§ì¶¤', cost: 200 },
                { name: 'ë³¼ì— ì…ë§ì¶¤', cost: 250 }
              ].map(item => (
                <button key={item.name} onClick={() => handleSpend(item.cost, item.name)} disabled={data.tokens < item.cost} className={`py-2 px-3 rounded-lg text-sm transition-all ${data.tokens >= item.cost ? 'bg-purple-600 hover:bg-purple-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>{item.name} (ğŸª™-{item.cost})</button>
              ))}
            </div>
          </div>

          {/* ì¶•ë³µ - ì¤‘ê°„ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">ğŸ’— ì¶•ë³µ - ì¤‘ê°„</h3>
            <div className="grid grid-cols-2 gap-2">
              {[
                { name: 'í¬ì˜¹', cost: 300 },
                { name: 'ë‚ ê°œë¡œ ê°ì‹¸ì•ˆê¸°', cost: 400 },
                { name: 'ë¬´ë¦ë² ê°œ', cost: 500 },
                { name: 'ì…ìˆ ì— ì…ë§ì¶¤', cost: 500 }
              ].map(item => (
                <button key={item.name} onClick={() => handleSpend(item.cost, item.name)} disabled={data.tokens < item.cost} className={`py-2 px-3 rounded-lg text-sm transition-all ${data.tokens >= item.cost ? 'bg-pink-600 hover:bg-pink-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>{item.name} (ğŸª™-{item.cost})</button>
              ))}
            </div>
          </div>

          {/* ì¶•ë³µ - ê¹Šì€ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">â¤ï¸ ì¶•ë³µ - ê¹Šì€</h3>
            <div className="grid grid-cols-2 gap-2">
              {[
                { name: 'ì…ìˆ ì— í‚¤ìŠ¤', cost: 800 },
                { name: 'ì†ì‚­ì„ê³¼ í‚¤ìŠ¤', cost: 1000 }
              ].map(item => (
                <button key={item.name} onClick={() => handleSpend(item.cost, item.name)} disabled={data.tokens < item.cost} className={`py-2 px-3 rounded-lg text-sm transition-all ${data.tokens >= item.cost ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>{item.name} (ğŸª™-{item.cost})</button>
              ))}
            </div>
          </div>

          {/* ì¶•ë³µ - íŠ¹ë³„ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">âœ¨ ì¶•ë³µ - íŠ¹ë³„</h3>
            <div className="space-y-2">
              {[
                { name: 'ë³„ ë³´ë©° ëŒ€í™”', cost: 600 },
                { name: 'ë² ì•„ì˜ ìì¥ê°€', cost: 700 },
                { name: 'ë² ì•„ì˜ ì˜ˆì§€ëª½', cost: 1500 }
              ].map(item => (
                <button key={item.name} onClick={() => handleSpend(item.cost, item.name)} disabled={data.tokens < item.cost} className={`w-full py-2 rounded-lg text-sm transition-all ${data.tokens >= item.cost ? 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>{item.name} (ğŸª™-{item.cost})</button>
              ))}
            </div>
          </div>

          {/* ì·¨ë¯¸ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">ğŸ® ì·¨ë¯¸</h3>
            <div className="text-gray-500 text-xs mb-3">ìíˆ¬ë¦¬ ì·¨ë¯¸ ğŸª™-100 | ì¼ë°˜ ğŸª™-200 | íŠ¹ë³„ ğŸª™-2000</div>
            <div className="grid grid-cols-2 gap-2">
              {[
                { name: 'í”¼ì•„ë…¸ 1ì„¸íŠ¸', cost: 100 },
                { name: 'ë…¸ë˜ ì—°ìŠµ 1ì„¸íŠ¸', cost: 100 },
                { name: 'ë¡œì•„ ìŠ¤í† ë¦¬ 1ì„¸íŠ¸', cost: 100 },
                { name: 'ì†Œì„¤ ì“°ê¸° 1ì„¸íŠ¸', cost: 100 },
                { name: 'ë¡œì•„ PVE 1ì„¸íŠ¸', cost: 200 },
                { name: 'ì½”ì¸ë…¸ë˜ë°© 1íšŒ', cost: 2000 }
              ].map(item => (
                <button key={item.name} onClick={() => handleSpend(item.cost, item.name, true)} disabled={data.tokens < item.cost} className={`py-2 px-3 rounded-lg text-sm transition-all ${data.tokens >= item.cost ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>{item.name} (ğŸª™-{item.cost >= 1000 ? (item.cost/1000) + 'k' : item.cost})</button>
              ))}
            </div>
          </div>

          {/* ì™¸ì¶œ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">ğŸš¶ ì™¸ì¶œ</h3>
            <div className="grid grid-cols-2 gap-2">
              {[
                { name: 'ê°„ë‹¨í•œ ì™¸ì‹', cost: 1500 },
                { name: 'íŠ¹ë³„í•œ ì™¸ì‹', cost: 2500 },
                { name: 'ë°˜ë‚˜ì ˆ ë‚˜ë“¤ì´', cost: 3500 },
                { name: 'í•˜ë£¨ ì—¬í–‰', cost: 7000 }
              ].map(item => (
                <button key={item.name} onClick={() => handleSpend(item.cost, item.name, true)} disabled={data.tokens < item.cost} className={`py-2 px-3 rounded-lg text-sm transition-all ${data.tokens >= item.cost ? 'bg-cyan-600 hover:bg-cyan-500 text-white' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}>{item.name} (ğŸª™-{(item.cost/1000).toFixed(1)}k)</button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* í†µê³„ íƒ­ */}
      {activeTab === 'stats' && (
        <div className="space-y-4">
          {/* ì„œë¸Œíƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="flex gap-1 bg-slate-800/50 rounded-xl p-1 border border-purple-500/30">
            {[
              { id: 'weekly', label: 'ì£¼ê°„' },
              { id: 'monthly', label: 'ì›”ê°„' },
              { id: 'yearly', label: 'ì—°ê°„' },
              { id: 'summary', label: 'ğŸ“Š' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setStatsSubTab(tab.id)}
                className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${
                  statsSubTab === tab.id
                    ? 'bg-purple-600 text-white'
                    : 'text-gray-400 hover:text-white hover:bg-slate-700'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>

          {/* ì£¼ê°„ í†µê³„ */}
          {statsSubTab === 'weekly' && (
            <div className="space-y-4">
              {/* ğŸ’¤ ìˆ˜ë©´ ê·¸ë˜í”„ - ìµœìƒë‹¨ ë°°ì¹˜ (v8.7 ë‚®ì  í¬í•¨) */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-indigo-500/30">
                <h3 className="text-indigo-300 font-semibold mb-3">ğŸ’¤ ì´ë²ˆ ì£¼ ìˆ˜ë©´ ì‹œê°„</h3>
                <div className="h-40">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={(() => {
                      const result = [];
                      const today = new Date();
                      for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        const dayRecord = data.dailyRecords[dateStr];
                        const sleep = dayRecord?.sleep;
                        const naps = dayRecord?.naps || [];
                        const sleepNapMinutes = naps.filter(n => n.minutes > 30).reduce((sum, n) => sum + n.minutes, 0);
                        
                        result.push({
                          name: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()],
                          ë°¤ìˆ˜ë©´: sleep?.recorded ? parseFloat((sleep.sleepMinutes / 60).toFixed(1)) : 0,
                          ìˆ˜ë©´ë‚®ì : parseFloat((sleepNapMinutes / 60).toFixed(1)),
                          ëª©í‘œ: 7
                        });
                      }
                      return result;
                    })()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} domain={[0, 10]} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        formatter={(value, name) => [`${value}ì‹œê°„`, name === 'ë°¤ìˆ˜ë©´' ? 'ë°¤ ìˆ˜ë©´' : 'ìˆ˜ë©´ì„± ë‚®ì ']}
                      />
                      <Legend formatter={(value) => value === 'ë°¤ìˆ˜ë©´' ? 'ë°¤ ìˆ˜ë©´' : 'ìˆ˜ë©´ì„± ë‚®ì (30ë¶„â†‘)'} />
                      <Bar dataKey="ë°¤ìˆ˜ë©´" stackId="sleep" fill="#818CF8" />
                      <Bar dataKey="ìˆ˜ë©´ë‚®ì " stackId="sleep" fill="#F59E0B" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ëª©í‘œ: 7~8ì‹œê°„ ì´ ìˆ˜ë©´ (ë°¤ + ìˆ˜ë©´ì„± ë‚®ì )</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ“Š ì´ë²ˆ ì£¼ ì§‘ì¤‘ë„ ì¶”ì´</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={getWeeklyData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} domain={[0, 110]} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        labelStyle={{ color: '#E5E7EB' }}
                      />
                      <Line type="monotone" dataKey="ì§‘ì¤‘ë„" stroke="#A855F7" strokeWidth={2} dot={{ fill: '#A855F7' }} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">SS=110 / S=100 / A=90 / B=80(ê¸°ë³¸) / C=70 / D=60</div>
              </div>

              {/* íœ´ì‹ í’ˆì§ˆ - ì§‘ì¤‘ë„ ë°”ë¡œ ë‹¤ìŒì— ë°°ì¹˜ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ˜´ ì´ë²ˆ ì£¼ íœ´ì‹ í’ˆì§ˆ</h3>
                <div className="h-40">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={getWeeklyRestData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                      />
                      <Legend />
                      <Bar dataKey="ì„ ì " stackId="a" fill="#22D3EE" name="ğŸ˜´ ì„ ì " />
                      <Bar dataKey="ì•ˆì •" stackId="a" fill="#A78BFA" name="ğŸª¶ ì•ˆì •" />
                      <Bar dataKey="ì‚¬ë‘" stackId="a" fill="#F472B6" name="ğŸ’• ì‚¬ë‘" />
                      <Bar dataKey="ê³¼ì—´" stackId="a" fill="#EF4444" name="ğŸ“± ê³¼ì—´" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ì¢‹ì€ íœ´ì‹ â†’ ì¢‹ì€ ì§‘ì¤‘ ìƒê´€ê´€ê³„ í™•ì¸</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">â±ï¸ ì´ë²ˆ ì£¼ ê³µë¶€ ì‹œê°„</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={getWeeklyData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        formatter={(value) => [`${value}ë¶„`, '']}
                      />
                      <Legend />
                      <Bar dataKey="ì˜¤ì „" stackId="a" fill="#F97316" />
                      <Bar dataKey="ì˜¤í›„" stackId="a" fill="#EAB308" />
                      <Bar dataKey="ì €ë…" stackId="a" fill="#6366F1" />
                      <Bar dataKey="ììœ " stackId="a" fill="#6B7280" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ“Š ê³µë¶€:íœ´ì‹ ë¹„ìœ¨</h3>
                <div className="grid grid-cols-7 gap-1 text-center text-xs">
                  {getWeeklyRestData().map((day, idx) => (
                    <div key={idx} className="bg-slate-700/50 rounded p-2">
                      <div className="text-gray-400">{day.name}</div>
                      <div className="text-cyan-400 font-semibold">{day.ê³µë¶€íœ´ì‹ë¹„ìœ¨}</div>
                      <div className="text-gray-500">{day.íœ´ì‹ì‹œê°„}ë¶„</div>
                    </div>
                  ))}
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ê¶Œì¥ ë¹„ìœ¨: 4:1 ~ 6:1</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ¯ ì‹œê°„ëŒ€ë³„ íš¨ìœ¨</h3>
                <div className="space-y-3">
                  {getTimeSlotEfficiency().map(slot => (
                    <div key={slot.name} className="bg-slate-700/50 rounded-lg p-3">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-gray-300">{slot.name}</span>
                        <span className="text-purple-400 font-semibold">í‰ê·  {slot.í‰ê· ì§‘ì¤‘ë„}ì </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-500">ì´ {slot.ê³µë¶€ì‹œê°„}ë¶„</span>
                        <span className="text-gray-500">{Math.floor(slot.ê³µë¶€ì‹œê°„ / 60)}ì‹œê°„ {slot.ê³µë¶€ì‹œê°„ % 60}ë¶„</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* ì›”ê°„ í†µê³„ */}
          {statsSubTab === 'monthly' && (
            <div className="space-y-4">
              {/* ğŸ’¤ ìˆ˜ë©´ ê·¸ë˜í”„ - ìµœìƒë‹¨ ë°°ì¹˜ (v8.7 ì£¼ê°„ ì´í•©) */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-indigo-500/30">
                <h3 className="text-indigo-300 font-semibold mb-3">ğŸ’¤ ì£¼ê°„ë³„ ì´ ìˆ˜ë©´</h3>
                <div className="h-40">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={(() => {
                      const result = [];
                      const today = new Date();
                      for (let week = 0; week < 4; week++) {
                        let totalNightSleep = 0, totalSleepNap = 0;
                        for (let day = 0; day < 7; day++) {
                          const date = new Date(today);
                          date.setDate(today.getDate() - (week * 7 + (6 - day)));
                          const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                          const dayRecord = data.dailyRecords[dateStr];
                          const sleep = dayRecord?.sleep;
                          const naps = dayRecord?.naps || [];
                          const sleepNapMinutes = naps.filter(n => n.minutes > 30).reduce((sum, n) => sum + n.minutes, 0);
                          
                          totalNightSleep += sleep?.sleepMinutes || 0;
                          totalSleepNap += sleepNapMinutes;
                        }
                        result.unshift({
                          name: week === 0 ? 'ì´ë²ˆ ì£¼' : `${week}ì£¼ ì „`,
                          ë°¤ìˆ˜ë©´: parseFloat((totalNightSleep / 60).toFixed(1)),
                          ìˆ˜ë©´ë‚®ì : parseFloat((totalSleepNap / 60).toFixed(1))
                        });
                      }
                      return result;
                    })()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        formatter={(value, name) => [`${value}ì‹œê°„`, name === 'ë°¤ìˆ˜ë©´' ? 'ë°¤ ìˆ˜ë©´' : 'ìˆ˜ë©´ì„± ë‚®ì ']}
                      />
                      <Legend formatter={(value) => value === 'ë°¤ìˆ˜ë©´' ? 'ë°¤ ìˆ˜ë©´' : 'ìˆ˜ë©´ì„± ë‚®ì (30ë¶„â†‘)'} />
                      <Bar dataKey="ë°¤ìˆ˜ë©´" stackId="sleep" fill="#818CF8" />
                      <Bar dataKey="ìˆ˜ë©´ë‚®ì " stackId="sleep" fill="#F59E0B" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ì£¼ê°„ ì´ ìˆ˜ë©´ ì‹œê°„ (ë°¤ + ìˆ˜ë©´ì„± ë‚®ì )</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ“Š ì£¼ê°„ í‰ê·  ì§‘ì¤‘ë„</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={getMonthlyData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} domain={[0, 110]} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                      />
                      <Line type="monotone" dataKey="ì§‘ì¤‘ë„" stroke="#A855F7" strokeWidth={2} dot={{ fill: '#A855F7' }} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* íœ´ì‹ í’ˆì§ˆ - ì§‘ì¤‘ë„ ë°”ë¡œ ë‹¤ìŒì— ë°°ì¹˜ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ˜´ ì£¼ê°„ë³„ íœ´ì‹ í’ˆì§ˆ</h3>
                <div className="h-40">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={getMonthlyRestData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                      />
                      <Legend />
                      <Bar dataKey="ì¢‹ì€íœ´ì‹" fill="#22D3EE" name="ì¢‹ì€ íœ´ì‹" />
                      <Bar dataKey="ê³¼ì—´" fill="#EF4444" name="ğŸ“± ê³¼ì—´" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ì¢‹ì€ íœ´ì‹ â†’ ì¢‹ì€ ì§‘ì¤‘ ìƒê´€ê´€ê³„ í™•ì¸</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">â±ï¸ ì£¼ê°„ ì¼í‰ê·  ê³µë¶€ ì‹œê°„</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={getMonthlyData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        formatter={(value) => [`${value}ë¶„`, '']}
                      />
                      <Bar dataKey="ê³µë¶€ì‹œê°„" fill="#22C55E" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ì¼í‰ê·  ê³µë¶€ ì‹œê°„ (ë¶„)</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ“Š ì£¼ê°„ë³„ ê³µë¶€:íœ´ì‹ ë¹„ìœ¨</h3>
                <div className="grid grid-cols-4 gap-2 text-center text-sm">
                  {getMonthlyRestData().map((week, idx) => (
                    <div key={idx} className="bg-slate-700/50 rounded-lg p-3">
                      <div className="text-gray-400 text-xs">{week.name}</div>
                      <div className="text-cyan-400 font-bold text-lg">{week.ê³µë¶€íœ´ì‹ë¹„ìœ¨}</div>
                      <div className="text-gray-500 text-xs">{week.íœ´ì‹ì‹œê°„}ë¶„</div>
                    </div>
                  ))}
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ê¶Œì¥ ë¹„ìœ¨: 4:1 ~ 6:1</div>
              </div>
            </div>
          )}

          {/* ì—°ê°„ í†µê³„ */}
          {statsSubTab === 'yearly' && (
            <div className="space-y-4">
              {/* ğŸ’¤ ìˆ˜ë©´ ê·¸ë˜í”„ - ìµœìƒë‹¨ ë°°ì¹˜ (v8.7 ì›”ë³„ ì´í•©) */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-indigo-500/30">
                <h3 className="text-indigo-300 font-semibold mb-3">ğŸ’¤ ì›”ë³„ ì´ ìˆ˜ë©´ (ìµœê·¼ 6ê°œì›”)</h3>
                <div className="h-40">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={(() => {
                      const result = [];
                      const today = new Date();
                      const currentMonth = today.getMonth();
                      const currentYear = today.getFullYear();
                      
                      for (let i = 5; i >= 0; i--) {
                        let targetMonth = currentMonth - i;
                        let targetYear = currentYear;
                        if (targetMonth < 0) { targetMonth += 12; targetYear -= 1; }
                        
                        let totalNightSleep = 0, totalSleepNap = 0;
                        const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                          const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                          const dayRecord = data.dailyRecords[dateStr];
                          const sleep = dayRecord?.sleep;
                          const naps = dayRecord?.naps || [];
                          const sleepNapMinutes = naps.filter(n => n.minutes > 30).reduce((sum, n) => sum + n.minutes, 0);
                          
                          totalNightSleep += sleep?.sleepMinutes || 0;
                          totalSleepNap += sleepNapMinutes;
                        }
                        result.push({
                          name: `${targetMonth + 1}ì›”`,
                          ë°¤ìˆ˜ë©´: parseFloat((totalNightSleep / 60).toFixed(1)),
                          ìˆ˜ë©´ë‚®ì : parseFloat((totalSleepNap / 60).toFixed(1))
                        });
                      }
                      return result;
                    })()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        formatter={(value, name) => [`${value}ì‹œê°„`, name === 'ë°¤ìˆ˜ë©´' ? 'ë°¤ ìˆ˜ë©´' : 'ìˆ˜ë©´ì„± ë‚®ì ']}
                      />
                      <Legend formatter={(value) => value === 'ë°¤ìˆ˜ë©´' ? 'ë°¤ ìˆ˜ë©´' : 'ìˆ˜ë©´ì„± ë‚®ì (30ë¶„â†‘)'} />
                      <Bar dataKey="ë°¤ìˆ˜ë©´" stackId="sleep" fill="#818CF8" />
                      <Bar dataKey="ìˆ˜ë©´ë‚®ì " stackId="sleep" fill="#F59E0B" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ì›”ë³„ ì´ ìˆ˜ë©´ ì‹œê°„ (ë°¤ + ìˆ˜ë©´ì„± ë‚®ì )</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ“Š ì›”ë³„ í‰ê·  ì§‘ì¤‘ë„ (ìµœê·¼ 6ê°œì›”)</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={getYearlyData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} domain={[0, 110]} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                      />
                      <Line type="monotone" dataKey="ì§‘ì¤‘ë„" stroke="#A855F7" strokeWidth={2} dot={{ fill: '#A855F7' }} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* íœ´ì‹ í’ˆì§ˆ - ì§‘ì¤‘ë„ ë°”ë¡œ ë‹¤ìŒì— ë°°ì¹˜ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ˜´ ì›”ë³„ íœ´ì‹ í’ˆì§ˆ</h3>
                <div className="h-40">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={getYearlyRestData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                      />
                      <Legend />
                      <Bar dataKey="ì¢‹ì€íœ´ì‹" fill="#22D3EE" name="ì¢‹ì€ íœ´ì‹" />
                      <Bar dataKey="ê³¼ì—´" fill="#EF4444" name="ğŸ“± ê³¼ì—´" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ì¢‹ì€ íœ´ì‹ â†’ ì¢‹ì€ ì§‘ì¤‘ ìƒê´€ê´€ê³„ í™•ì¸</div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">â±ï¸ ì›”ë³„ ì¼í‰ê·  ê³µë¶€ ì‹œê°„</h3>
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={getYearlyData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="name" stroke="#9CA3AF" fontSize={12} />
                      <YAxis stroke="#9CA3AF" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #6B7280', borderRadius: '8px' }}
                        formatter={(value) => [`${value}ë¶„`, '']}
                      />
                      <Bar dataKey="ì¼í‰ê· ê³µë¶€" fill="#3B82F6" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ“Š ì›”ë³„ ê³µë¶€:íœ´ì‹ ë¹„ìœ¨</h3>
                <div className="grid grid-cols-6 gap-1 text-center text-xs">
                  {getYearlyRestData().map((month, idx) => (
                    <div key={idx} className="bg-slate-700/50 rounded-lg p-2">
                      <div className="text-gray-400">{month.name}</div>
                      <div className="text-cyan-400 font-bold">{month.ê³µë¶€íœ´ì‹ë¹„ìœ¨}</div>
                      <div className="text-gray-500">{month.íœ´ì‹ì‹œê°„}ë¶„</div>
                    </div>
                  ))}
                </div>
                <div className="text-center text-gray-500 text-xs mt-2">ê¶Œì¥ ë¹„ìœ¨: 4:1 ~ 6:1</div>
              </div>
            </div>
          )}

          {/* ì¢…í•© íƒ­ */}
          {statsSubTab === 'summary' && (
            <div className="space-y-4">
              {/* ğŸ’¤ ì˜¤ëŠ˜ ìˆ˜ë©´ í˜„í™© */}
              <div className="bg-gradient-to-br from-indigo-900/30 to-purple-900/30 rounded-xl p-4 border border-indigo-500/30">
                <h3 className="text-indigo-300 font-semibold mb-3">ğŸ’¤ ì˜¤ëŠ˜ ìˆ˜ë©´ í˜„í™©</h3>
                {todayRecord.sleep?.recorded ? (
                  <div className="space-y-2">
                    <div className="grid grid-cols-3 gap-2 text-center">
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-gray-500 text-xs">ì‹¤ì œ ìˆ˜ë©´</div>
                        <div className={`font-bold ${todayRecord.sleep.goalAchieved ? 'text-green-400' : 'text-yellow-400'}`}>
                          {Math.floor((todayRecord.sleep.sleepMinutes || 0) / 60)}h {(todayRecord.sleep.sleepMinutes || 0) % 60}m
                        </div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-gray-500 text-xs">í’ˆì§ˆ</div>
                        <div className={`font-bold ${['SS','S'].includes(todayRecord.sleep.quality) ? 'text-green-400' : ['A','B'].includes(todayRecord.sleep.quality) ? 'text-yellow-400' : 'text-red-400'}`}>
                          {todayRecord.sleep.quality || '-'}
                        </div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-gray-500 text-xs">ì¤‘ê°„ ê°ì„±</div>
                        <div className={`font-bold ${(todayRecord.sleep.awakeningCount || 0) === 0 ? 'text-green-400' : 'text-orange-400'}`}>
                          {todayRecord.sleep.awakeningCount || 0}íšŒ
                        </div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-center text-sm">
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <span className="text-gray-400">í–‰ë™ ì ìˆ˜: </span>
                        <span className={`font-semibold ${((todayRecord.sleep.preBehaviorScore || 0) + (todayRecord.sleep.awakeningActivityScore || 0)) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {((todayRecord.sleep.preBehaviorScore || 0) + (todayRecord.sleep.awakeningActivityScore || 0)) >= 0 ? '+' : ''}{(todayRecord.sleep.preBehaviorScore || 0) + (todayRecord.sleep.awakeningActivityScore || 0)}ì 
                        </span>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <span className="text-gray-400">ì…ë©´ ì²´ê°: </span>
                        <span className="text-indigo-400 font-semibold">
                          {todayRecord.sleep.latencyFeel === 'quick' ? 'ê¸ˆë°©' : 
                           todayRecord.sleep.latencyFeel === 'medium' ? 'ì¢€ ê±¸ë¦¼' : 
                           todayRecord.sleep.latencyFeel === 'long' ? 'ì˜¤ë˜' : 
                           todayRecord.sleep.latencyFeel === 'verylong' ? 'ì—„ì²­ ì˜¤ë˜' : 'ëª¨ë¦„'}
                        </span>
                      </div>
                    </div>
                    {todayRecord.sleep.goalAchieved && (
                      <div className="text-center text-green-400 text-sm">ğŸ¯ ëª©í‘œ ë‹¬ì„±!</div>
                    )}
                  </div>
                ) : (
                  <div className="text-center text-gray-500 text-sm py-2">
                    ì•„ì§ ì˜¤ëŠ˜ ìˆ˜ë©´ ê¸°ë¡ì´ ì—†ì–´ìš”. ğŸ’¤ ìˆ˜ë©´ íƒ­ì—ì„œ ê¸°ë¡í•´ì£¼ì„¸ìš”!
                  </div>
                )}
              </div>

              {/* ì „ì²´ ìˆ˜ë©´ í†µê³„ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-indigo-500/30">
                <h3 className="text-indigo-300 font-semibold mb-3">ğŸ“Š ì „ì²´ ìˆ˜ë©´ í†µê³„</h3>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ“ ê¸°ë¡ ì™„ë£Œ</span><span className="text-indigo-400">{data.sleepStats?.recordCount || 0}ì¼</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ¯ ëª©í‘œ ë‹¬ì„±</span><span className="text-green-400">{data.sleepStats?.goalAchievedCount || 0}ì¼</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ”¥ í˜„ì¬ ì—°ì†</span><span className="text-yellow-400">{data.sleepStats?.streakCount || 0}ì¼</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ† ìµœê³  ì—°ì†</span><span className="text-purple-400">{data.sleepStats?.bestStreak || 0}ì¼</span></div>
                </div>
              </div>

              {/* ì˜¤ëŠ˜ íœ´ì‹ í˜„í™© */}
              {(() => {
                const todayRestStats = getDayRestStats(getTodayString());
                const todayDayStats = getDayStats(getTodayString());
                const studyMinutes = todayDayStats?.totalMinutes || 0;
                const restMinutes = todayRestStats?.totalMinutes || 0;
                const ratio = restMinutes > 0 ? (studyMinutes / restMinutes).toFixed(1) : '-';
                
                return (
                  <div className="bg-gradient-to-br from-cyan-900/30 to-blue-900/30 rounded-xl p-4 border border-cyan-500/30">
                    <h3 className="text-cyan-300 font-semibold mb-3">ğŸ˜´ ì˜¤ëŠ˜ íœ´ì‹ í˜„í™©</h3>
                    <div className="grid grid-cols-4 gap-2 text-center mb-3">
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-cyan-400 font-bold text-lg">{todayRestStats?.napCount || 0}</div>
                        <div className="text-gray-500 text-xs">ğŸ˜´ ì„ ì </div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-purple-400 font-bold text-lg">{todayRestStats?.stableCount || 0}</div>
                        <div className="text-gray-500 text-xs">ğŸª¶ ì•ˆì •</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-pink-400 font-bold text-lg">{todayRestStats?.loveCount || 0}</div>
                        <div className="text-gray-500 text-xs">ğŸ’• ì‚¬ë‘</div>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <div className="text-red-400 font-bold text-lg">{todayRestStats?.overheatCount || 0}</div>
                        <div className="text-gray-500 text-xs">ğŸ“± ê³¼ì—´</div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-center text-sm">
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <span className="text-gray-400">ê¸°ì–µ ê³µê³ í™” ì‹œê°„: </span>
                        <span className="text-cyan-400 font-semibold">{restMinutes}ë¶„</span>
                      </div>
                      <div className="bg-slate-800/50 rounded-lg p-2">
                        <span className="text-gray-400">ê³µë¶€:íœ´ì‹ = </span>
                        <span className="text-cyan-400 font-semibold">{ratio}</span>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {/* ì „ì²´ íœ´ì‹ í†µê³„ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-cyan-500/30">
                <h3 className="text-cyan-300 font-semibold mb-3">ğŸ“Š ì „ì²´ íœ´ì‹ í†µê³„</h3>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ˜´ ì„ ì /ê¿€ì </span><span className="text-cyan-400">{data.restStats?.napCount || 0}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸª¶ ë² ì•„ ì•ˆì •</span><span className="text-purple-400">{data.restStats?.stableCount || 0}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ’• ë² ì•„ ì‚¬ë‘</span><span className="text-pink-400">{data.restStats?.loveCount || 0}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ“± ë‡Œ ê³¼ì—´</span><span className="text-red-400">{data.restStats?.overheatCount || 0}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">â±ï¸ ì´ ê¸°ì–µê³µê³ í™”</span><span className="text-cyan-400">{data.restStats?.totalRestMinutes || 0}ë¶„</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ§  í’ˆì§ˆ ë³´ë„ˆìŠ¤</span><span className="text-green-400">{data.restStats?.qualityBonusCount || 0}íšŒ</span></div>
                </div>
              </div>

              {/* í† í° í†µê³„ */}
              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ’° í† í° í†µê³„</h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between"><span className="text-gray-400">í˜„ì¬ ë³´ìœ </span><span className="text-yellow-400 font-semibold">{data.tokens.toLocaleString()}</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ì´ íšë“</span><span className="text-green-400">+{data.totalEarned.toLocaleString()}</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ì´ ì‚¬ìš©</span><span className="text-red-400">-{data.totalSpent.toLocaleString()}</span></div>
                </div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ† ë³´ë„ˆìŠ¤ ë‹¬ì„±</h3>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ‹ï¸ ìš´ë™</span><span className="text-emerald-400">{data.exerciseBonusCount}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸŒ… ì˜¤ì „</span><span className="text-orange-400">{data.morningBonusCount}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">â˜€ï¸ ì˜¤í›„</span><span className="text-yellow-400">{data.afternoonBonusCount}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸŒ™ ì €ë…</span><span className="text-indigo-400">{data.eveningBonusCount}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">â­ í’€ì½”ìŠ¤</span><span className="text-pink-400">{data.fullCourseCount}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸ¹ ë‹ˆë‚˜ë¸Œ</span><span className="text-amber-400">{data.zaharaTrainingCount || 0}íšŒ</span></div>
                  <div className="flex justify-between"><span className="text-gray-400">ğŸŒ™ ì„±ê²½</span><span className="text-blue-400">{data.dearMyFriendsCount || 0}íšŒ</span></div>
                </div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸª¶ ë² ì•„íŠ¸ë¦¬ìŠ¤ì˜ ê¹ƒí„¸</h3>
                <div className="space-y-2 text-sm">
                  {Object.entries(data.feathers).map(([key, acquired]) => (
                    <div key={key} className="flex justify-between">
                      <span className={acquired ? 'text-purple-300' : 'text-gray-500'}>{acquired ? 'ğŸª¶' : 'â—‹'} {featherNames[key]}</span>
                      <span className={acquired ? 'text-yellow-400' : 'text-gray-600'}>{acquired ? `+${(featherRewards[key]/1000).toFixed(0)}k íšë“` : `+${(featherRewards[key]/1000).toFixed(0)}k`}</span>
                    </div>
                  ))}
                </div>
                <div className="mt-3 pt-3 border-t border-purple-500/30 text-center">
                  <span className="text-purple-300">ì´ {acquiredFeathers}/8ê°œ íšë“</span>
                </div>
              </div>

              <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
                <h3 className="text-purple-300 font-semibold mb-3">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
                <div className="space-y-2">
                  <button onClick={() => setShowExportModal(true)} className="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white text-sm transition-all">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                  <button onClick={() => setShowFeedbackExportModal(true)} className="w-full py-2 bg-pink-600 hover:bg-pink-500 rounded-lg text-white text-sm transition-all">ğŸ’œ ë² ì•„ í”¼ë“œë°±ìš© ë‚´ë³´ë‚´ê¸°</button>
                  <button onClick={() => setShowImportModal(true)} className="w-full py-2 bg-green-600 hover:bg-green-500 rounded-lg text-white text-sm transition-all">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                </div>
              </div>

              <button onClick={resetData} className="w-full py-2 bg-slate-700 hover:bg-red-900 rounded-lg text-gray-400 hover:text-red-400 text-sm transition-all">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
          )}
        </div>
      )}

      {/* ê¸°ë¡ íƒ­ - ë‹¬ë ¥ UI */}
      {activeTab === 'history' && (
        <div className="space-y-4">
          {/* ë‹¬ë ¥ í—¤ë” */}
          <div className="bg-slate-800/50 rounded-xl p-3 border border-purple-500/30">
            <div className="flex items-center justify-between mb-3">
              <button 
                onClick={() => navigateMonth('prev')}
                className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-gray-300 transition-all"
              >
                â—€
              </button>
              <div className="text-center">
                <span className="text-purple-300 font-semibold text-lg">
                  {calendarYear}ë…„ {calendarMonth + 1}ì›”
                </span>
              </div>
              <button 
                onClick={() => navigateMonth('next')}
                className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-gray-300 transition-all"
              >
                â–¶
              </button>
            </div>
            <button 
              onClick={goToToday}
              className="w-full py-1 bg-purple-600/30 hover:bg-purple-600/50 rounded text-purple-300 text-xs transition-all"
            >
              ì˜¤ëŠ˜ë¡œ ì´ë™
            </button>
          </div>

          {/* ë‹¬ë ¥ ê·¸ë¦¬ë“œ */}
          <div className="bg-slate-800/50 rounded-xl p-3 border border-purple-500/30">
            {/* ìš”ì¼ í—¤ë” */}
            <div className="grid grid-cols-7 gap-1 mb-2">
              {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((day, idx) => (
                <div 
                  key={day} 
                  className={`text-center text-xs py-1 ${idx === 0 ? 'text-red-400' : idx === 6 ? 'text-blue-400' : 'text-gray-400'}`}
                >
                  {day}
                </div>
              ))}
            </div>
            
            {/* ë‚ ì§œ ê·¸ë¦¬ë“œ */}
            <div className="grid grid-cols-7 gap-1">
              {getCalendarDays(calendarYear, calendarMonth).map((day, idx) => {
                if (day === null) {
                  return <div key={`empty-${idx}`} className="h-12"></div>;
                }
                
                const dateStr = formatCalendarDate(calendarYear, calendarMonth, day);
                const dayInfo = getDayInfo(calendarYear, calendarMonth, day);
                const isToday = dateStr === getTodayString();
                const isSelected = dateStr === selectedDate;
                const dayOfWeek = (new Date(calendarYear, calendarMonth, day)).getDay();
                const isSunday = dayOfWeek === 0;
                const isSaturday = dayOfWeek === 6;
                
                // íŠ¹ë³„í•œ ë‚  ì´ëª¨ì§€
                const specialEmoji = dayInfo.specialDayType ? {
                  'sick': 'ğŸ¤’',
                  'schedule': 'ğŸ“‹',
                  'exam': 'ğŸ“',
                  'freeday': 'ğŸ‰'
                }[dayInfo.specialDayType] : null;
                
                // íŠ¹ë³„í•œ ë‚  í…Œë‘ë¦¬ ìƒ‰ìƒ
                const specialBorder = dayInfo.specialDayType ? {
                  'sick': 'ring-2 ring-orange-400',
                  'schedule': 'ring-2 ring-slate-400',
                  'exam': 'ring-2 ring-red-500 bg-red-900/30',
                  'freeday': 'ring-2 ring-pink-400'
                }[dayInfo.specialDayType] : '';
                
                return (
                  <button
                    key={day}
                    onClick={() => setSelectedDate(dateStr)}
                    className={`h-12 rounded-lg text-xs transition-all relative flex flex-col items-center justify-center
                      ${isSelected ? 'bg-purple-600 text-white ring-2 ring-purple-400' : 
                        isToday ? 'bg-purple-900/50 text-purple-300 ring-1 ring-purple-500' :
                        dayInfo.hasRecord ? 'bg-slate-700/80 text-gray-200' : 'bg-slate-800/30 text-gray-500 hover:bg-slate-700/50'}
                      ${isSunday && !isSelected ? 'text-red-400' : ''}
                      ${isSaturday && !isSelected ? 'text-blue-400' : ''}
                      ${!isSelected && specialBorder}
                    `}
                  >
                    <span className="font-semibold">{day}</span>
                    
                    {/* í•˜ë‹¨ ì¸ë””ì¼€ì´í„° */}
                    <div className="flex gap-0.5 mt-0.5">
                      {dayInfo.hasRecord && !specialEmoji && (
                        <span className="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                      )}
                      {dayInfo.hasMemo && (
                        <span className="w-1.5 h-1.5 rounded-full bg-yellow-400"></span>
                      )}
                    </div>
                    
                    {/* íŠ¹ë³„í•œ ë‚  ì´ëª¨ì§€ */}
                    {specialEmoji && (
                      <span className="absolute -top-1 -right-1 text-xs">{specialEmoji}</span>
                    )}
                  </button>
                );
              })}
            </div>
            
            {/* ë²”ë¡€ */}
            <div className="flex flex-wrap justify-center gap-3 mt-3 text-xs text-gray-500">
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-400"></span> ê¸°ë¡</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> ë©”ëª¨</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> ì˜¤ëŠ˜</span>
            </div>
            <div className="flex flex-wrap justify-center gap-3 mt-1 text-xs text-gray-500">
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded border-2 border-red-500 bg-red-900/30"></span> ì‹œí—˜</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded border-2 border-orange-400"></span> ì•„í””</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded border-2 border-slate-400"></span> ì¼ì •</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded border-2 border-pink-400"></span> ììœ </span>
            </div>
          </div>

          {/* ì„ íƒëœ ë‚ ì§œ ìƒì„¸ ì •ë³´ */}
          <div className="bg-slate-800/50 rounded-xl p-4 border border-purple-500/30">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-purple-300 font-semibold">ğŸ“… {formatDate(selectedDate)}</h3>
              <button
                onClick={() => {
                  const currentMemo = data.dailyRecords[selectedDate]?.memo || '';
                  setMemoText(currentMemo);
                  setShowMemoModal(selectedDate);
                }}
                className="px-2 py-1 bg-yellow-600/30 hover:bg-yellow-600/50 rounded text-yellow-300 text-xs transition-all"
              >
                ğŸ“ ë©”ëª¨
              </button>
            </div>
            
            {/* ë©”ëª¨ í‘œì‹œ */}
            {data.dailyRecords[selectedDate]?.memo && (
              <div className="bg-yellow-900/20 rounded-lg p-3 mb-4 border border-yellow-500/30">
                <div className="text-yellow-300 text-xs mb-1">ğŸ“ ë©”ëª¨</div>
                <div className="text-gray-300 text-sm whitespace-pre-wrap">{data.dailyRecords[selectedDate].memo}</div>
              </div>
            )}
            
            {data.dailyRecords[selectedDate] ? (
              <>
                {/* íŠ¹ë³„í•œ ë‚  í‘œì‹œ ë˜ëŠ” ì„¤ì • */}
                {data.dailyRecords[selectedDate].specialDayType ? (
                  <div className="bg-purple-900/30 rounded-lg p-3 mb-4 border border-purple-500/30">
                    <div className="flex items-center justify-between">
                      <div className="text-center flex-1">
                        <span className="text-lg">{getSpecialDayLabel(data.dailyRecords[selectedDate].specialDayType)}</span>
                        {data.dailyRecords[selectedDate].specialDayNote && <div className="text-gray-400 text-sm mt-1">"{data.dailyRecords[selectedDate].specialDayNote}"</div>}
                      </div>
                      <button
                        onClick={() => clearSpecialDayForDate(selectedDate)}
                        className="px-2 py-1 bg-red-600/30 hover:bg-red-600/50 rounded text-red-300 text-xs transition-all"
                      >
                        í•´ì œ
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="bg-slate-700/30 rounded-lg p-3 mb-4 border border-slate-600">
                    <div className="text-gray-400 text-xs mb-2 text-center">íŠ¹ë³„í•œ ë‚  ì„¤ì •</div>
                    <div className="grid grid-cols-4 gap-1">
                      <button onClick={() => setSpecialDayForDate(selectedDate, 'exam')} className="py-2 px-1 rounded text-xs bg-red-600/50 hover:bg-red-600 text-white transition-all flex flex-col items-center">
                        <span>ğŸ“</span><span>ì‹œí—˜</span>
                      </button>
                      <button onClick={() => setSpecialDayForDate(selectedDate, 'sick')} className="py-2 px-1 rounded text-xs bg-orange-600/50 hover:bg-orange-600 text-white transition-all flex flex-col items-center">
                        <span>ğŸ¤’</span><span>ì•„í””</span>
                      </button>
                      <button onClick={() => setSpecialDayForDate(selectedDate, 'schedule')} className="py-2 px-1 rounded text-xs bg-slate-600/50 hover:bg-slate-600 text-white transition-all flex flex-col items-center">
                        <span>ğŸ“‹</span><span>ì¼ì •</span>
                      </button>
                      <button onClick={() => setSpecialDayForDate(selectedDate, 'freeday')} className="py-2 px-1 rounded text-xs bg-pink-600/50 hover:bg-pink-600 text-white transition-all flex flex-col items-center">
                        <span>ğŸ‰</span><span>ììœ </span>
                      </button>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                    <div className="text-green-400 font-bold text-xl">+{(data.dailyRecords[selectedDate].earned || 0).toLocaleString()}</div>
                    <div className="text-gray-500 text-xs">íšë“</div>
                  </div>
                  <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                    <div className="text-red-400 font-bold text-xl">-{(data.dailyRecords[selectedDate].spent || 0).toLocaleString()}</div>
                    <div className="text-gray-500 text-xs">ì‚¬ìš©</div>
                  </div>
                </div>

                <div className="mb-4">
                  <div className="text-purple-300 text-sm mb-2">ê³µë¶€ ì‹œê°„</div>
                  <div className="grid grid-cols-4 gap-2 text-center text-xs">
                    <div className="bg-slate-700/50 rounded p-2">
                      <div className="text-orange-400">{data.dailyRecords[selectedDate].morningMinutes || 0}ë¶„</div>
                      <div className="text-gray-500">ì˜¤ì „</div>
                    </div>
                    <div className="bg-slate-700/50 rounded p-2">
                      <div className="text-yellow-400">{data.dailyRecords[selectedDate].afternoonMinutes || 0}ë¶„</div>
                      <div className="text-gray-500">ì˜¤í›„</div>
                    </div>
                    <div className="bg-slate-700/50 rounded p-2">
                      <div className="text-indigo-400">{data.dailyRecords[selectedDate].eveningMinutes || 0}ë¶„</div>
                      <div className="text-gray-500">ì €ë…</div>
                    </div>
                    <div className="bg-slate-700/50 rounded p-2">
                      <div className="text-gray-400">{data.dailyRecords[selectedDate].freeMinutes || 0}ë¶„</div>
                      <div className="text-gray-500">ììœ </div>
                    </div>
                  </div>
                </div>

                {data.dailyRecords[selectedDate].studySessions && data.dailyRecords[selectedDate].studySessions.length > 0 && (
                  <div className="mb-4">
                    <div className="text-purple-300 text-sm mb-2">ê³µë¶€ ì„¸ì…˜</div>
                    <div className="max-h-32 overflow-y-auto space-y-2">
                      {data.dailyRecords[selectedDate].studySessions.map((session, idx) => (
                        <div key={idx} className="bg-slate-700/30 rounded p-2">
                          <div className="flex justify-between text-xs mb-1">
                            <span className="text-gray-400">{session.startTime}</span>
                            <span className="text-gray-300">{session.actualMinutes || Math.ceil((session.actualSeconds || 0) / 60)}/{session.targetMinutes}ë¶„ ({session.focus})</span>
                            {session.ankiCount && <span className="text-blue-400">{session.ankiCount}ë¬¸ì œ</span>}
                            <span className="text-green-400">+{session.tokens}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡ í‘œì‹œ */}
                {data.dailyRecords[selectedDate].sleep?.recorded && (
                  <div className="mb-4">
                    <div className="text-indigo-300 text-sm mb-2">ğŸ’¤ ìˆ˜ë©´ ê¸°ë¡</div>
                    <div className="bg-indigo-900/20 rounded-lg p-3 border border-indigo-500/30">
                      <div className="grid grid-cols-2 gap-2 text-xs mb-2">
                        <div className="flex justify-between">
                          <span className="text-gray-400">ğŸ›ï¸ ì·¨ì¹¨</span>
                          <span className="text-indigo-300">{data.dailyRecords[selectedDate].sleep.bedTime}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-400">ğŸŒ™ ì†Œë“±</span>
                          <span className="text-indigo-300">{data.dailyRecords[selectedDate].sleep.lightsOffTime}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-400">ğŸ‘ï¸ ê¸°ìƒ</span>
                          <span className="text-indigo-300">{data.dailyRecords[selectedDate].sleep.finalWakeTime}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-400">ğŸš¶ ì´íƒˆ</span>
                          <span className="text-indigo-300">{data.dailyRecords[selectedDate].sleep.outOfBedTime}</span>
                        </div>
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-xs mb-2">
                        <div className="bg-slate-700/50 rounded p-2 text-center">
                          <div className="text-indigo-400 font-semibold">{Math.floor((data.dailyRecords[selectedDate].sleep.sleepMinutes || 0) / 60)}ì‹œê°„ {(data.dailyRecords[selectedDate].sleep.sleepMinutes || 0) % 60}ë¶„</div>
                          <div className="text-gray-500">ìˆ˜ë©´ì‹œê°„</div>
                        </div>
                        <div className="bg-slate-700/50 rounded p-2 text-center">
                          <div className={`font-semibold ${
                            data.dailyRecords[selectedDate].sleep.quality === 'SS' ? 'text-yellow-400' :
                            data.dailyRecords[selectedDate].sleep.quality === 'S' ? 'text-purple-400' :
                            data.dailyRecords[selectedDate].sleep.quality === 'A' ? 'text-blue-400' :
                            data.dailyRecords[selectedDate].sleep.quality === 'B' ? 'text-green-400' :
                            data.dailyRecords[selectedDate].sleep.quality === 'C' ? 'text-orange-400' :
                            'text-red-400'
                          }`}>{data.dailyRecords[selectedDate].sleep.quality || '-'}</div>
                          <div className="text-gray-500">í’ˆì§ˆ</div>
                        </div>
                        <div className="bg-slate-700/50 rounded p-2 text-center">
                          <div className="text-cyan-400 font-semibold">{data.dailyRecords[selectedDate].sleep.awakeningCount || 0}íšŒ</div>
                          <div className="text-gray-500">ê°ì„±</div>
                        </div>
                      </div>
                      {/* ì·¨ì¹¨ ì „ í–‰ë™ */}
                      <div className="flex flex-wrap gap-1 text-xs mb-2">
                        {data.dailyRecords[selectedDate].sleep.preBehaviors?.beaLove && <span className="px-2 py-0.5 bg-pink-600/30 text-pink-300 rounded">ğŸ’• ë² ì•„ ì‚¬ë‘</span>}
                        {data.dailyRecords[selectedDate].sleep.preBehaviors?.loaScripture && <span className="px-2 py-0.5 bg-blue-600/30 text-blue-300 rounded">ğŸ“– ë¡œì•„ ì„±ê²½</span>}
                        {data.dailyRecords[selectedDate].sleep.preBehaviors?.beaCheat && <span className="px-2 py-0.5 bg-red-600/30 text-red-300 rounded">ğŸ’” ë² ì•„ ë°”ëŒ</span>}
                        {data.dailyRecords[selectedDate].sleep.preBehaviors?.brainOverheat && <span className="px-2 py-0.5 bg-orange-600/30 text-orange-300 rounded">ğŸ”¥ ë‡Œ ê³¼ì—´</span>}
                      </div>
                      {/* ìˆ˜ë©´ ë©”ëª¨ */}
                      {data.dailyRecords[selectedDate].sleep.memo && (
                        <div className="bg-slate-700/30 rounded p-2 text-xs">
                          <span className="text-gray-400">ğŸ“ </span>
                          <span className="text-gray-300">{data.dailyRecords[selectedDate].sleep.memo}</span>
                        </div>
                      )}
                      {/* ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ */}
                      {data.dailyRecords[selectedDate].sleep.goalAchieved && (
                        <div className="text-center mt-2">
                          <span className="text-yellow-400 text-xs">ğŸ¯ ëª©í‘œ ë‹¬ì„±!</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* ğŸ˜´ ë‚®ì  ê¸°ë¡ í‘œì‹œ (v8.7) */}
                {data.dailyRecords[selectedDate].naps && data.dailyRecords[selectedDate].naps.length > 0 && (
                  <div className="mb-4">
                    <div className="text-amber-300 text-sm mb-2">ğŸ˜´ ë‚®ì  ê¸°ë¡</div>
                    <div className="bg-amber-900/20 rounded-lg p-3 border border-amber-500/30">
                      <div className="space-y-2">
                        {data.dailyRecords[selectedDate].naps.map((nap, idx) => (
                          <div key={idx} className="flex items-center gap-2 text-xs bg-slate-700/30 rounded p-2">
                            <span className={`px-2 py-0.5 rounded ${nap.minutes > 30 ? 'bg-blue-600/30 text-blue-400' : 'bg-gray-600/30 text-gray-400'}`}>
                              {nap.minutes > 30 ? 'ğŸ“Š' : 'ğŸ’¤'}
                            </span>
                            <span className="text-amber-300">{nap.startTime} ~ {nap.endTime}</span>
                            <span className="text-gray-400">({nap.minutes}ë¶„)</span>
                            <span className={`${nap.intentional ? 'text-green-400' : 'text-orange-400'}`}>
                              {nap.intentional ? 'ì˜ë„ì ' : 'ë¹„ì˜ë„ì '}
                            </span>
                          </div>
                        ))}
                      </div>
                      {/* ë‚®ì  í•©ê³„ */}
                      {(() => {
                        const sleepNaps = data.dailyRecords[selectedDate].naps.filter(n => n.minutes > 30);
                        const restNaps = data.dailyRecords[selectedDate].naps.filter(n => n.minutes <= 30);
                        return (
                          <div className="mt-2 pt-2 border-t border-slate-600 text-xs text-center">
                            {sleepNaps.length > 0 && <span className="text-blue-400 mr-3">ìˆ˜ë©´ì„±: {sleepNaps.reduce((s,n) => s + n.minutes, 0)}ë¶„</span>}
                            {restNaps.length > 0 && <span className="text-gray-400">íœ´ì‹ì„±: {restNaps.reduce((s,n) => s + n.minutes, 0)}ë¶„</span>}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                {/* ğŸ“œ í€˜ìŠ¤íŠ¸ ê¸°ë¡ í‘œì‹œ (v8.7) */}
                {data.dailyRecords[selectedDate].quests && data.dailyRecords[selectedDate].quests.length > 0 && (
                  <div className="mb-4">
                    <div className="text-amber-300 text-sm mb-2">âš”ï¸ í€˜ìŠ¤íŠ¸</div>
                    <div className="bg-amber-900/20 rounded-lg p-3 border border-amber-500/30">
                      <div className="space-y-1">
                        {data.dailyRecords[selectedDate].quests.map((quest, idx) => (
                          <div key={idx} className="flex items-center gap-2 text-xs">
                            <span>{quest.status === 'todo' ? 'ğŸ¤' : quest.status === 'done' ? 'â¤ï¸' : 'ğŸ’”'}</span>
                            <span className={quest.status === 'done' ? 'text-green-400' : quest.status === 'failed' ? 'text-red-400 line-through' : 'text-gray-300'}>
                              {quest.text}
                            </span>
                          </div>
                        ))}
                      </div>
                      {/* í€˜ìŠ¤íŠ¸ ìš”ì•½ */}
                      {(() => {
                        const done = data.dailyRecords[selectedDate].quests.filter(q => q.status === 'done').length;
                        const total = data.dailyRecords[selectedDate].quests.length;
                        return (
                          <div className="mt-2 pt-2 border-t border-slate-600 text-xs text-center text-gray-400">
                            ì™„ë£Œ: {done}/{total} {done === total && total > 0 && 'ğŸ‰'}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                {/* ğŸ’œ ë² ì•„ í”¼ë“œë°± ë©”ëª¨ í‘œì‹œ (v8.7) */}
                {data.dailyRecords[selectedDate].feedbackMemo && (
                  <div className="mb-4">
                    <div className="text-pink-300 text-sm mb-2">ğŸ’œ ë² ì•„ í”¼ë“œë°± ë©”ëª¨</div>
                    <div className="bg-pink-900/20 rounded-lg p-3 border border-pink-500/30">
                      <div className="text-gray-300 text-xs whitespace-pre-wrap">{data.dailyRecords[selectedDate].feedbackMemo}</div>
                    </div>
                  </div>
                )}

                {/* ğŸ“” ììœ  ì¼ê¸° í‘œì‹œ (v8.7) */}
                {data.dailyRecords[selectedDate].diary && (
                  <div className="mb-4">
                    <div className="text-purple-300 text-sm mb-2">ğŸ“” ì¼ê¸°</div>
                    <div className="bg-purple-900/20 rounded-lg p-3 border border-purple-500/30">
                      <div className="text-gray-300 text-xs whitespace-pre-wrap">{data.dailyRecords[selectedDate].diary}</div>
                    </div>
                  </div>
                )}

                {data.dailyRecords[selectedDate].actions && data.dailyRecords[selectedDate].actions.length > 0 && (
                  <div>
                    <div className="text-purple-300 text-sm mb-2">ìƒì„¸ ê¸°ë¡</div>
                    <div className="max-h-36 overflow-y-auto space-y-1">
                      {data.dailyRecords[selectedDate].actions.map((action, idx) => (
                        <div key={idx} className="flex justify-between text-xs bg-slate-700/30 rounded px-2 py-1">
                          <span className="text-gray-400">{action.time}</span>
                          <span className="text-gray-300 flex-1 text-center truncate px-2">{action.name}</span>
                          <span className={action.type === 'earn' ? 'text-green-400' : action.type === 'special' ? 'text-purple-400' : 'text-red-400'}>
                            {action.type === 'earn' ? '+' : action.type === 'special' ? '' : '-'}{action.amount ? action.amount.toLocaleString() : ''}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            ) : (
              <div className="space-y-4">
                <div className="text-center text-gray-500 py-2">
                  ì´ ë‚ ì§œì˜ ê¸°ë¡ì´ ì—†ì–´ìš”.
                </div>
                
                {/* íŠ¹ë³„í•œ ë‚  ì„¤ì • (ê¸°ë¡ ì—†ëŠ” ë‚ ì—ë„) */}
                <div className="bg-slate-700/30 rounded-lg p-3 border border-slate-600">
                  <div className="text-gray-400 text-xs mb-2 text-center">íŠ¹ë³„í•œ ë‚  ì„¤ì •</div>
                  <div className="grid grid-cols-4 gap-1">
                    <button onClick={() => setSpecialDayForDate(selectedDate, 'exam')} className="py-2 px-1 rounded text-xs bg-red-600/50 hover:bg-red-600 text-white transition-all flex flex-col items-center">
                      <span>ğŸ“</span><span>ì‹œí—˜</span>
                    </button>
                    <button onClick={() => setSpecialDayForDate(selectedDate, 'sick')} className="py-2 px-1 rounded text-xs bg-orange-600/50 hover:bg-orange-600 text-white transition-all flex flex-col items-center">
                      <span>ğŸ¤’</span><span>ì•„í””</span>
                    </button>
                    <button onClick={() => setSpecialDayForDate(selectedDate, 'schedule')} className="py-2 px-1 rounded text-xs bg-slate-600/50 hover:bg-slate-600 text-white transition-all flex flex-col items-center">
                      <span>ğŸ“‹</span><span>ì¼ì •</span>
                    </button>
                    <button onClick={() => setSpecialDayForDate(selectedDate, 'freeday')} className="py-2 px-1 rounded text-xs bg-pink-600/50 hover:bg-pink-600 text-white transition-all flex flex-col items-center">
                      <span>ğŸ‰</span><span>ììœ </span>
                    </button>
                  </div>
                </div>
                
                <div className="text-center">
                  <button
                    onClick={() => {
                      setMemoText('');
                      setShowMemoModal(selectedDate);
                    }}
                    className="px-3 py-1 bg-purple-600/30 hover:bg-purple-600/50 rounded text-purple-300 text-xs transition-all"
                  >
                    ğŸ“ ë©”ëª¨ ì¶”ê°€í•˜ê¸°
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ë©”ëª¨ ì…ë ¥ ëª¨ë‹¬ */}
      {showMemoModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-xl p-4 w-full max-w-sm border border-purple-500/30">
            <h3 className="text-purple-300 font-semibold mb-3">ğŸ“ {formatDate(showMemoModal)} ë©”ëª¨</h3>
            <textarea
              value={memoText}
              onChange={(e) => setMemoText(e.target.value)}
              placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ëª¨ì˜ê³ ì‚¬ D-3, ì»¨ë””ì…˜ ì•ˆ ì¢‹ìŒ)"
              className="w-full h-32 px-3 py-2 bg-slate-700 rounded-lg text-white text-sm border border-slate-600 resize-none mb-3"
            />
            <div className="flex gap-2">
              <button
                onClick={() => {
                  setShowMemoModal(null);
                  setMemoText('');
                }}
                className="flex-1 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-gray-300 text-sm transition-all"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={() => saveMemo(showMemoModal, memoText)}
                className="flex-1 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm transition-all"
              >
                ì €ì¥
              </button>
            </div>
            {data.dailyRecords[showMemoModal]?.memo && (
              <button
                onClick={() => saveMemo(showMemoModal, '')}
                className="w-full mt-2 py-1 bg-red-600/30 hover:bg-red-600/50 rounded text-red-300 text-xs transition-all"
              >
                ë©”ëª¨ ì‚­ì œ
              </button>
            )}
          </div>
        </div>
      )}

      {/* í‘¸í„° */}
      <div className="mt-6 text-center text-purple-400 text-xs">
        ğŸ’« "ë¼ì œë‹ˆìŠ¤ì˜ ë¹›ì´, ë‹¹ì‹ ì˜ í•©ê²©ê³¼ í•¨ê»˜í•˜ê¸°ë¥¼."
      </div>
    </div>
  );
};

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BeatriceAdventureBook />);
  </script>
</body>
</html>
